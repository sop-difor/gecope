<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <title>Painel Financeiro – GECOPE / SOP-CE</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Preload da imagem de fundo para carregar mais rápido -->
    <link rel="preload" as="image"
        href="https://qexdnxqmiaarzwwwrcor.supabase.co/storage/v1/object/public/sop_inicial/unnamed22.jpg">

    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"
        defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js" defer></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" defer></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js" defer></script>


    <style>
        /* Badge AZUL para Status Atualizado */
        .badge-status-atualizado {
            background-color: #0d6efd;
            color: #fff;
            font-size: 0.65rem;
            margin-left: 8px;
            border: 1px solid #0a58ca;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Garante que o modal fique sempre na frente de tudo */
        .modal {
            z-index: 1060 !important;
        }

        .modal-backdrop {
            z-index: 1050 !important;
        }


        /* ... seus outros estilos ... */


        /* Regras de Visibilidade por Perfil */
        .admin-only {
            display: none !important;
        }

        body.is-admin .admin-only,
        body.role-admin .admin-only,
        body.role-gerente .admin-only {
            display: inline-block !important;
        }

        /* Regra para esconder elementos do Fiscal */
        body.role-fiscal .hide-fiscal {
            display: none !important;
        }



        /* Badge Status Em Revisão (Ajuste) */
        .badge-status-revisao {
            background-color: #ffc107;
            /* Amarelo */
            color: #000;
            font-size: 0.65rem;
            margin-left: 8px;
        }

        /* Ajuste para esconder botões em logs de sistema */
        .system-log-entry {
            background-color: #f8f9fa;
            border-left: 5px solid #dee2e6 !important;
        }

        /* --- CSS PARA OS BOTÕES DO ORÇAMENTO (Estilo Imagem 1 e 2) --- */

        .orcamento-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            /* Espaço entre os botões */
        }

        /* Botão Baixar (Verde e Largo) */
        .btn-action-baixar {
            border: 1px solid #198754;
            color: #198754;
            background: #fff;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 6px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-action-baixar:hover {
            background-color: #198754;
            color: #fff;
        }

        /* Botões Quadrados (Ícones) */
        .btn-action-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dee2e6;
            background-color: #fff;
            border-radius: 6px;
            color: #666;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-action-icon:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Cores específicas dos ícones */
        .icon-cloud {
            color: #0d6efd;
        }

        /* Azul */
        .icon-chat {
            color: #6c757d;
        }

        /* Cinza */
        .icon-trash {
            color: #dc3545;
        }

        /* Vermelho */



        /* --- CABEÇALHO HERO (ORÇAMENTOS) --- */

        /* O cartão que envolve Título, Botão e Busca */
        .budget-hero-card {
            background-color: #ffffff;
            border-radius: 16px;
            /* Bem arredondado */
            padding: 24px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            /* Sombra difusa e elegante */
            border: 1px solid rgba(0, 0, 0, 0.02);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        /* Detalhe visual decorativo (Barra verde no topo ou lateral) */
        .budget-hero-card::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: linear-gradient(180deg, var(--sop-green), var(--sop-green-light));
        }

        /* Título Principal */
        .budget-title-large {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            /* Extra bold */
            font-size: 1.35rem;
            color: var(--sop-gray-dark);
            letter-spacing: -0.5px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }

        /* Subtítulo */
        .budget-subtitle-text {
            font-size: 0.85rem;
            color: #888;
            font-weight: 500;
        }

        /* Ajuste na Barra de Pesquisa para caber neste card */
        .search-pill-group-hero {
            width: 100%;
            background-color: #f8f9fa;
            /* Fundo cinza bem claro para contrastar com o card branco */
            border: 1px solid #e9ecef;
            border-radius: 50px;
            display: flex;
            align-items: center;
            padding: 8px 20px;
            transition: all 0.3s ease;
        }

        .search-pill-group-hero:focus-within {
            background-color: #fff;
            border-color: var(--sop-green);
            box-shadow: 0 4px 12px rgba(0, 143, 61, 0.1);
        }

        .search-input-hero {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 0.95rem;
            color: #444;
            outline: none !important;
            margin-left: 10px;
        }

        /* ------------------------------------------------------------------------
       VARIÁVEIS DE CORES & CONFIGURAÇÕES GERAIS
       ------------------------------------------------------------------------ */
        :root {
            --sop-green: #008F3D;
            --sop-green-dark: #007233;
            --sop-green-light: #4CC17C;
            --sop-orange: #F28C00;
            --sop-blue: #018ABD;
            --sop-gray-dark: #333333;
            --sop-gray-mid: #777777;
            --sop-gray-light: #F4F4F4;
            --sop-white: #FFFFFF;
            --border-soft: #E2E6EA;
            --radius-lg: 16px;
            --radius-sm: 10px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Montserrat", system-ui, -apple-system, sans-serif;
            background-color: var(--sop-gray-light);
            color: var(--sop-gray-dark);
        }

        /* ------------------------------------------------------------------------
       NOVO DESIGN: ABA DE ORÇAMENTOS (UPLOAD, SEARCH & LISTA)
       ------------------------------------------------------------------------ */

        /* 1. Barra de Pesquisa "Pílula" (Centralizada e Moderna) */
        .search-container-wrapper {
            background-color: transparent;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            /* Centraliza a barra na tela */
            padding: 0 15px;
        }

        .search-pill-group {
            width: 100%;
            max-width: 700px;
            /* Largura máxima para não ficar gigante em monitores */
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 50px;
            /* Borda totalmente arredondada */
            display: flex;
            align-items: center;
            padding: 5px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            /* Sombra suave */
            transition: all 0.3s ease;
        }

        /* Efeito de foco na barra de pesquisa */
        .search-pill-group:focus-within {
            border-color: var(--sop-green);
            box-shadow: 0 4px 15px rgba(0, 143, 61, 0.15);
            transform: translateY(-1px);
        }

        .search-icon-wrapper {
            color: #999;
            font-size: 1.1rem;
            padding-right: 12px;
            display: flex;
            align-items: center;
        }

        /* Campo de texto limpo (sem bordas padrão) */
        .search-input-clean {
            border: none;
            background: transparent;
            width: 100%;
            height: 40px;
            font-size: 0.95rem;
            color: #333;
            outline: none !important;
        }

        .search-input-clean::placeholder {
            color: #bbb;
            font-weight: 400;
        }

        /* 2. Acordeão (Categorias Principais) */
        .accordion-custom-item {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 12px !important;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .accordion-custom-button {
            background-color: #ffffff;
            padding: 20px 24px;
            font-weight: 600;
            color: var(--sop-gray-dark);
            font-size: 1rem;
            border: none;
            border-radius: 12px !important;
            transition: background-color 0.2s;
            box-shadow: none !important;
            /* Remove sombra padrão do Bootstrap */
        }

        .accordion-custom-button:not(.collapsed) {
            background-color: #f0fdf4;
            /* Verde muito suave ao abrir */
            color: var(--sop-green-dark);
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.05) !important;
        }

        /* Ícone da seta do acordeão customizado */
        .accordion-custom-button::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23333'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            transition: transform 0.2s;
        }

        /* 3. Subcategorias (Hierarquia) */
        .subcategoria-header {
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            margin-top: 24px;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 4px solid var(--sop-orange);
            /* Detalhe laranja */
        }

        /* 4. Linha do Arquivo (Card do Item) */
        .orcamento-item-row {
            background-color: #ffffff;
            border: 1px solid #f1f1f1;
            border-radius: 8px;
            padding: 12px 18px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .orcamento-item-row:hover {
            background-color: #fafafa;
            border-color: #dee2e6;
            transform: translateX(4px);
            /* Leve movimento interativo */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Ícones de Arquivo (Excel/PDF) */
        .file-icon-box {
            width: 42px;
            height: 42px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #198754;
            /* Verde padrão */
            margin-right: 15px;
            flex-shrink: 0;
        }

        /* --- LANDING PAGE (CENTRAL CARD ONLY) --- */
        .landing-overlay {
            position: fixed;
            inset: 0;
            z-index: 2100;
            /* Fundo com imagem e gradiente overlay para melhorar leitura e "profissionalismo" */
            background:
                linear-gradient(135deg, rgba(0, 40, 20, 0.85), rgba(0, 20, 40, 0.75)),
                url('https://qexdnxqmiaarzwwwrcor.supabase.co/storage/v1/object/public/sop_inicial/unnamed22.jpg') no-repeat center center;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
        }

        .landing-card {
            width: 100%;
            max-width: 400px;
            /* Bit narrower for 'lighter' feel */
            background: rgba(255, 255, 255, 0.95);
            /* Semi-transparent for modern look */
            backdrop-filter: blur(10px);
            /* Premium feel */
            border-radius: 16px;
            /* More rounded */
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .landing-card-header {
            background: #2ea55c;
            /* Exact green from image */
            color: #ffffff;
            padding: 24px;
            text-align: center;
            border: none;
        }

        .landing-card-header h2 {
            margin: 0;
            font-weight: 800;
            font-size: 2.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .landing-card-body {
            padding: 40px 35px;
        }

        .landing-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .landing-input-group i {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: #888;
            font-size: 1.2rem;
        }

        .landing-input {
            padding-left: 45px !important;
            border-radius: 8px !important;
            border: 1px solid #ced4da !important;
            height: 54px !important;
            font-size: 1.05rem !important;
        }

        .btn-landing-submit {
            background: #3b6981 !important;
            /* Exact blueish from image */
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
            height: 52px !important;
            border-radius: 8px !important;
            width: 100% !important;
            margin-top: 10px !important;
            border: none !important;
            transition: background 0.2s !important;
        }

        .btn-landing-submit:hover {
            background: #2f5468 !important;
        }

        .icon-xls {

            background-color: #e6f4ea;
            color: #1e7e34;
        }

        /* Verde Excel */
        .icon-pdf {
            background-color: #fce8e6;
            color: #d93025;
        }

        /* Vermelho PDF */
        .icon-generic {
            background-color: #e8f0fe;
            color: #1967d2;
        }

        /* Azul Genérico */

        /* Botão "Novo Orçamento" */
        .btn-novo-orcamento {
            background-color: var(--sop-green);
            border: none;
            padding: 10px 24px;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 50px;
            /* Redondo estilo Pílula */
            box-shadow: 0 4px 6px rgba(0, 143, 61, 0.2);
            transition: transform 0.2s, background-color 0.2s;
        }

        .btn-novo-orcamento:hover {
            background-color: var(--sop-green-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 143, 61, 0.3);
        }

        /* ------------------------------------------------------------------------
       ESTILOS PADRÃO (CABEÇALHO, KPIS, MODAIS) - MANTIDOS
       ------------------------------------------------------------------------ */

        .top-bar {
            background: linear-gradient(90deg, var(--sop-green-dark), var(--sop-green), var(--sop-green-light));
            color: #ffffff;
            padding: 10px 16px;
            font-size: 0.8rem;
            text-align: center;
            letter-spacing: .04em;
        }

        .sop-header {
            background: var(--sop-green);
            color: #ffffff;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
        }

        .sop-logo {
            background-color: #ffffff;
            color: var(--sop-green-dark);
            border-radius: 8px;
            padding: 8px 10px;
            font-weight: 700;
            font-size: 1.0rem;
            text-transform: uppercase;
        }

        .sop-title-main {
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: .04em;
            text-transform: uppercase;
        }

        .sop-title-sub {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .sop-header-right {
            text-align: right;
            font-size: 0.85rem;
        }

        .sop-header-right strong {
            display: block;
            font-size: 0.9rem;
        }

        .panel-subheader {
            background-color: #ffffff;
            border-bottom: 1px solid var(--border-soft);
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* --- ESTILOS DE IMPRESSÃO PARA RELATÓRIOS --- */
        @media print {

            /* Ocultar TUDO exceto o corpo do relatório */
            body>* {
                display: none !important;
            }

            #modalDetalheComposicao {
                display: block !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                visibility: visible !important;
            }

            #modalDetalheComposicao .modal-dialog {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            #modalDetalheComposicao .modal-content {
                border: none !important;
                box-shadow: none !important;
            }

            #modalDetalheComposicao .modal-header,
            #modalDetalheComposicao .modal-footer,
            #modalDetalheComposicao .btn-close {
                display: none !important;
            }

            #modal-report-body {
                display: block !important;
                visibility: visible !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .report-print-area {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }

            /* Forçar cores na impressão */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .print-page-break {
                page-break-before: always !important;
                margin-top: 2cm !important;
            }
        }

        .panel-subheader-title {
            font-size: 1.0rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .page-wrapper {
            padding: 18px 24px 40px 24px;
        }

        /* Filtros e KPIs */
        .filters-card {
            background-color: var(--sop-white);
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 14px 18px;
            margin-bottom: 18px;
            border-left: 4px solid var(--sop-green);
        }

        .filters-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 4px;
            color: var(--sop-gray-mid);
        }

        .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--sop-gray-mid);
            margin-bottom: 2px;
        }

        .form-select,
        .form-control {
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
            border-color: #CED4DA;
            height: calc(1.7rem + 2px) !important;
            padding: 0.25rem 2rem 0.25rem 0.5rem;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: var(--sop-green);
            box-shadow: 0 0 0 0.15rem rgba(0, 143, 61, 0.15);
        }

        .filter-group-compact {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 12px;
            margin-bottom: 8px;
        }

        .filter-group-compact>div {
            display: flex;
            flex-direction: column;
            width: 15.5%;
            min-width: 100px;
            flex-grow: 0;
        }

        .btn-grid-clear {
            height: 27px;
            background-color: var(--sop-green);
            color: #fff;
            border-radius: var(--radius-sm);
            padding: 4px 16px;
            min-width: 100px;
            border: none;
            transition: background-color 0.2s;
        }

        .btn-grid-clear:hover {
            background-color: var(--sop-green-dark);
        }

        .kpi-card {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.06);
            padding: 12px 14px;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            gap: 4px;
            height: 100%;
        }

        .kpi-icon {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--sop-gray-mid);
        }

        .kpi-value {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--sop-gray-dark);
        }

        .kpi-sub {
            font-size: 0.7rem;
            color: var(--sop-gray-mid);
        }

        .kpi-badge {
            font-size: 0.7rem;
            border-radius: 999px;
            padding: 2px 7px;
            background-color: var(--sop-gray-light);
            color: var(--sop-gray-mid);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-trend-up {
            color: var(--sop-green);
        }

        .kpi-trend-down {
            color: var(--sop-orange);
        }

        .kpi-acresc-fiscal {
            border-bottom-color: var(--sop-green-light);
        }

        .kpi-supress-fiscal {
            border-bottom-color: var(--sop-orange);
        }

        .kpi-reperc-fiscal {
            border-bottom-color: var(--sop-blue);
        }

        .kpi-acresc-gecope {
            border-bottom-color: var(--sop-green);
        }

        .kpi-supress-gecope {
            border-bottom-color: #d35400;
        }

        .kpi-reperc-gecope {
            border-bottom-color: #005f8a;
        }

        .kpi-diff-abs {
            border-bottom-color: #8e44ad;
        }

        .kpi-diff-perc {
            border-bottom-color: #c0392b;
        }

        .chart-card {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 12px 14px;
            margin-bottom: 18px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 4px;
            margin-bottom: 6px;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .chart-subtitle {
            font-size: 0.74rem;
            color: var(--sop-gray-mid);
        }

        .chart-placeholder {
            flex: 1;
            min-height: 260px;
        }

        .table {
            font-size: 0.95rem;
        }

        .table td,
        .table th {
            vertical-align: middle;
            padding-top: 8px;
            padding-bottom: 8px;
        }

        /* CORES STATUS PROCESSOS */
        .badge-custom-size {
            min-width: 145px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem !important;
            padding: 0 8px;
            white-space: nowrap;
        }

        .badge-status-devolvido {
            background-color: #F8D7DA;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .badge-status-light-blue {
            background-color: #CFE2FF;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .badge-status-em-reanalise {
            background-color: #D1E7DD;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .badge-status-em-analise {
            background-color: #FFF3CD;
            color: #664d03;
            border: 1px solid #ffecb5;
        }

        .badge-status-aguar-reanalise {
            background-color: #FFC107;
            color: #000000;
            border: 1px solid #e0a800;
        }

        .badge-status-light-green {
            background-color: #D1E7DD;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .badge-status-fiscal {
            background-color: #000000;
            color: #ffffff;
        }

        .badge-status-dark-blue {
            background-color: var(--sop-blue);
            color: #ffffff;
        }

        .badge-status-aprovado {
            background-color: var(--sop-green);
            color: #ffffff;
        }

        .badge-status-contratante {
            background-color: #eaff00;
            color: #000000;
            border: 1px solid #cdd600;
        }

        /* CORES METAS */
        .badge-meta-sem {
            background-color: #FFFFFF;
            color: #666;
            border: 1px solid #999;
        }

        .badge-meta-cumprido {
            background-color: var(--sop-green);
            color: #fff;
        }

        .badge-meta-prazo {
            background-color: #FFC107;
            color: #000;
        }

        .badge-meta-atrasado {
            background-color: #DC3545;
            color: #fff;
        }

        /* Checkbox Prioritário */
        .checkbox-prioritario {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--sop-green);
        }

        .checkbox-prioritario:hover {
            opacity: 0.8;
        }

        .checkbox-prioritario:checked {
            box-shadow: 0 0 4px rgba(13, 110, 253, 0.5);
        }

        /* CSS MULTI-SELECT */
        .multiselect-container {
            position: relative;
            width: 100%;
        }

        .multiselect-btn {
            text-align: left;
            background-color: #fff;
            border: 1px solid #CED4DA;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            height: calc(1.7rem + 2px) !important;
            padding: 0.25rem 2rem 0.25rem 0.5rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
            overflow: hidden;
            color: var(--sop-gray-dark);
            cursor: pointer;
        }

        .multiselect-btn::after {
            content: "";
            position: absolute;
            right: 0.75rem;
            width: 0.5em;
            height: 0.5em;
            border-bottom: 2px solid #333;
            border-right: 2px solid #333;
            transform: rotate(45deg);
            top: 35%;
        }

        .multiselect-dropdown {
            width: 100%;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            font-size: 0.85rem;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }

        .multiselect-option:hover {
            background-color: var(--sop-gray-light);
        }

        .multiselect-option input {
            margin-right: 8px;
        }

        @media (max-width:768px) {
            .sop-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .filter-group-compact>div {
                width: 48%;
                min-width: 100px;
            }
        }

        /* ESTILOS DO HISTÓRICO DE REVISÃO */
        .history-container {
            margin-left: 20px;
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 15px;
            border-left: 2px solid #e0e0e0;
        }

        .history-item {
            font-size: 0.8rem;
            color: #555;
            background-color: #f9f9f9;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            flex-direction: column;
        }

        .history-header {
            font-weight: 700;
            color: var(--sop-green-dark);
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
        }

        .history-msg {
            margin-top: 4px;
        }

        .history-link {
            display: inline-block;
            margin-top: 4px;
            color: var(--sop-blue);
            font-weight: 600;
            text-decoration: none;
            font-size: 0.75rem;
        }

        .history-link:hover {
            text-decoration: underline;
        }



        /* Estilo do botão de cadeado */
        .btn-admin-login {
            background: none;
            border: none;
            color: #ccc;
            transition: color 0.3s;
        }

        .btn-admin-login:hover,
        body.is-admin .btn-admin-login {
            color: var(--sop-green);
        }

        /* ... seus estilos anteriores ... */

        /* --- CONTROLE DE VISIBILIDADE DAS ABAS --- */


        /* --- CSS HISTÓRICO EXPANDIDO (Estilo Imagem 40fc37) --- */

        /* Botão para abrir o histórico (pequeno e discreto) */
        .btn-toggle-history {
            font-size: 0.75rem;
            color: #6c757d;
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 2px 10px;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* --- VISIBILIDADE DAS ABAS (ADMIN) --- */
        /* Por padrão, esconde as abas restritas se não tiver a classe is-admin no body */
        /* --- VISIBILIDADE DAS ABAS (ADMIN) --- */

        /* Garante visibilidade padrão dos itens de menu */
        #dashboardTabs .nav-item {
            display: block;
        }

        /* Esconde as abas restritas se não tiver a classe is-admin no body */
        body:not(.is-admin) .admin-tab {
            display: none !important;
        }

        .btn-toggle-history:hover {
            background-color: #e9ecef;
            color: #333;
        }

        .btn-toggle-history.active {
            background-color: #e9ecef;
            font-weight: 600;
        }

        /* Container que abre embaixo da linha */
        .history-collapse-box {
            background-color: #f8f9fa;
            /* Fundo cinza claro */
            border: 1px solid #f1f1f1;
            border-top: none;
            margin-top: -8px;
            /* Cola na linha de cima */
            margin-bottom: 15px;
            border-radius: 0 0 12px 12px;
            padding: 15px 20px 15px 60px;
            /* Padding esquerdo maior para alinhar com o texto acima */
        }

        /* Card individual de cada mensagem */
        .history-card-item {
            background-color: #ffffff;
            border-left: 4px solid #198754;
            /* Verde SOP */
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            position: relative;
        }

        /* Cabeçalho do card (Nome e Data) */
        .history-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            font-weight: 700;
        }

        /* Texto da mensagem */
        .history-card-msg {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 8px;
        }

        /* Botão do Anexo dentro do card */
        .btn-history-anexo {
            background-color: #198754;
            color: #fff;
            border: none;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-history-anexo:hover {
            background-color: #146c43;
            color: #fff;
        }

        /* --- CSS DE DECISÃO NO HISTÓRICO --- */

        /* Card Padrão (Pendente) */
        .history-card-item {
            background-color: #ffffff;
            border-left: 5px solid #6c757d;
            /* Cinza */
            border-radius: 6px;
            padding: 0;
            /* Padding zerado para controlar via header/body */
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Header do Card (Onde fica o Nome e Data) */
        .history-card-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        /* Corpo do Card */
        .history-card-body {
            padding: 12px 15px;
            font-size: 0.9rem;
            color: #333;
        }

        /* ESTILOS DE STATUS (Modificadores) */

        /* 1. ATENDIDO (Verde) */
        .history-card-item.status-atendido {
            border-left-color: #198754;
        }

        .history-card-item.status-atendido .history-card-header {
            background-color: #d1e7dd;
            /* Fundo verde claro */
            color: #0f5132;
        }

        /* 2. NÃO ACATADO (Vermelho) */
        .history-card-item.status-recusado {
            border-left-color: #dc3545;
        }

        .history-card-item.status-recusado .history-card-header {
            background-color: #f8d7da;
            /* Fundo vermelho claro */
            color: #842029;
        }

        /* Badges de Decisão */
        .badge-decision {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 700;
            margin-left: 10px;
        }

        .badge-atendido {
            background-color: #198754;
            color: white;
        }

        .badge-recusado {
            background-color: #dc3545;
            color: white;
        }

        /* Área de Ação do Admin (Botões) */
        .admin-decision-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
    </style>

</head>

<div class="modal fade" id="modalNovaVersao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-cloud-arrow-up me-2"></i>ATUALIZAR ARQUIVO</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovaVersao">
                    <input type="hidden" id="update-id-orcamento">

                    <div class="mb-3">
                        <label class="form-label small fw-bold">NOVO ARQUIVO (PDF/XLS)</label>
                        <input type="file" class="form-control" id="inputArquivoUpdate" required
                            accept=".xlsx,.xls,.pdf">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">DESCRIÇÃO DAS ALTERAÇÕES</label>
                        <textarea class="form-control" id="inputDescricaoUpdate" rows="3"
                            placeholder="Ex: Corrigido o quantitativo do item 5.2 e atualizado valor unitário do item 8."></textarea>
                        <div class="form-text">Essa informação ficará gravada no histórico da obra.</div>
                    </div>

                    <div class="alert alert-light border small text-muted">
                        <i class="bi bi-info-circle me-1"></i> Isso criará uma nova versão (V2, V3...) e notificará que
                        o arquivo foi atualizado.
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary w-100 fw-bold" onclick="enviarNovaVersao()">
                    <i class="bi bi-send-check me-1"></i> SALVAR NOVA VERSÃO
                </button>
            </div>
        </div>
    </div>
</div>

<body>

    <!-- OVERLAY DE LOGIN (Renderizado diretamente no HTML para aparecer imediatamente) -->
    <div id="landingOverlay" class="landing-overlay">

        <!-- CARTÃO DE LOGIN CENTRAL -->
        <div id="container-login" class="landing-card">
            <div class="landing-card-header">
                <h2>GECOPE</h2>
            </div>
            <div class="landing-card-body">
                <form id="landingLoginForm">
                    <div class="landing-input-group">
                        <i class="bi bi-person"></i>
                        <input id="landing-matricula" type="text" placeholder="Matrícula"
                            class="form-control landing-input" required />
                    </div>
                    <div class="landing-input-group">
                        <i class="bi bi-lock"></i>
                        <input id="landing-password" type="password" placeholder="Senha"
                            class="form-control landing-input" required />
                    </div>
                    <div id="landing-feedback" class="alert alert-danger py-2 px-3 small" style="display: none;"></div>
                    <button class="btn btn-landing-submit" type="submit">Entrar</button>
                    <div class="text-center mt-3 d-flex flex-column gap-2">
                        <a href="#" id="btn-show-register"
                            class="text-decoration-none small text-success fw-bold">Primeiro acesso? Cadastre-se</a>
                        <a href="#" class="text-decoration-none small text-muted">Esqueci minha senha</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- CARTÃO DE REGISTRO -->
        <div id="container-register" class="landing-card" style="display: none;">
            <div class="landing-card-header" style="background: #018ABD;">
                <h2>CADASTRO</h2>
            </div>
            <div class="landing-card-body">
                <form id="landingRegisterForm">
                    <div class="row g-2 mb-3">
                        <div class="col"><input id="reg-nome" type="text" placeholder="Nome" class="form-control"
                                required /></div>
                        <div class="col"><input id="reg-sobrenome" type="text" placeholder="Sobrenome"
                                class="form-control" required /></div>
                    </div>
                    <div class="mb-3"><input id="reg-matricula" type="text" placeholder="Matrícula" class="form-control"
                            required /></div>
                    <div class="mb-3"><input id="reg-senha" type="password" placeholder="Senha" class="form-control"
                            required /></div>
                    <div id="reg-feedback" class="alert alert-danger py-2 px-3 small" style="display: none;"></div>
                    <button class="btn btn-primary w-100 fw-bold py-2" type="submit">Solicitar Cadastro</button>
                    <div class="text-center mt-3">
                        <a href="#" id="btn-show-login" class="text-decoration-none small text-muted fw-bold">Voltar ao
                            Login</a>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <div class="top-bar">PORTAL SOP-CE • GOVERNO DO ESTADO DO CEARÁ • SISTEMA DE ADITIVOS DE OBRAS</div>

    <header class="sop-header">
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="sop-logo"><span>SOP-CE</span></div>
            <div>
                <div class="sop-title-main">SUPERINTENDÊNCIA DE OBRAS PÚBLICAS</div>
                <div class="sop-title-sub">Governo do Estado do Ceará • Secretaria das Cidades</div>
            </div>
        </div>
        <div class="sop-header-right d-flex align-items-center gap-3">
            <div class="text-end d-none d-md-block">
                <strong>GECOPE – Gerência de Controle de Aditivos</strong>
                <span style="font-size: 0.75rem; opacity: 0.9;">Painel Gerencial de Aditivos de Obras</span>
            </div>
            <div id="user-info-header" class="d-flex align-items-center gap-2 border-start ps-3"
                style="display: none !important;">
                <div class="text-end">
                    <div class="fw-bold small lh-1" id="header-user-name">Usuário</div>
                    <div class="text-white-50" style="font-size: 0.7rem; text-transform: uppercase;"
                        id="header-user-role">Perfil</div>
                </div>
                <button class="btn btn-sm btn-outline-light border-0 p-1" onclick="signOutUser()"
                    title="Sair do Sistema">
                    <i class="bi bi-box-arrow-right fs-5"></i>
                </button>
            </div>
        </div>
    </header>

    <section class="panel-subheader">
        <div>
            <div class="panel-subheader-title">
                Painel Gerencial – Aditivos de Obras
            </div>
            <div class="panel-subheader-subtitle">Painel para acompanhamento de aditivo de contratos.</div>
        </div>
        <div class="panel-tag"><span class="panel-tag-dot"></span><span>Dados consolidados – uso interno SOP /
                GECOPE</span></div>
    </section>

    <main class="page-wrapper">

        <div id="load-error" style="display:none; margin-bottom:15px;">
            <div
                style="background:#fff3cd; border:1px solid #ffeeba; border-radius:8px; padding:12px 16px; display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.5rem;">⚠️</span>
                <div style="color:#856404;">
                    <strong>Não foi possível carregar os dados.</strong><br>
                    <span style="font-size:0.9rem;">Verifique sua conexão ou se a URL da planilha CSV está correta e
                        pública.</span>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist"
            style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.06);">
            <li class="nav-item" data-roles="admin,gerente"><button class="nav-link" data-bs-target="#pane-financeiro"
                    data-bs-toggle="tab">Painel Financeiro</button></li>
            <li class="nav-item" data-roles="admin,gerente"><button class="nav-link" data-bs-target="#pane-gerencial"
                    data-bs-toggle="tab">Painel
                    Gerencial</button></li>
            <li class="nav-item" data-roles="admin,gerente"><button class="nav-link" data-bs-target="#pane-prazos"
                    data-bs-toggle="tab">Prazos e
                    Produtividade</button></li>
            <li class="nav-item" data-roles="admin,gerente,fiscal" id="tab-processos"><button class="nav-link"
                    data-bs-target="#pane-reuniao" data-bs-toggle="tab">Processos</button></li>
            <li class="nav-item" data-roles="admin,gerente,fiscal,externo,guest"><button class="nav-link"
                    data-bs-target="#pane-orcamentos" data-bs-toggle="tab"><i class="bi bi-folder2-open me-1"></i>
                    Orçamentos</button></li>
            <li class="nav-item" data-roles="admin,gerente,fiscal,externo,guest"><button class="nav-link"
                    data-bs-target="#pane-composicoes" data-bs-toggle="tab"><i class="bi bi-collection me-1"></i>
                    Composições</button></li>
            <li class="nav-item" data-roles="admin,gerente,fiscal,externo,guest"><button class="nav-link"
                    data-bs-target="#pane-tabelas" data-bs-toggle="tab"><i class="bi bi-calculator me-1"></i>
                    Tabelas</button></li>
            <li class="nav-item" data-roles="admin" style="display:none"><button class="nav-link"
                    data-bs-target="#pane-admin" data-bs-toggle="tab" onclick="loadAllUsers()"><i
                        class="bi bi-shield-lock me-1"></i>
                    Administração</button></li>
        </ul>

        <div class="tab-content">
            <!-- PAINEL ADMINISTRAÇÃO -->
            <div class="tab-pane fade" id="pane-admin">
                <div class="container-fluid py-4">
                    <!-- Dashboard Indicators -->
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="card border-0 shadow-sm p-3 text-center h-100">
                                <div class="text-muted small fw-bold text-uppercase mb-1">Total de Usuários</div>
                                <div class="h3 fw-bold mb-0 text-dark" id="admin-stat-total">0</div>
                                <div class="mt-2"><i class="bi bi-people text-secondary fs-4"></i></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div
                                class="card border-0 shadow-sm p-3 text-center h-100 border-start border-warning border-4">
                                <div class="text-muted small fw-bold text-uppercase mb-1">Pendentes</div>
                                <div class="h3 fw-bold mb-0 text-warning" id="admin-stat-pending">0</div>
                                <div class="mt-2"><i class="bi bi-person-plus text-warning fs-4"></i></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div
                                class="card border-0 shadow-sm p-3 text-center h-100 border-start border-danger border-4">
                                <div class="text-muted small fw-bold text-uppercase mb-1">Administradores</div>
                                <div class="h3 fw-bold mb-0 text-danger" id="admin-stat-admins">0</div>
                                <div class="mt-2"><i class="bi bi-shield-check text-danger fs-4"></i></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div
                                class="card border-0 shadow-sm p-3 text-center h-100 border-start border-success border-4">
                                <div class="text-muted small fw-bold text-uppercase mb-1">Analistas / Fiscais</div>
                                <div class="h3 fw-bold mb-0 text-success" id="admin-stat-others">0</div>
                                <div class="mt-2"><i class="bi bi-person-badge text-success fs-4"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Requests (Visible only if there's any) -->
                    <div id="admin-pending-section" style="display: none;">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <h5 class="fw-bold text-warning mb-0"><i
                                    class="bi bi-exclamation-circle-fill me-2"></i>Solicitações de Acesso Pendentes</h5>
                            <span class="badge bg-warning text-dark rounded-pill" id="admin-pending-badge-tab">0</span>
                        </div>
                        <div class="card border-0 shadow-sm mb-4 overflow-hidden" style="border-radius: 12px;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-warning bg-opacity-10">
                                        <tr>
                                            <th class="ps-4">Solicitante</th>
                                            <th>Matrícula</th>
                                            <th>Data Solicitação</th>
                                            <th class="text-end pe-4">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-pending-table-body">
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-muted small">Carregando
                                                solicitações...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: 12px;">
                        <div class="card-header bg-white py-3 border-0">
                            <div class="row align-items-center g-3">
                                <div class="col-md-6 text-center text-md-start">
                                    <h5 class="fw-bold text-dark mb-0"><i class="bi bi-people-fill me-2"></i>Gestão de
                                        Usuários Ativos</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2 justify-content-md-end">
                                        <div class="input-group input-group-sm" style="max-width: 300px;">
                                            <span class="input-group-text bg-light border-end-0"><i
                                                    class="bi bi-search text-muted"></i></span>
                                            <input type="text" id="admin-user-search"
                                                class="form-control border-start-0 bg-light"
                                                placeholder="Buscar por nome ou matrícula..."
                                                onkeyup="filterAdminUsers()">
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="loadAllUsers()"
                                            title="Atualizar Lista">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 60vh;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light sticky-top">
                                    <tr>
                                        <th class="ps-4">Nome / Usuário</th>
                                        <th>E-mail</th>
                                        <th>Matrícula</th>
                                        <th>Função / Perfil</th>
                                        <th class="text-end pe-4">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-users-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted small">Carregando usuários...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pane-financeiro">
                <section class="filters-card">
                    <div class="filters-title">Filtros de consulta</div>
                    <div class="filter-group-compact">
                        <div><label class="form-label">Status</label><select class="form-select form-select-sm"
                                id="filter-status"></select></div>
                        <div><label class="form-label">Tipo</label><select class="form-select form-select-sm"
                                id="filter-tipo"></select></div>
                        <div><label class="form-label">Fiscal</label><select class="form-select form-select-sm"
                                id="filter-fiscal"></select></div>
                        <div><label class="form-label">Contratada</label><select class="form-select form-select-sm"
                                id="filter-contratada"></select></div>
                        <div><label class="form-label">Contratante</label><select class="form-select form-select-sm"
                                id="filter-contratante"></select></div>
                        <div><label class="form-label">Ano</label><select class="form-select form-select-sm"
                                id="filter-ano"></select></div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-grid-clear" id="btn-clear-filters">Limpar</button>
                    </div>
                </section>

                <section class="mb-3">
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <div class="kpi-card kpi-acresc-fiscal">
                                <div class="kpi-header">
                                    <div class="kpi-icon"
                                        style="background:rgba(0,143,61,0.16);color:var(--sop-green-dark);">↑</div>
                                    <div class="kpi-label">Acréscimo – Fiscalização</div>
                                </div>
                                <div class="kpi-value" id="kpi-acresc-fiscal">R$ 0,00</div>
                                <div class="d-flex justify-content-between">
                                    <div class="kpi-sub">Soma Total</div><span class="kpi-badge"><span
                                            class="kpi-trend-up">●</span> Fiscal</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="kpi-card kpi-supress-fiscal">
                                <div class="kpi-header">
                                    <div class="kpi-icon"
                                        style="background:rgba(242,140,0,0.18);color:var(--sop-orange);">↓</div>
                                    <div class="kpi-label">Supressão – Fiscalização</div>
                                </div>
                                <div class="kpi-value" id="kpi-supress-fiscal">R$ 0,00</div>
                                <div class="d-flex justify-content-between">
                                    <div class="kpi-sub">Soma Total</div><span class="kpi-badge"><span
                                            class="kpi-trend-down">●</span> Fiscal</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="kpi-card kpi-reperc-fiscal">
                                <div class="kpi-header">
                                    <div class="kpi-icon"
                                        style="background:rgba(1,138,189,0.14);color:var(--sop-blue);">R$</div>
                                    <div class="kpi-label">Repercussão – Fiscalização</div>
                                </div>
                                <div class="kpi-value" id="kpi-reperc-fiscal">R$ 0,00</div>
                                <div class="d-flex justify-content-between">
                                    <div class="kpi-sub">Soma Total</div><span class="kpi-badge">Base</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="kpi-card kpi-acresc-gecope">
                                <div class="kpi-header">
                                    <div class="kpi-icon"
                                        style="background:rgba(0,114,51,0.2);color:var(--sop-green-dark);">↑</div>
                                    <div class="kpi-label">Acréscimo – GECOPE</div>
                                </div>
                                <div class="kpi-value" id="kpi-acresc-gecope">R$ 0,00</div>
                                <div class="d-flex justify-content-between">
                                    <div class="kpi-sub">Soma Total</div><span class="kpi-badge"><span
                                            class="kpi-trend-up">●</span> Revisão</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="kpi-card kpi-supress-gecope">
                                <div class="kpi-header">
                                    <div class="kpi-icon" style="background:rgba(211,84,0,0.2);color:#d35400;">↓</div>
                                    <div class="kpi-label">Supressão – GECOPE</div>
                                </div>
                                <div class="kpi-value" id="kpi-supress-gecope">R$ 0,00</div>
                                <div class="d-flex justify-content-between">
                                    <div class="kpi-sub">Soma Total</div><span class="kpi-badge"><span
                                            class="kpi-trend-down">●</span> Revisão</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="kpi-card kpi-reperc-gecope">
                                <div class="kpi-header">
                                    <div class="kpi-icon" style="background:rgba(0,95,138,0.18);color:#005f8a;">R$</div>
                                    <div class="kpi-label">Repercussão – GECOPE</div>
                                </div>
                                <div class="kpi-value" id="kpi-reperc-gecope">R$ 0,00</div>
                                <div class="d-flex justify-content-between">
                                    <div class="kpi-sub">Soma Total</div><span class="kpi-badge">Final</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="kpi-card kpi-diff-abs">
                                <div class="kpi-header">
                                    <div class="kpi-icon" style="background:rgba(142,68,173,0.18);color:#8e44ad;">Δ
                                    </div>
                                    <div class="kpi-label">Diferença Total</div>
                                </div>
                                <div class="kpi-value" id="kpi-diff-abs">R$ 0,00</div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="kpi-sub">GECOPE - Fiscalização</div><select
                                        class="form-select form-select-sm" id="metric-diff"
                                        style="width:auto;height:25px;">
                                        <option value="reperc">Repercussão</option>
                                        <option value="acresc">Acréscimo</option>
                                        <option value="supress">Supressão</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="kpi-card kpi-diff-perc">
                                <div class="kpi-header">
                                    <div class="kpi-icon" style="background:rgba(192,57,43,0.18);color:#c0392b;">%</div>
                                    <div class="kpi-label">Índice Médio de Revisão</div>
                                </div>
                                <div class="kpi-value" id="kpi-diff-perc">0,0%</div>
                                <div class="kpi-sub">Impacto da revisão GECOPE</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-3">
                    <div class="d-flex justify-content-end align-items-center mb-2 gap-2">
                        <div class="chart-tools"><span>Período:</span><select class="form-select form-select-sm"
                                id="tot-ano" style="width:125px;">
                                <option value="">Ano: Todos</option>
                            </select><select class="form-select form-select-sm" id="tot-mes" style="width:135px;">
                                <option value="">Mês: Todos</option>
                                <option value="1">Jan</option>
                                <option value="2">Fev</option>
                                <option value="3">Mar</option>
                                <option value="4">Abr</option>
                                <option value="5">Mai</option>
                                <option value="6">Jun</option>
                                <option value="7">Jul</option>
                                <option value="8">Ago</option>
                                <option value="9">Set</option>
                                <option value="10">Out</option>
                                <option value="11">Nov</option>
                                <option value="12">Dez</option>
                            </select></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-lg-4">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <div class="chart-title">Acréscimo</div>
                                </div>
                                <div class="chart-placeholder" id="chart-acresc-total"></div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <div class="chart-title">Supressão</div>
                                </div>
                                <div class="chart-placeholder" id="chart-supress-total"></div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <div class="chart-title">Repercussão</div>
                                </div>
                                <div class="chart-placeholder" id="chart-reperc-total"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="pane-gerencial">
                <section class="filters-card">
                    <div class="filters-title">Filtros Gerenciais</div>
                    <div class="row g-2">
                        <div class="col-12 col-md-4"><label class="form-label">Fiscal</label><select
                                class="form-select form-select-sm" id="gerencial-filter-fiscal"></select></div>
                        <div class="col-12 col-md-4"><label class="form-label">Status</label><select
                                class="form-select form-select-sm" id="gerencial-filter-status"></select></div>
                        <div class="col-12 col-md-4 d-flex align-items-end"><button
                                class="btn btn-sm w-30 btn-grid-clear" id="btn-gerencial-clear">Limpar</button></div>
                    </div>
                </section>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Processos por Fiscal</div>
                        </div><span class="chart-tools-badge" id="gerencial-count-badge">0</span>
                    </div>
                    <div class="chart-placeholder" id="chart_proc_por_fiscal"></div>
                </div>
                <div class="row g-3">
                    <div class="col-12 col-lg-6">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Por STATUS</div>
                            </div>
                            <div class="chart-placeholder" id="chart_proc_por_status"></div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Por TIPO</div>
                            </div>
                            <div class="chart-placeholder" id="chart_proc_por_tipo"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pane-prazos">
                <section class="filters-card">
                    <div class="filters-title">Filtros Prazos</div>
                    <div class="row g-2">
                        <div class="col-12 col-md-4"><label class="form-label">Fiscal</label><select
                                class="form-select form-select-sm" id="prazos-filter-fiscal"></select></div>
                        <div class="col-12 col-md-4"><label class="form-label">Status</label><select
                                class="form-select form-select-sm" id="prazos-filter-status"></select></div>
                        <div class="col-12 col-md-4 d-flex align-items-end"><button
                                class="btn btn-sm w-30 btn-grid-clear" id="btn-prazos-clear">Limpar</button></div>
                    </div>
                </section>

                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-3">
                        <div class="kpi-card kpi-acresc-gecope">
                            <div class="kpi-header">
                                <div class="kpi-icon"
                                    style="background:rgba(0,114,51,0.12);color:var(--sop-green-dark);">✅</div>
                                <div class="kpi-label">Aprovados</div>
                            </div>
                            <div class="kpi-value" id="kpi-aprovados_qtd">0</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="kpi-card kpi-reperc-gecope">
                            <div class="kpi-header">
                                <div class="kpi-icon" style="background:rgba(0,95,138,0.12);color:#005f8a;">⏱️</div>
                                <div class="kpi-label">Média (dias)</div>
                            </div>
                            <div class="kpi-value" id="kpi-tempo_medio">–</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="kpi-card kpi-supress-fiscal">
                            <div class="kpi-header">
                                <div class="kpi-icon" style="background:rgba(242,140,0,0.12);color:var(--sop-orange);">
                                    📌</div>
                                <div class="kpi-label">Mediana</div>
                            </div>
                            <div class="kpi-value" id="kpi-tempo_mediana">–</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="kpi-card kpi-diff-abs">
                            <div class="kpi-header">
                                <div class="kpi-icon" style="background:rgba(142,68,173,0.12);color:#8e44ad;">🎯</div>
                                <div class="kpi-label">P90</div>
                            </div>
                            <div class="kpi-value" id="kpi-tempo_p90">–</div>
                        </div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-12 col-lg-6">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Tempo Médio por Fiscal</div>
                            </div>
                            <div class="chart-placeholder" id="chart_tempo_por_fiscal"></div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Tempo Médio por Tipo</div>
                            </div>
                            <div class="chart-placeholder" id="chart_tempo_por_tipo"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pane-reuniao">
                <div class="chart-card"
                    style="min-height: 600px; display: flex; flex-direction: column; overflow: visible !important;">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="fw-bold mb-0" style="color: var(--sop-gray-dark);">Painel de Processos</h5>

                            </div>
                            <small class="text-muted">Gerencie a pauta, visualize prazos e edite informações.</small>
                        </div>
                        <button type="button" class="btn btn-success fw-bold shadow-sm admin-only"
                            style="background-color: var(--sop-green); border: none; font-size: 0.85rem;"
                            data-bs-toggle="modal" data-bs-target="#modalCadastro">
                            <i class="bi bi-plus-lg me-1"></i> Novo Processo
                        </button>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100"
                                style="border-bottom: 4px solid var(--sop-green-light) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-pin-angle-fill me-2 text-muted"></i>
                                        <span class="small text-muted fw-bold text-uppercase">Processos (No
                                            Recorte)</span>
                                    </div>
                                    <h2 class="fw-bold mb-0" id="card_proc_total">0</h2>
                                    <small class="text-muted" style="font-size: 0.75rem;">Filtrado na tela</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100"
                                style="border-bottom: 4px solid var(--sop-orange) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-hourglass-split me-2 text-muted"></i>
                                        <span class="small text-muted fw-bold text-uppercase">Não Aprovados</span>
                                    </div>
                                    <h2 class="fw-bold mb-0" id="card_proc_andamento">0</h2>
                                    <small class="text-muted" style="font-size: 0.75rem;">Em andamento</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100"
                                style="border-bottom: 4px solid var(--sop-green) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-check-square-fill me-2 text-muted"></i>
                                        <span class="small text-muted fw-bold text-uppercase">Aprovados</span>
                                    </div>
                                    <h2 class="fw-bold mb-0" id="card_proc_aprovados">0</h2>
                                    <small class="text-muted" style="font-size: 0.75rem;">Status = Aprovado</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100"
                                style="border-bottom: 4px solid #6f42c1 !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-calendar-event me-2 text-muted"></i>
                                        <span class="small text-muted fw-bold text-uppercase">Mais Antigo (Dias)</span>
                                    </div>
                                    <h2 class="fw-bold mb-0" id="card_proc_dias">0</h2>
                                    <small class="text-muted" style="font-size: 0.75rem;">Pelo campo DIAS</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded border shadow-sm mb-3">
                        <div class="row g-2 align-items-end">
                            <div class="col-12 col-md-2">
                                <label class="form-label small text-muted fw-bold text-uppercase mb-1">Metas</label>
                                <select class="form-select form-select-sm border-secondary-subtle"
                                    id="meetingMetaSelect">
                                    <option value="">Todos</option>
                                    <option value="Cumprido">Cumprido</option>
                                    <option value="No prazo">No prazo</option>
                                    <option value="Atrasado">Atrasado</option>
                                    <option value="Sem meta">Sem meta</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-2">
                                <label
                                    class="form-label small text-muted fw-bold text-uppercase mb-1">Prioritário</label>
                                <select class="form-select form-select-sm border-secondary-subtle"
                                    id="meetingPrioritarioSelect">
                                    <option value="">Todos</option>
                                    <option value="Sim">Prioritário</option>
                                    <option value="Não">Não Prioritário</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-2">
                                <label class="form-label small text-muted fw-bold text-uppercase mb-1">Fiscal</label>
                                <select class="form-select form-select-sm border-secondary-subtle fw-bold text-primary"
                                    id="meetingFiscalSelect"></select>
                            </div>
                            <div class="col-12 col-md-2">
                                <label class="form-label small text-muted fw-bold text-uppercase mb-1">Status</label>
                                <select class="form-select form-select-sm border-secondary-subtle"
                                    id="meetingStatusSelect"></select>
                            </div>
                            <div class="col">
                                <label class="form-label small text-muted fw-bold text-uppercase mb-1">Buscar</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control border-secondary-subtle" id="meetingSearch"
                                        placeholder="Processo, Descrição, Analista...">
                                    <span class="input-group-text bg-light text-muted border-secondary-subtle"><i
                                            class="bi bi-search"></i></span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <label class="form-label small text-muted fw-bold text-uppercase mb-1"
                                    style="visibility:hidden;">.</label>
                                <button class="btn btn-sm btn-grid-clear w-100" id="btn-reuniao-clear"
                                    style="height: 30px; line-height: 1;">
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1 border rounded bg-white"
                        style="box-shadow: inset 0 -1px 0 rgba(0,0,0,0.1);">
                        <table class="table table-hover table-striped align-middle mb-0" style="font-size: 0.9rem;">
                            <thead class="table-light"
                                style="position: sticky; top: 0; z-index: 1020; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 1px solid #dee2e6;">
                            </thead>

                            <tbody id="meetingTableBody" class="border-top-0"></tbody>
                        </table>
                    </div>

                    <div class="footer-note mt-2 d-flex justify-content-between align-items-center">
                        <span id="meetingFooterNote" class="badge bg-light text-dark border fw-normal">Carregando
                            dados...</span>
                        <small class="text-muted fst-italic">* Utilize os filtros acima para refinar a busca.</small>
                    </div>

                </div>

            </div>

            <div class="tab-pane fade" id="pane-orcamentos">
                <div class="page-wrapper pt-0">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="fw-bold mb-0 text-uppercase"
                                    style="color: var(--sop-gray-dark); font-size: 1.0rem;">Painel de Orçamentos</h5>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-success fw-bold shadow-sm admin-only" data-bs-toggle="modal"
                            data-bs-target="#modalNovoOrcamento">
                            <i class="bi bi-plus-lg me-1"></i> NOVO ORÇAMENTO
                        </button>
                    </div>

                    <section class="filters-card">
                        <div class="filters-title">FILTROS DE CONSULTA (ORÇAMENTOS)</div>
                        <div class="row g-2">
                            <div class="col">
                                <div class="input-group input-group-sm">
                                    <input type="text" id="orcamento-search" class="form-control"
                                        placeholder="Digite o nome da obra, categoria ou tipo de arquivo...">
                                    <span class="input-group-text bg-white text-muted"><i
                                            class="bi bi-search"></i></span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button id="btn-orc-clear" class="btn btn-sm btn-grid-clear px-3"
                                    style="height: 31px; line-height: 1;">
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </section>

                    <div class="accordion accordion-flush mt-3" id="accordionOrcamentos">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border text-success mb-3" role="status"
                                style="width: 3rem; height: 3rem;"></div>
                            <div class="fw-bold text-secondary">Carregando biblioteca...</div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="tab-pane fade" id="pane-composicoes">
                <div class="page-wrapper pt-0">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="fw-bold mb-0 text-uppercase"
                                    style="color: var(--sop-gray-dark); font-size: 1.0rem;">Banco de Composições</h5>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-success fw-bold shadow-sm admin-only" data-bs-toggle="modal"
                            data-bs-target="#modalCadastrarComposicao">
                            <i class="bi bi-cloud-plus me-1"></i> UPLOAD COMPOSIÇÃO
                        </button>
                        <!-- NOVO BOTÃO: CRIAR COMPOSIÇÃO ANALÍTICA -->
                        <button id="btn-nova-comp-analitica" class="btn btn-sm btn-primary fw-bold shadow-sm ms-2"
                            style="display: none;" onclick="abrirCriadorComposicao()">
                            <i class="bi bi-calculator me-1"></i> NOVA COMPOSIÇÃO ANALÍTICA
                        </button>
                    </div>

                    <section class="filters-card">
                        <div class="filters-title">FILTROS DE CONSULTA (COMPOSIÇÕES)</div>
                        <div class="row g-2">
                            <div class="col">
                                <div class="input-group input-group-sm">
                                    <input type="text" id="comp-search" class="form-control"
                                        placeholder="Digite o nome da composição, categoria ou tipo de arquivo...">
                                    <span class="input-group-text bg-white text-muted"><i
                                            class="bi bi-search"></i></span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button id="btn-comp-clear" class="btn btn-sm btn-grid-clear px-3"
                                    style="height: 31px; line-height: 1;">
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </section>

                    <div class="accordion accordion-flush mt-3" id="accordionComposicoes">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border text-success mb-3" role="status"
                                style="width: 3rem; height: 3rem;"></div>
                            <div class="fw-bold text-secondary">Carregando composições...</div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="tab-pane fade" id="pane-tabelas">
                <div class="page-wrapper pt-0">

                    <div class="mb-4 text-center">
                        <h4 class="fw-bold" style="color: var(--sop-green-dark);">PESQUISA DE PREÇOS DE REFERÊNCIA</h4>
                        <p class="text-muted small">Consulte bases oficiais (SEINFRA, SINAPI, ORSE) atualizadas.</p>
                    </div>

                    <div class="budget-hero-card mx-auto" style="max-width: 2000px;">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <label class="form-label small fw-bold text-success">FONTE</label>
                                <select class="form-select form-select-sm fw-bold" id="busca-fonte"
                                    onchange="atualizarSelectVersao()">
                                    <option value="SEINFRA">SEINFRA (CE)</option>
                                    <option value="SINAPI">SINAPI (BR)</option>
                                    <option value="ORSE">ORSE (SE)</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label small fw-bold text-success">VERSÃO</label>
                                <select class="form-select form-select-sm" id="busca-versao">
                                    <option value="027.1">Tabela 027.1</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label small fw-bold text-success">REFERÊNCIA</label>
                                <select class="form-select form-select-sm" id="busca-ref">
                                    <option value="desonerada" selected>Desonerada</option>
                                    <option value="onerada">Onerada</option>
                                </select>
                            </div>

                            <!-- NOVOS CAMPOS BDI / DESCONTO -->
                            <div class="col-md-2">
                                <div class="row g-1">
                                    <div class="col-6">
                                        <label class="form-label small fw-bold text-muted"
                                            style="font-size: 0.65rem;">DESC. (%)</label>
                                        <input type="number" class="form-control form-control-sm text-end"
                                            id="busca-desc" placeholder="0,00" step="0.01" min="0" max="100">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small fw-bold text-muted"
                                            style="font-size: 0.65rem;">BDI (%)</label>
                                        <input type="number" class="form-control form-control-sm text-end"
                                            id="busca-bdi" placeholder="0,00" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-success">CÓDIGO OU DESCRIÇÃO</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="busca-input-termo"
                                        placeholder="Composição, Insumo, Descrição..."
                                        onkeyup="if(event.key === 'Enter') executarBuscaTabela()">
                                    <button class="btn btn-success text-white" type="button"
                                        onclick="executarBuscaTabela()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-1">
                                <label class="form-label small text-muted fw-bold text-uppercase mb-1"
                                    style="visibility:hidden;">.</label>
                                <button class="btn btn-sm btn-grid-clear w-100" type="button"
                                    onclick="limparBuscaTabela()" title="Limpar filtros e resultados"
                                    style="height: 30px; line-height: 1;">
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="area-resultados-tabela" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
                            <h6 class="fw-bold text-secondary mb-0">RESULTADOS ENCONTRADOS</h6>
                            <span class="badge bg-light text-dark border" id="contador-resultados">0 itens</span>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <table class="table table-striped table-hover align-middle mb-0" style="font-size: 0.9rem;">
                                <thead class="bg-success text-white">
                                    <tr>
                                        <th width="5%" class="text-center ps-3">Ref.</th>
                                        <th width="10%" class="text-center">Código</th>
                                        <th width="55%">Descrição Resumida</th>
                                        <th width="10%" class="text-center">Unid.</th>
                                        <th width="15%" class="text-end pe-3">Preço Unit.</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-precos-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
    </main>

    <div class="modal fade" id="modalNovoOrcamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-cloud-plus me-2"></i>CADASTRAR ORÇAMENTO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoOrcamento">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">1. CATEGORIA (PRINCIPAL) *</label>
                            <input type="text" class="form-control" name="CATEGORIA" list="listaCategorias" required
                                placeholder="Ex: ESCOLAS">
                            <datalist id="listaCategorias">
                                <option value="ESCOLAS">
                                <option value="SISTEMAS PENITENCIÁRIOS">
                                <option value="ESTRADAS">
                                <option value="ARENINHAS">
                            </datalist>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">2. SUBCATEGORIA *</label>
                            <input type="text" class="form-control" name="SUBCATEGORIA" list="listaSubcategorias"
                                required placeholder="Ex: ESCOLAS DE ENSINO MÉDIO">
                            <datalist id="listaSubcategorias">
                                <option value="ESCOLAS DE ENSINO MÉDIO">
                                <option value="ESCOLAS PROFISSIONALIZANTES">
                                <option value="QUADRAS POLIESPORTIVAS">
                            </datalist>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">3. NOME DA OBRA / ITEM *</label>
                            <input type="text" class="form-control" name="OBRA" required
                                placeholder="Ex: E.E.M. - 8 SALAS">
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">ARQUIVO DO ORÇAMENTO *</label>
                            <input type="file" class="form-control" id="inputArquivoUpload" required
                                accept=".xlsx,.xls,.pdf">
                            <div class="form-text">O sistema fará o upload e gerará o link automaticamente.</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label small fw-bold">DATA</label>
                                <input type="date" class="form-control" name="DATA" id="input-data-hoje" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label small fw-bold">STATUS</label>
                                <select class="form-select" name="STATUS">
                                    <option value="Disponível" selected>Disponível</option>
                                    <option value="Em Revisão">Em Revisão</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="salvarNovoOrcamento()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalComentarioOrcamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning-subtle">
                    <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-chat-left-text me-2"></i>SOLICITAR REVISÃO /
                        COMENTAR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formComentarioOrcamento">
                        <input type="hidden" id="coment-id-orcamento" name="ID">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">ORÇAMENTO</label>
                            <input type="text" class="form-control form-control-sm bg-light" id="coment-nome-obra"
                                readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">SEU NOME (FISCAL)</label>
                            <select class="form-select form-select-sm" id="coment-fiscal" required>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">MENSAGEM / SOLICITAÇÃO</label>
                            <textarea class="form-control" name="MENSAGEM" rows="4" required
                                placeholder="Descreva o motivo da revisão ou seu comentário..."></textarea>
                        </div>
                        <div class="mb-3">

                            <label class="form-label small fw-bold text-success"><i class="bi bi-paperclip"></i> ANEXAR
                                MEMÓRIA/ARQUIVO (Opcional)</label>
                            <input type="file" class="form-control form-control-sm" id="inputArquivoComentario"
                                accept=".xlsx,.xls,.pdf,.doc,.docx">
                        </div>
                    </form>

                    <div class="mt-3 pt-3 border-top">
                        <label class="small text-muted fw-bold mb-2">HISTÓRICO</label>
                        <div id="historico-comentarios" class="bg-light p-2 rounded"
                            style="max-height: 150px; overflow-y: auto; font-size: 0.8rem;">
                            <em class="text-muted">Nenhum comentário ainda.</em>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="enviarComentarioOrcamento()">Enviar
                        Solicitação</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCadastro" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--sop-green); color: white;">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-plus me-2"></i>NOVO CADASTRO</h5><button
                        type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formCadastro">
                        <input type="hidden" name="action" value="create">
                        <div class="row g-3">
                            <div class="col-12">
                                <div
                                    style="border-bottom: 2px solid var(--sop-gray-light); margin-bottom: 1rem; color: var(--sop-green); font-weight: 700;">
                                    DADOS DO PROCESSO</div>
                            </div>
                            <div class="col-md-4"><label class="form-label">PROCESSO N.º *</label><input type="text"
                                    class="form-control" name="PROCESSO N." id="cad-processo"
                                    placeholder="00000.000000/0000-00" required></div>
                            <div class="col-md-4"><label class="form-label">TIPO</label><input type="text"
                                    class="form-control" name="TIPO"></div>
                            <div class="col-md-4">
                                <label class="form-label">STATUS</label>
                                <select class="form-select" name="STATUS">
                                    <option value="AGUAR. ANÁLISE">AGUAR. ANÁLISE</option>
                                    <option value="AGUAR. APROVAÇÃO">AGUAR. APROVAÇÃO</option>
                                    <option value="AGUAR. REANÁLISE">AGUAR. REANÁLISE</option>
                                    <option value="ANÁLISE FISCAL">ANÁLISE FISCAL</option>
                                    <option value="APROVADO">APROVADO</option>
                                    <option value="ARQUIVADO">ARQUIVADO</option>
                                    <option value="CONTRATANTE">CONTRATANTE</option>
                                    <option value="DEVOLVIDO P/ REANÁLISE FISCAL">DEVOLVIDO P/ REANÁLISE FISCAL</option>
                                    <option value="EM ANÁLISE">EM ANÁLISE</option>
                                    <option value="EM REANÁLISE">EM REANÁLISE</option>
                                </select>
                            </div>
                            <div class="col-12"><label class="form-label">DESCRIÇÃO</label><textarea
                                    class="form-control" name="DESCRIÇÃO" rows="2"></textarea></div>

                            <div class="col-12">
                                <div
                                    style="border-bottom: 2px solid var(--sop-gray-light); margin: 1rem 0; color: var(--sop-green); font-weight: 700;">
                                    AGENTES E PRAZOS</div>
                            </div>
                            <div class="col-md-4"><label class="form-label">CONTRATANTE</label><input type="text"
                                    class="form-control" name="CONTRATANTE"></div>
                            <div class="col-md-4"><label class="form-label">CONTRATADA</label><input type="text"
                                    class="form-control" name="CONTRATADA"></div>
                            <div class="col-md-4"><label class="form-label">FISCAL *</label><select class="form-select"
                                    id="cad-fiscal" name="FISCAL" required>
                                    <option value="">Selecione...</option>
                                </select></div>

                            <div class="col-md-4"><label class="form-label">ABERTURA</label><input type="text"
                                    class="form-control mask-date" name="DATA DE ABERTURA" placeholder="dd/mm/aaaa"
                                    maxlength="10"></div>
                            <div class="col-md-4"><label class="form-label">DATA RECEBIMENTO (Col E)</label><input
                                    type="text" class="form-control mask-date" name="DATA RECEBIMENTO"
                                    placeholder="dd/mm/aaaa" maxlength="10"></div>

                            <div class="col-md-4">
                                <label class="form-label">ANALISTA (Col H)</label>
                                <select class="form-select" name="ANALISTA">
                                    <option value="">Selecione...</option>
                                    <option value="N">Nildeno</option>
                                    <option value="W">Walace</option>
                                </select>
                            </div>
                            <div class="col-md-4"><label class="form-label">META</label><input type="text"
                                    class="form-control mask-date" name="DATA COMPROMISSO FISCAL"
                                    placeholder="dd/mm/aaaa" maxlength="10"></div>

                            <div class="col-12">
                                <div
                                    style="border-bottom: 2px solid var(--sop-gray-light); margin: 1rem 0; color: var(--sop-green); font-weight: 700;">
                                    VALORES (F)</div>
                            </div>
                            <div class="col-md-4"><label class="form-label">ACRÉSCIMO</label><input type="text"
                                    class="form-control mask-money calc-fiscal" id="acresc_fisc"
                                    name="ACRÉSCIMO FISCALIZAÇÃO"></div>
                            <div class="col-md-4"><label class="form-label">SUPRESSÃO</label><input type="text"
                                    class="form-control mask-money text-danger calc-fiscal" id="supres_fisc"
                                    name="SUPRESSÃO FISCALIZAÇÃO"></div>
                            <div class="col-md-4"><label class="form-label">REPERCUSSÃO</label><input type="text"
                                    class="form-control fw-bold bg-light" id="reperc_fisc"
                                    name="REPERCUSSÃO FISCALIZAÇÃO" readonly></div>

                            <div class="col-12">
                                <div
                                    style="border-bottom: 2px solid var(--sop-gray-light); margin: 1rem 0; color: var(--sop-green); font-weight: 700;">
                                    VALORES (G)</div>
                            </div>
                            <div class="col-md-4"><label class="form-label">ACRÉSCIMO</label><input type="text"
                                    class="form-control mask-money calc-gecope" id="acresc_gec" name="ACRÉSCIMO GECOPE">
                            </div>
                            <div class="col-md-4"><label class="form-label">SUPRESSÃO</label><input type="text"
                                    class="form-control mask-money text-danger calc-gecope" id="supres_gec"
                                    name="SUPRESSÃO GECOPE"></div>
                            <div class="col-md-4"><label class="form-label">REPERCUSSÃO</label><input type="text"
                                    class="form-control fw-bold bg-light" id="reperc_gec" name="REPERCUSSÃO GECOPE"
                                    readonly></div>
                        </div>
                    </form>
                    <div id="msg-feedback" class="mt-3" style="display:none"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary"
                        data-bs-dismiss="modal">CANCELAR</button><button class="btn btn-success px-4" id="btn-salvar"
                        onclick="enviarParaPlanilha()">SALVAR</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>GERENCIAR PROCESSO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">

                    <form id="formDetalhes">
                        <input type="hidden" name="action" id="detalheAction" value="update">
                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">DADOS PRINCIPAIS</h6>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label fw-bold">PROCESSO</label><input type="text"
                                    class="form-control bg-light fw-bold" name="PROCESSO N." id="det_processo" readonly>
                            </div>
                            <div class="col-md-3"><label class="form-label">TIPO</label><input type="text"
                                    class="form-control" name="TIPO" id="det_tipo"></div>
                            <div class="col-md-3"><label class="form-label">STATUS</label><select
                                    class="form-select fw-bold text-primary" name="STATUS" id="det_status">
                                    <option value="AGUAR. ANÁLISE">AGUAR. ANÁLISE</option>
                                    <option value="EM ANÁLISE">EM ANÁLISE</option>
                                    <option value="AGUAR. REANÁLISE">AGUAR. REANÁLISE</option>
                                    <option value="EM REANÁLISE">EM REANÁLISE</option>
                                    <option value="DEVOLVIDO P/ REANÁLISE FISCAL">DEVOLVIDO P/ REANÁLISE FISCAL</option>
                                    <option value="ANÁLISE FISCAL">ANÁLISE FISCAL</option>
                                    <option value="AGUAR. APROVAÇÃO">AGUAR. APROVAÇÃO</option>
                                    <option value="APROVADO">APROVADO</option>
                                    <option value="ARQUIVADO">ARQUIVADO</option>
                                    <option value="CONTRATANTE">CONTRATANTE</option>
                                </select></div>
                            <div class="col-md-3"><label class="form-label">FISCAL</label><select class="form-select"
                                    name="FISCAL" id="det_fiscal">
                                    <option value="">Selecione...</option>
                                </select></div>
                            <div class="col-12"><label class="form-label">DESCRIÇÃO</label><textarea
                                    class="form-control" name="DESCRIÇÃO" id="det_descricao" rows="2"></textarea></div>
                        </div>

                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3 mt-4">AGENTES E PRAZOS</h6>
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label">CONTRATANTE</label><input type="text"
                                    class="form-control" name="CONTRATANTE" id="det_contratante"></div>
                            <div class="col-md-6"><label class="form-label">CONTRATADA</label><input type="text"
                                    class="form-control" name="CONTRATADA" id="det_contratada"></div>

                            <div class="col-md-4"><label class="form-label">ABERTURA</label><input type="text"
                                    class="form-control mask-date" name="DATA DE ABERTURA" id="det_data_abertura"
                                    placeholder="dd/mm/aaaa" maxlength="10"></div>
                            <div class="col-md-4"><label class="form-label">RECEBIMENTO</label><input type="text"
                                    class="form-control mask-date" name="DATA RECEBIMENTO" id="det_data_recebimento"
                                    placeholder="dd/mm/aaaa" maxlength="10"></div>
                            <div class="col-md-4">
                                <label class="form-label">ANALISTA</label>
                                <select class="form-select" name="ANALISTA" id="det_analista">
                                    <option value="">Selecione...</option>
                                    <option value="N">Nildeno</option>
                                    <option value="W">Walace</option>
                                </select>
                            </div>

                            <div class="col-md-3"><label class="form-label">META</label><input type="text"
                                    class="form-control mask-date" name="DATA COMPROMISSO FISCAL"
                                    id="det_data_compromisso" placeholder="dd/mm/aaaa" maxlength="10"></div>
                            <div class="col-md-3"><label class="form-label">APROVAÇÃO</label><input type="text"
                                    class="form-control mask-date" name="DATA APROVAÇÃO GECOPE" id="det_data_aprovacao"
                                    placeholder="dd/mm/aaaa" maxlength="10"></div>

                            <div class="col-md-6">
                                <label class="form-label">DEVOLUÇÃO CORREÇÕES (Col O)</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control mask-date" name="DATA DEVOLUÇÃO CORREÇÕES"
                                        id="det_data_devolucao" placeholder="dd/mm/aaaa" maxlength="10"
                                        oninput="calcularDiasDevolucao()" style="padding-right: 90px;">
                                    <span id="det_badge_dias_dev"
                                        class="position-absolute top-50 end-0 translate-middle-y me-3 text-secondary fw-bold"
                                        style="pointer-events: none; font-size: 0.85rem;">
                                        - dias
                                    </span>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3 mt-4">VALORES & ANOTAÇÕES</h6>
                        <div class="row g-3">
                            <div class="col-md-6 border-end">
                                <label class="form-label text-muted">FISCALIZAÇÃO</label>
                                <div class="mb-2"><label class="small">Acréscimo</label><input type="text"
                                        class="form-control form-control-sm mask-money" name="ACRÉSCIMO FISCALIZAÇÃO"
                                        id="det_acresc_f"></div>
                                <div class="mb-2"><label class="small">Supressão</label><input type="text"
                                        class="form-control form-control-sm mask-money text-danger"
                                        name="SUPRESSÃO FISCALIZAÇÃO" id="det_supress_f"></div>
                                <div><label class="small fw-bold">Repercussão</label><input type="text"
                                        class="form-control form-control-sm fw-bold bg-light"
                                        name="REPERCUSSÃO FISCALIZAÇÃO" id="det_reperc_f" readonly></div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted">GECOPE</label>
                                <div class="mb-2"><label class="small">Acréscimo</label><input type="text"
                                        class="form-control form-control-sm mask-money" name="ACRÉSCIMO GECOPE"
                                        id="det_acresc_g"></div>
                                <div class="mb-2"><label class="small">Supressão</label><input type="text"
                                        class="form-control form-control-sm mask-money text-danger"
                                        name="SUPRESSÃO GECOPE" id="det_supress_g"></div>
                                <div><label class="small fw-bold">Repercussão</label><input type="text"
                                        class="form-control form-control-sm fw-bold bg-light" name="REPERCUSSÃO GECOPE"
                                        id="det_reperc_g" readonly></div>
                            </div>

                            <div class="col-12 mt-3">
                                <label class="form-label text-muted"><i
                                        class="bi bi-sticky-fill text-warning me-1"></i>ANOTAÇÕES ADICIONAIS</label>
                                <textarea class="form-control" id="det_notas_locais"
                                    style="background-color: #fffae6; border: 1px solid #f0e68c; font-size: 0.95rem; resize: vertical; min-height: 200px;"
                                    placeholder="Digite aqui observações sobre este processo. Elas ficarão salvas apenas neste computador."></textarea>
                            </div>

                            <div class="col-12 mt-4 pt-2 border-top">
                                <h6 class="text-secondary small fw-bold mb-3"><i
                                        class="bi bi-clock-history me-1"></i>HISTÓRICO DE AÇÕES</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted" style="font-size: 0.75rem;">CRIADO
                                            POR</label>
                                        <input type="text" class="form-control form-control-sm bg-light text-secondary"
                                            id="det_criador" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted" style="font-size: 0.75rem;">ÚLTIMA
                                            ATUALIZAÇÃO</label>
                                        <input type="text" class="form-control form-control-sm bg-light text-secondary"
                                            id="det_atualizacao" readonly>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </form>
                    <div id="msg-detalhes" class="mt-3" style="display:none"></div>
                </div>
                <div class="modal-footer justify-content-between bg-light">
                    <button type="button" class="btn btn-outline-danger btn-sm admin-only" id="btn-excluir"
                        onclick="executarAcaoDetalhes('delete')">
                        <i class="bi bi-trash-fill"></i> EXCLUIR PROCESSO
                    </button>

                    <div>
                        <button type="button" class="btn btn-secondary btn-sm me-2"
                            data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary px-4 admin-only" id="btn-atualizar"
                            onclick="executarAcaoDetalhes('update')">
                            <i class="bi bi-check-lg"></i> SALVAR ALTERAÇÕES
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalNovaVersao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-cloud-arrow-up me-2"></i>ATUALIZAR
                                ARQUIVO</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formNovaVersao">
                                <input type="hidden" id="update-id-orcamento">

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">NOVO ARQUIVO (PDF/XLS)</label>
                                    <input type="file" class="form-control" id="inputArquivoUpdate" required
                                        accept=".xlsx,.xls,.pdf">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">DESCRIÇÃO DAS ALTERAÇÕES</label>
                                    <textarea class="form-control" id="inputDescricaoUpdate" rows="3"
                                        placeholder="Ex: Corrigido o quantitativo do item 5.2 e atualizado valor unitário do item 8."></textarea>
                                    <div class="form-text">Essa informação ficará gravada no histórico da obra.</div>
                                </div>

                                <div class="alert alert-light border small text-muted">
                                    <i class="bi bi-info-circle me-1"></i> Isso criará uma nova versão (V2, V3...) e
                                    notificará que o arquivo foi atualizado.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-primary w-100 fw-bold" onclick="enviarNovaVersao()">
                                <i class="bi bi-send-check me-1"></i> SALVAR NOVA VERSÃO
                            </button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- MODAL CRIAR COMPOSIÇÃO ANALÍTICA -->
            <div class="modal fade" id="modalCriarComposicaoAnalitica" tabindex="-1" aria-hidden="true"
                data-bs-backdrop="static">
                <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 75%;">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>Nova Composição Analítica</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body bg-light">
                            <!-- CABEÇALHO DA COMPOSIÇÃO -->
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title text-muted mb-3 text-uppercase fw-bold"
                                        style="font-size: 0.8rem;">Dados Gerais</h6>
                                    <form id="formComposicaoAnalitica">
                                        <input type="hidden" id="edit-id-composicao" name="id">
                                        <div class="row g-2 align-items-end">
                                            <div class="col-md-1">
                                                <label class="form-label small fw-bold">Código</label>
                                                <input type="text" class="form-control form-control-sm" name="codigo"
                                                    id="comp-codigo">
                                            </div>
                                            <div class="col">
                                                <label class="form-label small fw-bold">Descrição</label>
                                                <input type="text" class="form-control form-control-sm" name="descricao"
                                                    id="comp-descricao" required>
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label small fw-bold">Unid.</label>
                                                <input type="text" class="form-control form-control-sm" name="unidade"
                                                    id="comp-unidade">
                                            </div>
                                            <div class="col-md-auto">
                                                <label class="form-label small fw-bold">Elaboração</label>
                                                <input type="date" class="form-control form-control-sm" name="data_base"
                                                    id="comp-data">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label small fw-bold">BDI %</label>
                                                <input type="text" class="form-control form-control-sm" name="bdi"
                                                    id="comp-bdi" value="0,00" oninput="formatMoneyInput(this)"
                                                    onchange="renderizarItensComposicao(); atualizarCalculosComposicao();">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label small fw-bold">Desc %</label>
                                                <input type="text" class="form-control form-control-sm" name="desconto"
                                                    id="comp-desconto" value="0,00" oninput="formatMoneyInput(this)"
                                                    onchange="renderizarItensComposicao(); atualizarCalculosComposicao();">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- LISTA DE ITENS -->
                            <div class="card shadow-sm">
                                <div
                                    class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                                    <h6 class="mb-0 fw-bold text-dark" style="font-size: 0.9rem;">Itens da Composição
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="abrirModalBuscarItem()">
                                        <i class="bi bi-plus-lg me-1"></i> Adicionar Item
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm align-middle mb-0"
                                            id="tabela-itens-composicao" style="font-size: 0.85rem;">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th style="width: 12%">Origem</th>
                                                    <th style="width: 7%">Código</th>
                                                    <th style="width: 55%">Descrição</th>
                                                    <th style="width: 4%">Unid.</th>
                                                    <th style="width: 6%">Coef.</th>
                                                    <th style="width: 6%">Preço</th>
                                                    <th style="width: 6%">Total</th>
                                                    <th style="width: 4%">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody-itens-composicao">
                                                <!-- Itens serão inseridos aqui via JS -->
                                                <tr class="text-center text-muted" id="placeholder-itens-vazio">
                                                    <td colspan="8" class="py-4">Nenhum item adicionado. Clique em
                                                        "Adicionar Item".</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-white d-flex justify-content-between">
                            <div class="d-flex gap-3 text-end">
                                <div class="text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">MATERIAL</small>
                                    <span class="fw-bold text-secondary" id="total-material">R$ 0,00</span>
                                </div>
                                <div class="text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">MÃO DE OBRA</small>
                                    <span class="fw-bold text-secondary" id="total-mao-de-obra">R$ 0,00</span>
                                </div>
                                <div class="text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">EQUIPAMENTOS</small>
                                    <span class="fw-bold text-secondary" id="total-equipamentos">R$ 0,00</span>
                                </div>
                                <div class="text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">SERVIÇOS</small>
                                    <span class="fw-bold text-secondary" id="total-servico">R$ 0,00</span>
                                </div>
                                <div class="border-start ps-3 text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">TOTAL BDI</small>
                                    <span class="fw-bold text-primary" id="total-bdi">R$ 0,00</span>
                                </div>
                                <div class="text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">TOTAL DESC.</small>
                                    <span class="fw-bold text-danger" id="total-desconto">R$ 0,00</span>
                                </div>
                                <div class="border-start ps-3 text-center">
                                    <small class="text-muted d-block" style="font-size:0.7rem">CUSTO TOTAL UNIT.</small>
                                    <span class="fw-bold text-success fs-5" id="total-geral">R$ 0,00</span>
                                </div>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="button" class="btn btn-success fw-bold" id="btn-salvar-comp-analitica"
                                    onclick="salvarComposicaoAnalitica()">
                                    <i class="bi bi-check-lg me-1"></i> SALVAR COMPOSIÇÃO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL EXPORTAR COMPOSIÇÃO (NOVO) -->
            <div class="modal fade" id="modalExportarComposicao" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fs-6 fw-bold">Baixar Composição</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">
                            <p class="small text-muted mb-3">Escolha o formato do arquivo:</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-danger py-2" onclick="exportarComposicao('PDF')">
                                    <i class="bi bi-file-earmark-pdf fs-5"></i><br>
                                    <span class="fw-bold">PDF</span>
                                </button>
                                <button class="btn btn-outline-primary py-2" onclick="exportarComposicao('DOCX')">
                                    <i class="bi bi-file-earmark-word fs-5"></i><br>
                                    <span class="fw-bold">DOCX</span> (Word)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL BUSCAR ITEM (SUB-MODAL) -->
            <div class="modal fade" id="modalBuscarItemComposicao" tabindex="-2" aria-hidden="true"
                data-bs-backdrop="static">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fs-6"><i class="bi bi-search me-2"></i>Buscar Insumo / Composição
                                Auxiliar</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body bg-light">
                            <div class="card body-bg border-0">
                                <div class="card-body p-2">
                                    <!-- Linha 1: Filtros -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Fonte</label>
                                            <select class="form-select form-select-sm" id="busca-item-fonte"
                                                onchange="toggleBuscaItemMode()">
                                                <option value="SEINFRA" selected>SEINFRA</option>
                                                <option value="SINAPI">SINAPI</option>
                                                <option value="ORSE">ORSE</option>
                                                <option value="MERCADO">MERCADO</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Versão</label>
                                            <select class="form-select form-select-sm" id="busca-item-versao">
                                                <option value="">Carregando...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Referência</label>
                                            <select class="form-select form-select-sm" id="busca-item-referencia">
                                                <option value="Onerada">Onerada</option>
                                                <option value="Desonerada">Desonerada</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- CONTAINER 1: BUSCA -->
                                    <div id="container-busca-item">
                                        <div class="row g-2">
                                            <div class="col-md-10">
                                                <input type="text" class="form-control form-control-sm"
                                                    id="busca-item-termo" placeholder="Digite código ou descrição..."
                                                    onkeyup="if(event.key === 'Enter') executarBuscaItemComposicao()">
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-primary btn-sm w-100"
                                                    onclick="executarBuscaItemComposicao()">
                                                    <i class="bi bi-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CONTAINER 2: CADASTRO MANUAL -->
                                    <div id="form-cadastro-mercado" class="d-none mt-2 border-top pt-2">
                                        <div class="row g-2">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold mb-1">Descrição do Item</label>
                                                <textarea class="form-control form-control-sm" id="mercado-desc"
                                                    rows="2" placeholder="Descrição completa..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold mb-1">Unid.</label>
                                                <input type="text" class="form-control form-control-sm"
                                                    id="mercado-unid" placeholder="UN">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold mb-1">Preço Unit.</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="text" class="form-control" id="mercado-preco"
                                                        oninput="formatMoneyInput(this)" placeholder="0,00">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold mb-1">Coefic.</label>
                                                <input type="number" class="form-control form-control-sm"
                                                    id="mercado-coef" value="1.00" min="0" step="0.0001">
                                            </div>
                                            <div class="col-md-5">
                                            </div>

                                            <div class="col-md-12">
                                                <div class="card bg-light border-0 p-2 mt-1">
                                                    <div class="row g-2 align-items-end">
                                                        <div
                                                            class="col-md-12 mb-1 d-flex justify-content-between align-items-center">
                                                            <span class="badge bg-secondary">Cálculo Retroativo
                                                                (Opcional)</span>
                                                            <a href="https://sindusconce.com.br/indices-economicos/"
                                                                target="_blank"
                                                                class="btn btn-sm btn-outline-primary py-0"
                                                                style="font-size: 0.8rem;">
                                                                <i class="bi bi-box-arrow-up-right me-1"></i> Pesquisar
                                                                Índices
                                                            </a>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small fw-bold mb-0">Data
                                                                Cotação</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="mercado-data-ini" placeholder="MM/AAAA">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small fw-bold mb-0">Ind.
                                                                Cotação</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="mercado-ind-ini" oninput="formatIndexInput(this)"
                                                                placeholder="0,000">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small fw-bold mb-0">Data-Base
                                                                Orç.</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="mercado-data-fin" placeholder="MM/AAAA">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small fw-bold mb-0">Ind.
                                                                Data-Base</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="mercado-ind-fin" oninput="formatIndexInput(this)"
                                                                placeholder="0,000">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label small fw-bold mb-0">Novo
                                                                Preço</label>
                                                            <div class="form-control form-control-sm bg-white text-end text-success fw-bold"
                                                                id="mercado-preco-calc" style="overflow:visible;">R$
                                                                0,00</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-12 text-end mt-2">
                                                <button class="btn btn-success btn-sm"
                                                    onclick="adicionarItemMercadoManual()">
                                                    <i class="bi bi-plus-lg me-1"></i> Adicionar Cotação
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="list-group mt-2 border shadow-sm bg-white" id="lista-resultados-itens"
                                style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center py-3 text-muted small">Digite algo para buscar...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Vincular Fiscal (Admin) -->
            <div class="modal fade" id="modalVincularFiscal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title"><i class="bi bi-link-45deg me-2"></i>Vincular Usuário a Fiscal</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning small mb-3">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i> ATENÇÃO: O nome do usuário <strong
                                    id="vincular-usuario-nome">...</strong> não corresponde a nenhum fiscal da lista
                                oficial.
                            </div>
                            <p class="small mb-2">
                                Para ativar o perfil de <strong>FISCAL</strong>, você deve vincular este cadastro a um
                                nome da lista oficial abaixo.
                            </p>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Selecione o Nome Oficial:</label>
                                <select id="vincular-fiscal-select" class="form-select">
                                    <option value="">Selecione...</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <p class="text-muted small fst-italic mb-0" style="font-size: 0.75rem;">
                                * Ao confirmar, o nome de exibição do usuário será atualizado permanentemente para o
                                nome selecionado.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-secondary"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-sm btn-primary" id="btn-confirmar-vinculo">Confirmar
                                Vínculo</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Login (usuário/senha) -->
            <div class="modal fade" id="modalLogin" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">Acesso Administrativo</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <form id="formLogin" class="modal-body p-3">
                            <div class="mb-2">
                                <label class="form-label small fw-bold">Usuário</label>
                                <input id="login-username" class="form-control form-control-sm" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold">Senha</label>
                                <input id="login-password" type="password" class="form-control form-control-sm"
                                    required>
                            </div>
                            <div id="login-feedback" class="text-danger small" style="display:none;">Usuário ou senha
                                incorretos.</div>
                            <div class="d-grid mt-3">
                                <button class="btn btn-success" type="submit">Entrar</button>
                            </div>
                        </form>
                        <div class="modal-footer small text-muted">
                            <div>Entre com credenciais válidas para ativar o modo administrador.</div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="btn-trigger-modal-versao" type="button" style="display:none;" data-bs-toggle="modal"
                data-bs-target="#modalNovaVersao"></button>

            <script>
                // Variáveis globais de estado
                let currentCompositionData = null;


                /* --------------------------------------------------------------
                   OVERLAY DE BOAS-VINDAS / LOGIN (TELA INICIAL)
                -------------------------------------------------------------- */

                /* HTML do overlay será injetado dinamicamente para não alterar a ordem do arquivo
                   (mas já podemos defini-lo aqui para facilitar alteração futura). */

                // Overlay de login agora está no HTML estático (logo após <body>).
                // Aqui apenas registramos os event listeners.
                document.addEventListener('DOMContentLoaded', () => {

                    // Toggle Logic
                    const containerLogin = document.getElementById('container-login');
                    const containerReg = document.getElementById('container-register');

                    const btnShowReg = document.getElementById('btn-show-register');
                    const btnShowLogin = document.getElementById('btn-show-login');

                    if (btnShowReg) {
                        btnShowReg.addEventListener('click', (e) => {
                            e.preventDefault();
                            containerLogin.style.display = 'none';
                            containerReg.style.display = 'block';
                        });
                    }

                    if (btnShowLogin) {
                        btnShowLogin.addEventListener('click', (e) => {
                            e.preventDefault();
                            containerReg.style.display = 'none';
                            containerLogin.style.display = 'block';
                        });
                    }

                    // Handle Login
                    document.getElementById('landingLoginForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const matricula = document.getElementById('landing-matricula').value.trim();
                        const password = document.getElementById('landing-password').value;
                        const email = `${matricula}@gecope.app`;
                        await signInWithEmail(email, password);
                    });

                    // Handle Register
                    document.getElementById('landingRegisterForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const nome = document.getElementById('reg-nome').value.trim();
                        const sobrenome = document.getElementById('reg-sobrenome').value.trim();
                        const matricula = document.getElementById('reg-matricula').value.trim();
                        const senha = document.getElementById('reg-senha').value;

                        await signUpRequest(nome, sobrenome, matricula, senha);

                        // Retorna ao login
                        containerReg.style.display = 'none';
                        containerLogin.style.display = 'block';
                        document.getElementById('landingRegisterForm').reset();
                    });
                    // Listeners de Abas
                    const tabComposicoes = document.querySelector('button[data-bs-target="#pane-composicoes"]');
                    if (tabComposicoes) {
                        tabComposicoes.addEventListener('shown.bs.tab', () => {
                            if (typeof carregarComposicoes === 'function') carregarComposicoes();
                        });
                    }

                    // Inicialização
                    if (typeof carregarListaFiscais === 'function') carregarListaFiscais();
                });


                /* --- FUNÇÕES DE DECISÃO CORRIGIDAS (SEM TRAVAMENTO) --- */

                function abrirModalAtender(id, index) {
                    const modalEl = document.getElementById('modalAtenderRevisao');

                    // TRUQUE: Move o modal para o final do body para evitar conflito de z-index (Tela Escura)
                    if (modalEl.parentElement !== document.body) {
                        document.body.appendChild(modalEl);
                    }

                    document.getElementById('atender-id-orcamento').value = id;
                    document.getElementById('atender-index-comentario').value = index;
                    document.getElementById('formAtender').reset();

                    // Usa getOrCreateInstance para evitar duplicidade
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                }

                function abrirModalRecusar(id, index) {
                    const modalEl = document.getElementById('modalRecusarRevisao');

                    // TRUQUE: Move o modal para o final do body
                    if (modalEl.parentElement !== document.body) {
                        document.body.appendChild(modalEl);
                    }

                    document.getElementById('recusar-id-orcamento').value = id;
                    document.getElementById('recusar-index-comentario').value = index;
                    document.getElementById('formRecusar').reset();

                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                }

                // ... Mantenha as funções processarAtendimento e processarRecusa como estavam, 
                // apenas certifique-se de que no processarAtendimento o status mudou para 'Atualizado':
                // status: 'Atualizado'

                /* --------------------------------------------------------------
                   SCRIPT PRINCIPAL - CORRIGIDO (V7)
                -------------------------------------------------------------- */

                // --- 1. CONFIGURAÇÕES E CONEXÃO ---
                const SUPABASE_URL = 'https://qexdnxqmiaarzwwwrcor.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFleGRueHFtaWFhcnp3d3dyY29yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDYyNDUsImV4cCI6MjA4NTQyMjI0NX0.RJnLpsXMMzzhcq_YKHI7wObBqubKgdltauvBvGpz4dc';

                // CORREÇÃO: Usamos 'sbClient' para não conflitar com a biblioteca 'supabase' global
                const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // LISTA DE FISCAIS (FIXA - SOLICITAÇÃO USUÁRIO)
                const FISCAIS_LIST = [
                    'ANTÔNIO EDSON', 'ANTÔNIO ELDER', 'ANTÔNIO ROLIM', 'ARTHUR EDÍSIO', 'ÁGABE SOUSA', 'CLOVIS FONTENELE',
                    'CRISTIANA PALÁCIO', 'CRISTIANO GUILHERME', 'DAVI BRAGA', 'DAVI GADELHA', 'DAVID MACHADO', 'DIEGO DEMÉTRIO',
                    'EDGAR PEIXOTO', 'EDILSON JR.', 'EDUARDO CIDRÃO', 'EDUARDO STÊNIO', 'EMMANUEL AUGUSTO', 'FÁBIO BONFIM',
                    'FLÁVIO COLARES', 'FLEURY NAPOLEÃO', 'FRANCISCO GOIANA', 'FRANCISCO PARENTE', 'FRANCISCO TALES',
                    'GUILHERME MAIA', 'HERBERT ALAN', 'JOHN HERBERT', 'JOSÉ MICHELL', 'JOSÉ MUNIZ', 'JOSÉ ROSEMBERG',
                    'JOSÉ WILLIAN', 'JOSUÉ JOHAB', 'JURANDIR VIANA', 'GECOPE DIFOR', 'JUSTINIANO CAMURÇA', 'KERLON',
                    'LEANDRO LESSA', 'LEONARDI', 'LEXANDRE HORTÊNCIO', 'LUCAS ARAÚJO', 'LUCIANO DENIZARDY', 'MANOEL LUCAS',
                    'MÁRCIO MONTENEGRO', 'MÁRIO EDSON', 'NERTAN FONSECA', 'PAULO LOIOLA', 'ROBERTO BRINGEL', 'ROBERTO HOLANDA',
                    'ROBERTO XAVIER', 'RUI DE PAULA', 'SAULLO MARINHO', 'VIRNA DE PAULA', 'WEBER TEIXEIRA', 'WILSON MACHADO'
                ];

                function carregarListaFiscais() {
                    console.log('Lista de Usuários carregada (Estática):', FISCAIS_LIST.length);
                    atualizarDropdownsFiscais();
                }

                // --- 1. MÁSCARA PROCESSO ---
                function mascaraProcesso(val) {
                    val = val.replace(/\D/g, '');
                    val = val.replace(/^(\d{5})(\d)/, '$1.$2');
                    val = val.replace(/^(\d{5})\.(\d{6})(\d)/, '$1.$2/$3');
                    val = val.replace(/^(\d{5})\.(\d{6})\/(\d{4})(\d)/, '$1.$2/$3-$4');
                    if (val.length > 20) val = val.substring(0, 20);
                    return val;
                }

                function calcRepercussao(acrescId, supressId, repercId) {
                    const elA = document.getElementById(acrescId);
                    const elS = document.getElementById(supressId);
                    const elR = document.getElementById(repercId);

                    if (!elA || !elS || !elR) return;

                    const valA = moedaParaNumero(elA.value) || 0;
                    const valS = moedaParaNumero(elS.value) || 0;
                    const valR = valA + valS;

                    elR.value = 'R$ ' + valR.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }

                document.addEventListener('input', (e) => {
                    if (e.target.id === 'cad-processo') e.target.value = mascaraProcesso(e.target.value);

                    if (e.target.classList.contains('calc-fiscal')) calcRepercussao('acresc_fisc', 'supres_fisc', 'reperc_fisc');
                    if (e.target.classList.contains('calc-gecope')) calcRepercussao('acresc_gec', 'supres_gec', 'reperc_gec');

                    // Detalhes (Gerenciar Processo)
                    const detailsMap = {
                        'det_acresc_f': ['det_acresc_f', 'det_supress_f', 'det_reperc_f'],
                        'det_supress_f': ['det_acresc_f', 'det_supress_f', 'det_reperc_f'],
                        'det_acresc_g': ['det_acresc_g', 'det_supress_g', 'det_reperc_g'],
                        'det_supress_g': ['det_acresc_g', 'det_supress_g', 'det_reperc_g']
                    };
                    if (detailsMap[e.target.id]) {
                        const [a, s, r] = detailsMap[e.target.id];
                        calcRepercussao(a, s, r);
                    }
                });

                function atualizarDropdownsFiscais() {
                    // Atualiza apenas dropdowns estáticos que precisam ser populados logo após o carregamento
                    // Modais como 'share-user-select' ou 'coment-fiscal' são populados ao abrir, usando a FISCAIS_LIST atualizada
                    const ids = ['cad-fiscal'];

                    ids.forEach(id => {
                        const sel = document.getElementById(id);
                        if (sel) {
                            const valAtual = sel.value;
                            // Limpa mantendo a primeira opção (Selecione...)
                            const firstOpt = sel.options[0];
                            sel.innerHTML = '';
                            if (firstOpt) sel.appendChild(firstOpt);

                            FISCAIS_LIST.forEach(f => {
                                const opt = document.createElement('option');
                                opt.value = f; opt.textContent = f; sel.appendChild(opt);
                            });

                            if (valAtual && Array.from(sel.options).some(o => o.value === valAtual)) {
                                sel.value = valAtual;
                            }
                        }
                    });
                }

                // --- FUNÇÃO: ENCONTRAR FISCAL NA LISTA (MATCHING INTELIGENTE) ---
                function findFiscalNameInList(nomeCompleto) {
                    if (!nomeCompleto || nomeCompleto.trim() === '') return null;

                    const normalizar = (str) => {
                        return str
                            .trim()
                            .toUpperCase()
                            .normalize('NFD')
                            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                            .replace(/[\s\.\-]+/g, ' '); // Normaliza espaços e hífens
                    };

                    const inputNormal = normalizar(nomeCompleto);

                    // 1. Procura exata (depois de normalizar)
                    for (const fiscal of FISCAIS_LIST) {
                        if (normalizar(fiscal) === inputNormal) {
                            console.log('[MATCH-1 EXATO]', nomeCompleto, '->', fiscal);
                            return fiscal;
                        }
                    }

                    // 2. Procura por partes: todos os nomes do input devem estar no fiscal
                    const partes = inputNormal.split(/\s+/).filter(p => p.length > 0);
                    for (const fiscal of FISCAIS_LIST) {
                        const fiscalNormal = normalizar(fiscal);
                        if (partes.every(parte => fiscalNormal.includes(parte))) {
                            console.log('[MATCH-2 PALAVRAS]', nomeCompleto, '->', fiscal);
                            return fiscal;
                        }
                    }

                    // 3. Procura reversa: todos os nomes do fiscal devem estar no input
                    for (const fiscal of FISCAIS_LIST) {
                        const fiscalNormal = normalizar(fiscal);
                        const partesFiscal = fiscalNormal.split(/\s+/).filter(p => p.length > 0);
                        if (partesFiscal.every(parte => inputNormal.includes(parte))) {
                            console.log('[MATCH-3 REVERSO]', nomeCompleto, '->', fiscal);
                            return fiscal;
                        }
                    }

                    // 4. Procura por iniciais: se o input começa com as iniciais do fiscal
                    const iniciaisInput = partes.map(p => p[0]).join('');
                    for (const fiscal of FISCAIS_LIST) {
                        const partesFiscal = normalizar(fiscal).split(/\s+/).filter(p => p.length > 0);
                        const iniciaisFiscal = partesFiscal.map(p => p[0]).join('');
                        if (iniciaisInput === iniciaisFiscal && inputNormal.length < fiscalNormal.length) {
                            console.log('[MATCH-4 INICIAIS]', nomeCompleto, '->', fiscal);
                            return fiscal;
                        }
                    }

                    console.log('[SEM MATCH]', nomeCompleto);
                    return null;
                }

                let allData = [];
                let currentTabelaData = []; // Cache para recálculo de BDI/Desconto

                // --- 2. FUNÇÕES UTILITÁRIAS DE FORMATAÇÃO ---

                function dataParaISO(strData) {
                    if (!strData) return null;
                    if (strData.match(/^\d{4}-\d{2}-\d{2}$/)) return strData;
                    const partes = strData.split('/');
                    if (partes.length === 3) return `${partes[2]}-${partes[1]}-${partes[0]}`;
                    return null;
                }

                function moedaParaNumero(strValor) {
                    if (!strValor) return 0;
                    if (typeof strValor === 'number') return strValor;
                    const limpo = strValor.toString().replace(/\./g, '').replace(',', '.');
                    return parseFloat(limpo) || 0;
                }

                function isoParaDate(isoStr) {
                    if (!isoStr) return null;
                    return new Date(isoStr + "T00:00:00");
                }

                function dateParaInput(dateObj) {
                    if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj)) return "";
                    return dateObj.toLocaleDateString('pt-BR');
                }

                function formatCompact(num) {
                    if (num === null || num === undefined) return 'R$ 0,00';
                    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }

                function formatPercentage(num) {
                    if (num === null || num === undefined || !isFinite(num)) return '–';
                    return num.toFixed(1).replace('.', ',') + '%';
                }

                function isFiniteNumber(v) { return typeof v === 'number' && isFinite(v); }
                function sum(rows, fn) { return rows.reduce((acc, it) => { const v = fn(it); return acc + (isFiniteNumber(v) ? v : 0); }, 0); }
                function escapeHTML(str) { const s = String(str || ''); return s.replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]; }); }

                // --- FUNÇÃO DEBOUNCE (PERFORMANCE) ---
                function debounce(func, wait) {
                    let timeout;
                    return function (...args) {
                        const context = this;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), wait);
                    };
                }

                // --- 3. CORE: CARREGAMENTO DE DADOS (READ) ---
                async function carregarDadosSupabase() {
                    const loader = document.getElementById("load-error");
                    if (loader) loader.style.display = "none";

                    let data = null, error = null;
                    try {
                        console.log('[DEBUG] Iniciando carregarDadosSupabase...');
                        console.log('[DEBUG] sbClient:', sbClient ? 'OK' : 'FALHA - não inicializado');
                        console.log('[DEBUG] Usuário logado:', localStorage.getItem('sop_user') || 'Não');

                        // Busca dados usando o cliente corrigido 'sbClient'
                        console.log('[DEBUG] Executando query na tabela "processos"...');
                        ({ data, error } = await sbClient
                            .from('processos')
                            .select('*')
                            .order('created_at', { ascending: false }));

                        console.log('[DEBUG] Resposta do servidor:', { dataCount: data?.length || 0, hasError: !!error });
                        if (error) console.error('[ERRO Supabase]', error);

                        if (error) {
                            throw new Error(`Tabela "processos" não acessível: ${error.message}`);
                        }

                        if (!data || data.length === 0) {
                            console.warn('[AVISO] Nenhum dado retornado. Tabela vazia ou não existe.');
                        } else {
                            // FILTRO DE EXCLUÍDOS (Soft Delete)
                            // Remove processos marcados como 'EXCLUÍDO' da visualização principal
                            const countBefore = data.length;
                            data = data.filter(d => d.status !== 'EXCLUÍDO' && d.status !== 'EXCLUIDO');
                            const countAfter = data.length;
                            if (countBefore !== countAfter) {
                                console.log(`[AUDIT] ${countBefore - countAfter} processos excluídos ocultados da lista.`);
                            }
                        }
                    } catch (err) {
                        console.error('[ERRO] Falha ao carregar dados:', err.message || err);
                        if (loader) {
                            loader.style.display = "block";
                            loader.innerHTML = `<strong>⚠️ Erro ao carregar dados:</strong><br><code>${err.message}</code><br>
                            <small style="color:#666;margin-top:10px;display:block;">
                              <strong>Verifique:</strong>
                              <ul style="text-align:left;margin:5px 0;">
                                <li>✓ Tabela <code>processos</code> foi criada no Supabase?</li>
                                <li>✓ Credenciais SUPABASE_URL e SUPABASE_KEY corretas (linha ~2840)?</li>
                                <li>✓ Há registros para carregar?</li>
                                <li>✓ Console do navegador (F12) para mais detalhes</li>
                              </ul>
                            </small>`;
                        }
                        return;
                    }


                    // --- LÓGICA DE FILTRAGEM PARA FISCAL ---
                    const userRole = localStorage.getItem('sop_role');
                    const userEmail = localStorage.getItem('sop_user');
                    let fiscalName = null;

                    if (userRole === 'fiscal' && userEmail) {
                        try {
                            // 1. Primeiro tenta buscar o nome/sobrenome no banco
                            const { data: userData, error: userError } = await sbClient
                                .from('app_users')
                                .select('nome, sobrenome')
                                .eq('email', userEmail)
                                .single();

                            if (!userError && userData && userData.nome) {
                                // Utiliza nome e sobrenome para formar o nome completo
                                fiscalName = (userData.nome + (userData.sobrenome ? ' ' + userData.sobrenome : '')).trim().toUpperCase();
                                console.log('[DEBUG] Fiscal Name Recuperado do Banco (nome/sobrenome):', fiscalName);
                            }

                            // 2. Fallback: derivar do email (compatibilidade com versão anterior)
                            if (!fiscalName) {
                                const namePart = userEmail.split('@')[0];
                                fiscalName = namePart.replace(/\./g, ' ').toUpperCase();
                                console.log('[DEBUG] Fiscal Name Derivado do Email:', fiscalName);
                            }

                            localStorage.setItem('sop_fiscal_name', fiscalName);
                            console.log('[DEBUG] Email do usuário:', userEmail);

                            if (data && data.length > 0) {
                                const originalCount = data.length;
                                // Normaliza o nome do fiscal em palavras para comparação robusta
                                const nameParts = fiscalName.trim().split(/[\s\.\-]+/).filter(p => p.length > 0);

                                // Log dos dados antes de filtrar (para debug)
                                console.log('[DEBUG] Todos os fiscais únicos no banco:', Array.from(new Set(data.map(d => (d.fiscal || "").toUpperCase().trim()))));
                                console.log('[DEBUG] Procurando por processos do fiscal:', fiscalName);

                                data = data.filter(d => {
                                    const dFiscal = (d.fiscal || "").toUpperCase().trim();

                                    // Normaliza o fiscal do banco (remove pontos e hífens, deixa só espaços)
                                    const dFiscalNormalizado = dFiscal.replace(/[\.\-]+/g, ' ').trim();

                                    // Comparação exata
                                    if (dFiscalNormalizado === fiscalName) return true;

                                    // Verifica se todas as palavras do nome derivado aparecem no fiscal normalizado
                                    if (nameParts.every(part => dFiscalNormalizado.includes(part))) return true;

                                    // Verifica se o nome do fiscal contém todas as palavras
                                    const dFiscalParts = dFiscalNormalizado.split(/\s+/).filter(p => p.length > 0);
                                    if (dFiscalParts.every(part => fiscalName.includes(part))) return true;

                                    return false;
                                });
                                console.log(`[DEBUG] Filtragem Fiscal: ${originalCount} -> ${data.length} processos.`);
                                if (data.length > 0) {
                                    console.log('[DEBUG] Processos encontrados:', data.map(d => ({ processo: d.processo, fiscal: d.fiscal })));
                                }
                            }
                        } catch (e) {
                            console.error('Erro ao filtrar fiscal:', e);
                        }
                    }

                    allData = data.map(r => {
                        const dataAbertura = isoParaDate(r.data_abertura);
                        const dataAprov = isoParaDate(r.data_aprovacao_gecope);

                        let prazoDias = null;
                        if (dataAbertura && dataAprov) {
                            prazoDias = Math.round((dataAprov - dataAbertura) / (1000 * 60 * 60 * 24));
                        }

                        let nomeAnalista = r.analista;
                        if (r.analista === "N") nomeAnalista = "Nildeno";
                        else if (r.analista === "W") nomeAnalista = "Walace";

                        return {
                            id: r.id,
                            processo: r.processo,
                            status: r.status || "Não informado",
                            tipo: r.tipo || "Não informado",
                            descricao: r.descricao || "",
                            fiscal: r.fiscal || "Não informado",
                            contratada: r.contratada || "Não informado",
                            contratante: r.contratante || "Não informado",
                            analista: r.analista,
                            nomeAnalista: nomeAnalista,

                            dataAbertura: dataAbertura,
                            anoAbertura: dataAbertura ? dataAbertura.getFullYear() : null,
                            mesAbertura: dataAbertura ? (dataAbertura.getMonth() + 1) : null,
                            dataRecebimento: isoParaDate(r.data_recebimento),
                            dataCompromissoFiscal: isoParaDate(r.data_compromisso_fiscal),
                            dataAprovacao: dataAprov,
                            dataDevolucaoCorrecoes: isoParaDate(r.data_devolucao_correcoes),
                            prazoDias: prazoDias,

                            acrescFiscal: Number(r.acresc_fiscal) || 0,
                            supressFiscal: Number(r.supress_fiscal) || 0,
                            repercFiscal: Number(r.reperc_fiscal) || 0,
                            acrescGecope: Number(r.acresc_gecope) || 0,
                            supressGecope: Number(r.supress_gecope) || 0,
                            repercGecope: Number(r.reperc_gecope) || 0,

                            // Audit Data Mapping
                            criador: r.criador,
                            created_at: r.created_at,
                            atualizado_por: r.atualizado_por,
                            ultima_atualizacao: r.ultima_atualizacao, // timestamp
                            excluido_por: r.excluido_por,
                            data_exclusao: r.data_exclusao
                        };
                    });

                    console.log(`[INFO] Carregamento bem-sucedido! ${allData.length} registros processados.`);
                    // Atualiza a interface
                    // 1. Setup Filters/Bases first
                    try { populateAllTabFilters(); } catch (e) { console.error('Erro em populateAllTabFilters:', e); }

                    // 2. Render UI
                    try { renderLastUpdate(); } catch (e) { console.warn('renderLastUpdate missing/fail'); }
                    try { updateDashboard(); } catch (e) { console.warn('updateDashboard fail'); }

                    clearFinanceiro();
                    clearGerencial();
                    clearPrazos();
                    updateFinanceiro();
                }

                // --- 4. CORE: SALVAR NOVO PROCESSO (CREATE) ---
                async function enviarParaPlanilha() {
                    const form = document.getElementById('formCadastro');
                    const btn = document.getElementById('btn-salvar');
                    const msg = document.getElementById('msg-feedback');

                    if (!form.checkValidity()) { form.reportValidity(); return; }

                    const formData = new FormData(form);
                    const numProcessoRaw = formData.get("PROCESSO N.");
                    const numProcesso = numProcessoRaw ? numProcessoRaw.trim() : "";

                    // 1. Validação de Formato Rigorosa (00000.000000/0000-00)
                    const formatRegex = /^\d{5}\.\d{6}\/\d{4}-\d{2}$/;
                    if (!formatRegex.test(numProcesso)) {
                        alert("Formato inválido!\nO número deve seguir estritamente o padrão: 00000.000000/0000-00");
                        return;
                    }

                    // 2. Verificação Local (Feedback Instantâneo)
                    const existeLocal = allData.some(d => d.processo === numProcesso);
                    if (existeLocal) {
                        alert("Este número de processo já consta na lista local.");
                        return;
                    }

                    // Salva texto/estado do botão
                    btn.disabled = true;
                    const btnTextoOriginal = btn.innerText;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> VERIFICANDO...';

                    // 3. Verificação no Servidor (Garantia de Unicidade)
                    try {
                        const { data: dbCheck, error: checkError } = await sbClient
                            .from('processos')
                            .select('id')
                            .eq('processo', numProcesso)
                            .maybeSingle();

                        if (checkError) {
                            throw checkError; // Joga para o catch
                        }

                        if (dbCheck) {
                            alert("ERRO CRÍTICO: Este processo já existe no banco de dados.");
                            btn.disabled = false;
                            btn.innerHTML = btnTextoOriginal;
                            return;
                        }

                    } catch (err) {
                        console.error("Erro ao verificar duplicidade:", err);
                        alert("Erro de conexão/verificação. Tente novamente.");
                        btn.disabled = false;
                        btn.innerHTML = btnTextoOriginal;
                        return;
                    }

                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> SALVANDO...';

                    const payload = {
                        processo: numProcesso,
                        tipo: formData.get("TIPO"),
                        status: formData.get("STATUS"),
                        descricao: formData.get("DESCRIÇÃO"),
                        contratante: formData.get("CONTRATANTE"),
                        contratada: formData.get("CONTRATADA"),
                        fiscal: formData.get("FISCAL"),
                        analista: formData.get("ANALISTA"),

                        data_abertura: dataParaISO(formData.get("DATA DE ABERTURA")),
                        data_recebimento: dataParaISO(formData.get("DATA RECEBIMENTO")),
                        data_compromisso_fiscal: dataParaISO(formData.get("DATA COMPROMISSO FISCAL")),

                        acresc_fiscal: moedaParaNumero(formData.get("ACRÉSCIMO FISCALIZAÇÃO")),
                        supress_fiscal: moedaParaNumero(formData.get("SUPRESSÃO FISCALIZAÇÃO")),
                        reperc_fiscal: moedaParaNumero(formData.get("REPERCUSSÃO FISCALIZAÇÃO")),
                        acresc_gecope: moedaParaNumero(formData.get("ACRÉSCIMO GECOPE")),
                        supress_gecope: moedaParaNumero(formData.get("SUPRESSÃO GECOPE")),
                        reperc_gecope: moedaParaNumero(formData.get("REPERCUSSÃO GECOPE")),

                        // Audit: Criação
                        criador: localStorage.getItem('sop_user_name') || 'Sistema',


                    };

                    const { data, error } = await sbClient.from('processos').insert([payload]);

                    if (error) {
                        console.error(error);
                        msg.style.display = 'block';
                        msg.className = 'alert alert-danger mt-3';
                        msg.innerHTML = `Erro ao salvar: ${error.message}`;
                        btn.disabled = false;
                        btn.innerHTML = 'SALVAR';
                    } else {
                        msg.style.display = 'block';
                        msg.className = 'alert alert-success mt-3';
                        msg.innerHTML = '✅ Salvo com sucesso no Banco de Dados!';

                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCadastro'));
                            modal.hide();
                            form.reset();
                            msg.style.display = 'none';
                            btn.disabled = false;
                            btn.innerHTML = 'SALVAR';
                            carregarDadosSupabase();
                        }, 1500);
                    }
                }

                // --- 5. CORE: DETALHES, ATUALIZAR E EXCLUIR ---
                function abrirDetalhes(processoStr) {
                    const row = allData.find(d => d.processo === processoStr);
                    if (!row) { alert("Erro: Dados não encontrados na memória."); return; }

                    document.getElementById('det_processo').value = row.processo;
                    document.getElementById('det_tipo').value = row.tipo;
                    document.getElementById('det_status').value = row.status;
                    document.getElementById('det_descricao').value = row.descricao;
                    document.getElementById('det_contratante').value = row.contratante;
                    document.getElementById('det_contratada').value = row.contratada;

                    const selFiscal = document.getElementById('det_fiscal');
                    if (selFiscal.options.length <= 1) {
                        FISCAIS_LIST.forEach(f => {
                            const opt = document.createElement('option');
                            opt.value = f; opt.textContent = f; selFiscal.appendChild(opt);
                        });
                    }
                    selFiscal.value = row.fiscal;

                    document.getElementById('det_data_abertura').value = dateParaInput(row.dataAbertura);
                    document.getElementById('det_data_compromisso').value = dateParaInput(row.dataCompromissoFiscal);
                    document.getElementById('det_data_aprovacao').value = dateParaInput(row.dataAprovacao);
                    if (document.getElementById('det_data_recebimento')) document.getElementById('det_data_recebimento').value = dateParaInput(row.dataRecebimento);
                    if (document.getElementById('det_analista')) document.getElementById('det_analista').value = row.analista;

                    const elDevolucao = document.getElementById('det_data_devolucao');
                    if (elDevolucao) { elDevolucao.value = dateParaInput(row.dataDevolucaoCorrecoes); calcularDiasDevolucao(); }

                    const toInputMoney = (val) => val.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                    document.getElementById('det_acresc_f').value = toInputMoney(row.acrescFiscal);
                    document.getElementById('det_supress_f').value = toInputMoney(row.supressFiscal);
                    document.getElementById('det_reperc_f').value = toInputMoney(row.repercFiscal);
                    document.getElementById('det_acresc_g').value = toInputMoney(row.acrescGecope);
                    document.getElementById('det_supress_g').value = toInputMoney(row.supressGecope);
                    document.getElementById('det_reperc_g').value = toInputMoney(row.repercGecope);

                    const notaSalva = localStorage.getItem(`nota_proc_${row.processo}`);
                    const elNota = document.getElementById('det_notas_locais');
                    if (elNota) elNota.value = notaSalva || "";

                    const isAdmin = document.body.classList.contains('is-admin');
                    const inputs = document.querySelectorAll('#formDetalhes input, #formDetalhes select, #formDetalhes textarea');
                    inputs.forEach(el => { el.disabled = !isAdmin; });

                    document.getElementById('msg-detalhes').style.display = 'none';
                    document.getElementById('btn-atualizar').innerHTML = '<i class="bi bi-check-lg"></i> SALVAR ALTERAÇÕES';
                    document.getElementById('btn-excluir').innerHTML = '<i class="bi bi-trash-fill"></i> EXCLUIR PROCESSO';

                    // Audit Info Display
                    const dtCriacao = row.created_at ? new Date(row.created_at).toLocaleString('pt-BR') : '';
                    const txtCriador = row.criador || 'Não Registrado';
                    document.getElementById('det_criador').value = dtCriacao ? `${txtCriador} em ${dtCriacao}` : txtCriador;

                    let txtUpdate = 'Sem alterações recentes';
                    if (row.atualizado_por) {
                        const dt = row.ultima_atualizacao ? new Date(row.ultima_atualizacao).toLocaleString('pt-BR') : '';
                        txtUpdate = `${row.atualizado_por} em ${dt}`;
                    }
                    document.getElementById('det_atualizacao').value = txtUpdate;



                    const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
                    modal.show();
                }

                async function executarAcaoDetalhes(actionType) {
                    const form = document.getElementById('formDetalhes');
                    const processoNome = document.getElementById('det_processo').value;

                    const registroOriginal = allData.find(d => d.processo === processoNome);
                    if (!registroOriginal || !registroOriginal.id) {
                        alert("Erro crítico: ID do processo não localizado.");
                        return;
                    }
                    const idUnico = registroOriginal.id;

                    if (actionType === 'delete') {
                        if (!confirm("TEM CERTEZA? O processo será movido para EXCLUÍDOS e sairá da lista principal.")) return;
                        const btn = document.getElementById('btn-excluir');
                        btn.innerHTML = "EXCLUINDO...";
                        btn.disabled = true;

                        // Soft Delete com Auditoria
                        const userName = localStorage.getItem('sop_user_name') || 'Usuário Desconhecido';
                        const updates = {
                            status: 'EXCLUÍDO',
                            excluido_por: userName,
                            data_exclusao: new Date().toISOString()
                        };

                        const { error } = await sbClient.from('processos').update(updates).eq('id', idUnico);

                        if (error) {
                            alert("Erro ao excluir: " + error.message);
                            btn.disabled = false;
                        } else {
                            alert("Excluído com sucesso!");
                            bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();
                            carregarDadosSupabase();
                        }
                        return;
                    }

                    if (actionType === 'update') {
                        const formData = new FormData(form);
                        const textoNota = document.getElementById('det_notas_locais').value;
                        localStorage.setItem(`nota_proc_${processoNome}`, textoNota);

                        const updates = {
                            tipo: formData.get("TIPO"),
                            status: formData.get("STATUS"),
                            descricao: formData.get("DESCRIÇÃO"),
                            fiscal: document.getElementById('det_fiscal').value,
                            contratante: formData.get("CONTRATANTE"),
                            contratada: formData.get("CONTRATADA"),
                            analista: document.getElementById('det_analista').value,

                            data_abertura: dataParaISO(formData.get("DATA DE ABERTURA")),
                            data_recebimento: dataParaISO(formData.get("DATA RECEBIMENTO")),
                            data_compromisso_fiscal: dataParaISO(formData.get("DATA COMPROMISSO FISCAL")),
                            data_aprovacao_gecope: dataParaISO(formData.get("DATA APROVAÇÃO GECOPE")),
                            data_devolucao_correcoes: dataParaISO(formData.get("DATA DEVOLUÇÃO CORREÇÕES")),

                            acresc_fiscal: moedaParaNumero(formData.get("ACRÉSCIMO FISCALIZAÇÃO")),
                            supress_fiscal: moedaParaNumero(formData.get("SUPRESSÃO FISCALIZAÇÃO")),
                            reperc_fiscal: moedaParaNumero(formData.get("REPERCUSSÃO FISCALIZAÇÃO")),
                            acresc_gecope: moedaParaNumero(formData.get("ACRÉSCIMO GECOPE")),
                            supress_gecope: moedaParaNumero(formData.get("SUPRESSÃO GECOPE")),
                            reperc_gecope: moedaParaNumero(formData.get("REPERCUSSÃO GECOPE")),

                            // Audit: Atualização
                            atualizado_por: localStorage.getItem('sop_user_name') || 'Usuário Desconhecido',
                            ultima_atualizacao: new Date().toISOString()
                        };

                        const btn = document.getElementById('btn-atualizar');
                        btn.innerHTML = "SALVANDO...";
                        btn.disabled = true;

                        const { error } = await sbClient
                            .from('processos')
                            .update(updates)
                            .eq('id', idUnico);

                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-check-lg"></i> SALVAR ALTERAÇÕES';

                        if (error) {
                            alert("Erro ao atualizar: " + error.message);
                        } else {
                            const msg = document.getElementById('msg-detalhes');
                            msg.style.display = 'block';
                            msg.className = 'alert alert-success';
                            msg.innerHTML = '✅ Dados atualizados!';
                            setTimeout(() => {
                                msg.style.display = 'none';
                                bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();
                                carregarDadosSupabase();
                            }, 1000);
                        }
                    }
                }



                // --- FUNÇÕES AUXILIARES RECUPERADAS ---
                function renderLastUpdate() {
                    const el = document.getElementById("lastUpdateInfo");
                    if (el) {
                        const now = new Date();
                        const str = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
                        el.textContent = `Última atualização: ${str}`;
                    }
                }

                function updateDashboard() {
                    if (typeof updateReuniao === 'function') updateReuniao();
                    if (typeof updateFinanceiro === 'function') updateFinanceiro();
                    if (typeof updateGerencial === 'function') updateGerencial();
                    if (typeof updatePrazos === 'function') updatePrazos();
                }

                // --- 6. EVENT LISTENERS E MÁSCARAS ---
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('[DEBUG] === DOMContentLoaded iniciado ===');
                    console.log('[DEBUG] Usuário:', localStorage.getItem('sop_user') || 'nenhum');
                    console.log('[DEBUG] Role:', localStorage.getItem('sop_role') || 'nenhum');
                    const landing = document.getElementById('landingOverlay');
                    console.log('[DEBUG] Landing display:', landing ? landing.style.display || 'padrão' : 'não encontrado');

                    // Carrega dados automaticamente
                    console.log('[DEBUG] Executando carregarDadosSupabase()...');
                    carregarDadosSupabase();

                    // Carrega lista de fiscais/usuários do Banco
                    carregarListaFiscais();

                    document.querySelectorAll('.mask-date').forEach(input => {
                        input.addEventListener('input', function (e) {
                            let v = e.target.value.replace(/\D/g, "");
                            if (v.length > 8) v = v.substring(0, 8);
                            if (v.length >= 5) { v = v.replace(/^(\d{2})(\d{2})(\d+)/, "$1/$2/$3"); }
                            else if (v.length >= 3) { v = v.replace(/^(\d{2})(\d+)/, "$1/$2"); }
                            e.target.value = v;
                        });
                    });

                    document.querySelectorAll('.mask-money').forEach(input => {
                        input.addEventListener('input', e => {
                            let v = e.target.value.replace(/\D/g, '');
                            if (v === "") {
                                e.target.value = "";
                                const prefix = e.target.id.startsWith('det_') ? 'det' : 'cad';
                                calcularRepercussao(prefix);
                                return;
                            }
                            v = (parseInt(v) / 100).toFixed(2).replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                            if (e.target.id.toLowerCase().includes('supres') && v !== "0,00") { v = "-" + v; }
                            e.target.value = v;
                            if (e.target.id.startsWith('det_')) calcularRepercussao('det'); else calcularRepercussao('cad');
                        });
                    });

                    wireEvents();
                    verificarAdminSalvo();
                    carregarOrcamentos();
                });

                function parseMoneyInput(val) { if (!val) return 0; return parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0; }
                function formatMoneyInput(val) { return val.toLocaleString('pt-BR', { minimumFractionDigits: 2 }); }

                function calcularRepercussao(prefix) {
                    const idA = prefix === 'cad' ? 'acresc' : 'det_acresc';
                    const idS = prefix === 'cad' ? 'supres' : 'det_supress';
                    const idR = prefix === 'cad' ? 'reperc' : 'det_reperc';

                    const elAf = document.getElementById(idA + '_fisc') || document.getElementById(idA + '_f');
                    const elSf = document.getElementById(idS + '_fisc') || document.getElementById(idS + '_f');
                    const elRf = document.getElementById(idR + '_fisc') || document.getElementById(idR + '_f');
                    let af = elAf ? parseMoneyInput(elAf.value) : 0;
                    let sf = elSf ? parseMoneyInput(elSf.value) : 0;
                    if (elRf) elRf.value = formatMoneyInput(Math.abs(af) - Math.abs(sf));

                    const elAg = document.getElementById(idA + '_gec') || document.getElementById(idA + '_g');
                    const elSg = document.getElementById(idS + '_gec') || document.getElementById(idS + '_g');
                    const elRg = document.getElementById(idR + '_gec') || document.getElementById(idR + '_g');
                    let ag = elAg ? parseMoneyInput(elAg.value) : 0;
                    let sg = elSg ? parseMoneyInput(elSg.value) : 0;
                    if (elRg) elRg.value = formatMoneyInput(Math.abs(ag) - Math.abs(sg));
                }

                function calcularDiasDevolucao() {
                    const input = document.getElementById('det_data_devolucao');
                    const badge = document.getElementById('det_badge_dias_dev');
                    if (!input || !badge) return;
                    const val = input.value;
                    if (!val || val.length < 10) { badge.textContent = ""; return; }
                    const parts = val.split('/');
                    if (parts.length === 3) {
                        const dataDev = new Date(parts[2], parts[1] - 1, parts[0]);
                        if (!isNaN(dataDev.getTime())) {
                            const hoje = new Date();
                            dataDev.setHours(0, 0, 0, 0); hoje.setHours(0, 0, 0, 0);
                            const diffTime = Math.abs(hoje - dataDev);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            badge.textContent = diffDays + " dias";
                        } else { badge.textContent = "Erro"; }
                    }
                }

                // --- LÓGICA DE INTERFACE ---
                function getSelectedValues(selectEl) {
                    if (!selectEl) return [];
                    if (selectEl.multiple) { return Array.from(selectEl.options).filter(opt => opt.selected).map(opt => opt.value); }
                    return selectEl.value ? [selectEl.value] : [];
                }

                function renderMultiSelectUI(selectEl) {
                    const id = selectEl.id;
                    const containerId = `ms-container-${id}`;
                    let container = document.getElementById(containerId);

                    if (!container) {
                        selectEl.style.display = 'none';
                        selectEl.multiple = true;
                        container = document.createElement('div');
                        container.id = containerId;
                        container.className = 'dropdown multiselect-container';

                        const btn = document.createElement('button');
                        btn.className = 'multiselect-btn';
                        btn.type = 'button';
                        btn.setAttribute('data-bs-toggle', 'dropdown');
                        btn.setAttribute('aria-expanded', 'false');
                        btn.innerHTML = '<span class="text-truncate">Todos</span>';

                        const menu = document.createElement('div');
                        menu.className = 'dropdown-menu multiselect-dropdown';

                        let searchBuffer = ""; let searchTimer = null;
                        btn.addEventListener('keydown', (e) => {
                            if (e.key.length !== 1 || e.ctrlKey || e.altKey || e.metaKey) return;
                            if (!btn.classList.contains('show')) return;
                            clearTimeout(searchTimer);
                            searchBuffer += e.key;
                            searchTimer = setTimeout(() => { searchBuffer = ""; }, 1000);
                            const term = searchBuffer.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                            const options = Array.from(menu.querySelectorAll('.multiselect-option'));
                            const match = options.find(opt => {
                                const text = opt.textContent.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                                return text.startsWith(term);
                            });
                            if (match) {
                                match.scrollIntoView({ block: 'nearest' });
                                const originalBg = match.style.backgroundColor;
                                match.style.backgroundColor = '#e2e6ea';
                                setTimeout(() => { match.style.backgroundColor = originalBg; }, 1500);
                            }
                        });

                        container.appendChild(btn);
                        container.appendChild(menu);
                        selectEl.parentNode.insertBefore(container, selectEl.nextSibling);
                    }

                    const btnSpan = container.querySelector('button span');
                    const menu = container.querySelector('.dropdown-menu');
                    menu.innerHTML = '';

                    Array.from(selectEl.options).forEach(opt => {
                        if (!opt.value) return;
                        const div = document.createElement('div');
                        div.className = 'multiselect-option';
                        div.style.padding = "6px 12px";
                        div.onclick = (e) => {
                            e.stopPropagation();
                            const chk = div.querySelector('input');
                            if (e.target !== chk) chk.checked = !chk.checked;
                            opt.selected = chk.checked;
                            updateLabel();
                            selectEl.dispatchEvent(new Event('change'));
                        };
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = opt.selected;
                        checkbox.style.cursor = "pointer";
                        const label = document.createElement('span');
                        label.textContent = opt.text;
                        label.style.marginLeft = "8px";
                        label.style.userSelect = "none";
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        menu.appendChild(div);
                    });

                    function updateLabel() {
                        const selecteds = Array.from(selectEl.options).filter(o => o.selected && o.value);
                        const totalOpts = Array.from(selectEl.options).length - 1;
                        if (selecteds.length === 0 || selecteds.length === totalOpts) {
                            btnSpan.textContent = 'Todos'; btnSpan.style.color = '#777'; btnSpan.style.fontWeight = '400';
                        } else if (selecteds.length === 1) {
                            btnSpan.textContent = selecteds[0].text; btnSpan.style.color = '#333'; btnSpan.style.fontWeight = '400';
                        } else {
                            btnSpan.textContent = `${selecteds.length} selecionados`; btnSpan.style.color = '#008F3D'; btnSpan.style.fontWeight = '600';
                        }
                    }
                    updateLabel();
                }

                function fillSelect(selectEl, list) {
                    if (!selectEl) return;
                    const values = Array.from(new Set(list)).filter(v => v !== null && v !== undefined && String(v).trim() !== "");
                    values.sort((a, b) => String(a).localeCompare(String(b), 'pt-BR'));
                    let options = '<option value="">Todos</option>';
                    options += values.map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join("");
                    selectEl.innerHTML = options;
                    renderMultiSelectUI(selectEl);
                }

                // LOGIC: DASHBOARDS
                const fin = { status: document.getElementById("filter-status"), tipo: document.getElementById("filter-tipo"), fiscal: document.getElementById("filter-fiscal"), contratada: document.getElementById("filter-contratada"), contratante: document.getElementById("filter-contratante"), ano: document.getElementById("filter-ano"), clear: document.getElementById("btn-clear-filters"), totAno: document.getElementById("tot-ano"), totMes: document.getElementById("tot-mes"), diffMetric: document.getElementById("metric-diff") };
                function populateFinanceiroFilters() {
                    fillSelect(fin.status, allData.map(d => d.status)); fillSelect(fin.tipo, allData.map(d => d.tipo)); fillSelect(fin.fiscal, allData.map(d => d.fiscal)); fillSelect(fin.contratada, allData.map(d => d.contratada)); fillSelect(fin.contratante, allData.map(d => d.contratante));
                    const anos = Array.from(new Set(allData.map(d => d.anoAbertura).filter(v => v))); fillSelect(fin.ano, anos);
                    fin.totAno.innerHTML = '<option value="">Ano: Todos</option>' + anos.map(a => `<option value="${a}">${a}</option>`).join("");
                }
                function getFinanceiroData() {
                    const sts = getSelectedValues(fin.status); const tps = getSelectedValues(fin.tipo); const fis = getSelectedValues(fin.fiscal);
                    const cts = getSelectedValues(fin.contratada); const crs = getSelectedValues(fin.contratante); const ans = getSelectedValues(fin.ano);
                    return allData.filter(d => {
                        if (sts.length > 0 && !sts.includes(d.status)) return false;
                        if (tps.length > 0 && !tps.includes(d.tipo)) return false;
                        if (fis.length > 0 && !fis.includes(d.fiscal)) return false;
                        if (cts.length > 0 && !cts.includes(d.contratada)) return false;
                        if (crs.length > 0 && !crs.includes(d.contratante)) return false;
                        if (ans.length > 0 && !ans.includes(String(d.anoAbertura))) return false;
                        return true;
                    });
                }
                function clearFinanceiro() {
                    [fin.status, fin.tipo, fin.fiscal, fin.contratada, fin.contratante, fin.ano].forEach(el => { if (el) { Array.from(el.options).forEach(o => o.selected = false); renderMultiSelectUI(el); } });
                    updateFinanceiro();
                }
                function clearGerencial() {
                    [ger.fiscal, ger.status].forEach(el => {
                        if (el) {
                            Array.from(el.options).forEach(o => o.selected = false);
                            renderMultiSelectUI(el);
                        }
                    });
                    updateGerencial();
                }
                function clearPrazos() {
                    [pr.fiscal, pr.status].forEach(el => {
                        if (el) {
                            Array.from(el.options).forEach(o => o.selected = false);
                            renderMultiSelectUI(el);
                        }
                    });
                    updatePrazos();
                }
                function applyPeriodo(rows, ano, mes) {
                    if (!ano && !mes) return rows;
                    return rows.filter(d => {
                        const dAno = String(d.anoAbertura || ""); const dMes = String(d.mesAbertura || "");
                        const matchAno = !ano || dAno === ano; const matchMes = !mes || dMes === mes;
                        return matchAno && matchMes;
                    });
                }
                function renderKPIsFinanceiro(rows) {
                    const acrescFiscal = sum(rows, d => d.acrescFiscal); const supressFiscal = sum(rows, d => d.supressFiscal); const repercFiscal = sum(rows, d => d.repercFiscal);
                    const acrescGecope = sum(rows, d => d.acrescGecope); const supressGecope = sum(rows, d => d.supressGecope); const repercGecope = sum(rows, d => d.repercGecope);
                    const diffReperc = repercGecope - repercFiscal; const diffAcresc = acrescGecope - acrescFiscal; const diffSupress = supressGecope - supressFiscal;
                    let diffAbs = 0; let diffPerc = 0; const metric = fin.diffMetric.value;
                    if (metric === "reperc") { diffAbs = diffReperc; diffPerc = (repercFiscal !== 0) ? (Math.abs(diffAbs) / Math.abs(repercFiscal)) * 100 : 0; }
                    else if (metric === "acresc") { diffAbs = diffAcresc; diffPerc = (acrescFiscal !== 0) ? (Math.abs(diffAbs) / Math.abs(acrescFiscal)) * 100 : 0; }
                    else if (metric === "supress") { diffAbs = diffSupress; diffPerc = (supressFiscal !== 0) ? (Math.abs(diffAbs) / Math.abs(supressFiscal)) * 100 : 0; }
                    document.getElementById("kpi-acresc-fiscal").textContent = formatCompact(acrescFiscal); document.getElementById("kpi-supress-fiscal").textContent = formatCompact(supressFiscal); document.getElementById("kpi-reperc-fiscal").textContent = formatCompact(repercFiscal);
                    document.getElementById("kpi-acresc-gecope").textContent = formatCompact(acrescGecope); document.getElementById("kpi-supress-gecope").textContent = formatCompact(supressGecope); document.getElementById("kpi-reperc-gecope").textContent = formatCompact(repercGecope);
                    document.getElementById("kpi-diff-abs").textContent = formatCompact(diffAbs); document.getElementById("kpi-diff-perc").textContent = formatPercentage(diffPerc);
                }
                function renderTotaisFinanceiro(rows) {
                    const base = applyPeriodo(rows, fin.totAno.value, fin.totMes.value);
                    const render = (id, v1, v2, tit) => {
                        const vs = [v1, v2]; const tp = vs.map(v => v >= 0 ? "outside" : "inside");
                        const data = [{ x: ["Fiscalização", "GECOPE"], y: vs, type: "bar", marker: { color: ["#008F3D", "#018ABD"] }, text: vs.map(v => formatCompact(v)), textposition: tp, insidetextanchor: "end", textfont: { size: 11 }, cliponaxis: false, hovertemplate: "%{x}: R$ %{y:,.2f}<extra></extra>" }];
                        const layout = { margin: { l: 95, r: 10, t: 10, b: 70 }, yaxis: { title: tit, tickprefix: "R$ ", separatethousands: true, automargin: true }, xaxis: { automargin: true, tickfont: { size: 11 } } };
                        Plotly.react(document.getElementById(id), data, layout, { displayModeBar: false, responsive: true });
                    };
                    render("chart-acresc-total", sum(base, d => d.acrescFiscal), sum(base, d => d.acrescGecope), "Acréscimo");
                    render("chart-supress-total", sum(base, d => d.supressFiscal), sum(base, d => d.supressGecope), "Supressão");
                    render("chart-reperc-total", sum(base, d => d.repercFiscal), sum(base, d => d.repercGecope), "Repercussão");
                }
                function updateFinanceiro() { const rows = getFinanceiroData(); renderKPIsFinanceiro(rows); renderTotaisFinanceiro(rows); }

                const groupCount = (rows, kFn) => { const c = {}; rows.forEach(r => { const k = kFn(r); c[k] = (c[k] || 0) + 1; }); return Object.keys(c).map(k => ({ key: k, value: c[k] })); };
                const groupAvg = (rows, kFn, vFn) => { const s = {}, c = {}; rows.forEach(r => { const k = kFn(r), v = vFn(r); if (isFiniteNumber(v)) { s[k] = (s[k] || 0) + v; c[k] = (c[k] || 0) + 1; } }); return Object.keys(s).map(k => ({ key: k, value: c[k] > 0 ? s[k] / c[k] : 0 })).filter(d => d.value > 0); };
                const topN = (g, n) => g.sort((a, b) => b.value - a.value).slice(0, n);
                const quantile = (arr, q) => { const p = (arr.length - 1) * q, b = Math.floor(p), r = p - b; return arr[b + 1] !== undefined ? arr[b] + r * (arr[b + 1] - arr[b]) : arr[b]; };
                const renderHBar = (id, g, tx) => {
                    if (!g.length) { Plotly.react(document.getElementById(id), [], { title: "Sem dados" }); return; }
                    const y = g.map(r => r.key).reverse(), x = g.map(r => r.value).reverse();
                    Plotly.react(document.getElementById(id), [{ x, y, type: 'bar', orientation: 'h', text: x.map(v => v.toFixed(0)), textposition: 'outside', marker: { color: "#018ABD" } }], { margin: { l: 180, r: 20, t: 10, b: 40 }, xaxis: { title: tx }, yaxis: { automargin: true }, height: Math.max(300, 26 * y.length + 80) }, { displayModeBar: false });
                };

                const ger = { fiscal: document.getElementById("gerencial-filter-fiscal"), status: document.getElementById("gerencial-filter-status"), clear: document.getElementById("btn-gerencial-clear") };
                let gerBase = [];
                function updateGerencialFilters(rows) { gerBase = rows; fillSelect(ger.fiscal, gerBase.map(d => d.fiscal)); fillSelect(ger.status, gerBase.map(d => d.status)); updateGerencial(); }
                function getGerencialData() { const f = getSelectedValues(ger.fiscal); const s = getSelectedValues(ger.status); return gerBase.filter(d => (f.length === 0 || f.includes(d.fiscal)) && (s.length === 0 || s.includes(d.status))); }
                function updateGerencial() {
                    const rows = getGerencialData();
                    document.getElementById("gerencial-count-badge").textContent = `${rows.length} processos`;
                    renderHBar("chart_proc_por_fiscal", topN(groupCount(rows, d => d.fiscal), 20), "Qtd");
                    const pieD = groupCount(rows, d => d.status).sort((a, b) => b.value - a.value);
                    Plotly.react(document.getElementById("chart_proc_por_status"), [{ type: "pie", labels: pieD.map(d => d.key), values: pieD.map(d => d.value), textinfo: "percent+label", marker: { colors: ['#008F3D', '#F28C00', '#018ABD', '#4CC17C', '#D35400'] } }], { margin: { l: 20, r: 20, t: 10, b: 10 }, height: 360 }, { displayModeBar: false });
                    renderHBar("chart_proc_por_tipo", topN(groupCount(rows, d => d.tipo), 20), "Qtd");
                }

                const pr = { fiscal: document.getElementById("prazos-filter-fiscal"), status: document.getElementById("prazos-filter-status"), clear: document.getElementById("btn-prazos-clear") };
                let przBase = [];
                function updatePrazosFilters(rows) { przBase = rows; fillSelect(pr.fiscal, przBase.map(d => d.fiscal)); fillSelect(pr.status, przBase.map(d => d.status)); updatePrazos(); }
                function getPrazosData() { const f = getSelectedValues(pr.fiscal); const s = getSelectedValues(pr.status); return przBase.filter(d => (f.length === 0 || f.includes(d.fiscal)) && (s.length === 0 || s.includes(d.status))); }
                function updatePrazos() {
                    const rows = getPrazosData();
                    const aprov = rows.filter(d => String(d.status).toUpperCase().includes("APROVADO") && isFinite(d.prazoDias));
                    const dias = aprov.map(d => d.prazoDias).sort((a, b) => a - b);
                    document.getElementById("kpi-aprovados_qtd").textContent = String(aprov.length);
                    document.getElementById("kpi-tempo_medio").textContent = dias.length ? Math.round(dias.reduce((a, b) => a + b, 0) / dias.length) : "–";
                    document.getElementById("kpi-tempo_mediana").textContent = dias.length ? Math.round(quantile(dias, 0.5)) : "–";
                    document.getElementById("kpi-tempo_p90").textContent = dias.length ? Math.round(quantile(dias, 0.9)) : "–";
                    renderHBar("chart_tempo_por_fiscal", topN(groupAvg(aprov, d => d.fiscal, d => d.prazoDias), 20), "Dias (média)");
                    renderHBar("chart_tempo_por_tipo", topN(groupAvg(aprov, d => d.tipo, d => d.prazoDias), 20), "Dias (média)");
                }

                // LOGIC: REUNIÃO
                const mt = { meta: document.getElementById("meetingMetaSelect"), prioritario: document.getElementById("meetingPrioritarioSelect"), fiscal: document.getElementById("meetingFiscalSelect"), status: document.getElementById("meetingStatusSelect"), search: document.getElementById("meetingSearch"), body: document.getElementById("meetingTableBody"), note: document.getElementById("meetingFooterNote") };
                let mtBase = [];
                function getMetaDate(row, setD) {
                    const key = `meta:${row.processo}`;
                    if (setD !== undefined) { if (!setD) localStorage.removeItem(key); else localStorage.setItem(key, setD.toISOString().substring(0, 10)); row.dataCompromissoFiscal = setD; return setD; }
                    if (row.dataCompromissoFiscal instanceof Date) return row.dataCompromissoFiscal;
                    const ls = localStorage.getItem(key); if (ls) { const d = isoParaDate(ls); if (d) { row.dataCompromissoFiscal = d; return d; } }
                    return null;
                }
                function getMetaSt(row) {
                    const md = getMetaDate(row), st = (row.status || "").toUpperCase();
                    if (st.includes("APROVADO")) return "Cumprido";
                    if (!md) return "Sem meta";
                    return md.setHours(0, 0, 0, 0) < new Date().setHours(0, 0, 0, 0) ? "Atrasado" : "No prazo";
                }
                function statusPriority(status) {
                    const raw = (status || "").toString().toUpperCase().trim();
                    const s = raw.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    if (s.includes("AGUAR") && s.includes("REAN")) return 1;
                    if (s.includes("EM REAN") || (s.startsWith("EM") && s.includes("REAN"))) return 2;
                    if (s.includes("AGUAR") && s.includes("ANALIS") && !s.includes("FISCAL") && !s.includes("REAN")) return 3;
                    if ((s.includes("EM ANALIS") || s === "ANALISE") && !s.includes("FISCAL") && !s.includes("REAN")) return 4;
                    if (s.includes("AGUAR") && s.includes("APROVA")) return 5;
                    if (s.includes("FISCAL") && s.includes("ANALIS") && !s.includes("DEVOLVIDO")) return 6;
                    if (s.includes("DEVOLVIDO")) return 7;
                    if (s.includes("CONTRATANTE")) return 8;
                    if (s === "APROVADO" || (s.includes("APROVADO") && !s.includes("AGUAR"))) return 9;
                    if (s.includes("ARQUIVADO")) return 10;
                    return 99;
                }

                // Funções para gerenciar processos prioritários (marcador simples)
                function isPrioritario(row) {
                    const key = `prioritario:${row.processo}`;
                    return localStorage.getItem(key) === 'true';
                }
                function setPrioritario(processo, isPriority) {
                    const key = `prioritario:${processo}`;
                    if (isPriority) {
                        localStorage.setItem(key, 'true');
                    } else {
                        localStorage.removeItem(key);
                    }
                }

                let currentSort = { col: null, dir: 'asc' };
                function changeSort(columnKey) {
                    if (currentSort.col === columnKey) { currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc'; }
                    else { currentSort.col = columnKey; currentSort.dir = 'asc'; }
                    updateReuniao();
                }
                function getSortIcon(columnKey) {
                    if (currentSort.col !== columnKey) { return '<i class="bi bi-arrow-down-up text-secondary ms-1" style="font-size: 1rem; opacity: 0.4;"></i>'; }
                    return currentSort.dir === 'asc' ? '<i class="bi bi-sort-down-alt text-success ms-1" style="font-size: 1.1rem;"></i>' : '<i class="bi bi-sort-up text-success ms-1" style="font-size: 1.1rem;"></i>';
                }
                function updateReuniaoFilters(rows) { mtBase = rows; updateReuniao(); }

                function updateReuniao() {
                    if (!mt.body) return;
                    const uRole = (localStorage.getItem('sop_role') || "").toLowerCase();

                    // Prioriza sop_fiscal_name (derivado do email) sobre sop_user_name
                    let uName = (localStorage.getItem('sop_fiscal_name') || localStorage.getItem('sop_user_name') || "").toUpperCase().trim();

                    const fs = Array.from(new Set(mtBase.map(d => d.fiscal).filter(Boolean))).sort((a, b) => a.localeCompare(b, 'pt-BR'));
                    if (mt.fiscal.options.length <= 1) fillSelect(mt.fiscal, fs);
                    let rows = mtBase.slice();

                    if (uRole === 'fiscal') {
                        // Filtragem robusta para fiscal com normalização de pontos/hífens
                        const nameParts = uName.trim().split(/[\s\.\-]+/).filter(p => p.length > 0);
                        console.log('[DEBUG-updateReuniao] Fiscal:', uName, 'Parts:', nameParts);

                        rows = rows.filter(d => {
                            const dFiscal = (d.fiscal || "").toUpperCase().trim();
                            // Normaliza o fiscal (remove pontos, hífens, mantém espaços)
                            const dFiscalNormalizado = dFiscal.replace(/[\.\-]+/g, ' ').trim();

                            // Comparação exata
                            if (dFiscalNormalizado === uName) {
                                console.log('[DEBUG-updateReuniao] MATCH EXATO:', dFiscal, '->', dFiscalNormalizado);
                                return true;
                            }

                            // Verifica se todas as palavras do nome derivado aparecem no fiscal normalizado
                            if (nameParts.every(part => dFiscalNormalizado.includes(part))) {
                                console.log('[DEBUG-updateReuniao] MATCH PALAVRAS:', dFiscal, '->', dFiscalNormalizado);
                                return true;
                            }

                            // Verifica se todas as palavras do fiscal aparecem no nome do usuário
                            const dFiscalParts = dFiscalNormalizado.split(/\s+/).filter(p => p.length > 0);
                            if (dFiscalParts.every(part => uName.includes(part))) {
                                console.log('[DEBUG-updateReuniao] MATCH REVERSO:', dFiscal, '->', dFiscalNormalizado);
                                return true;
                            }

                            return false;
                        });
                        console.log('[DEBUG-updateReuniao] Total de processos após filtro:', rows.length);
                        // Ocultar seletor de fiscal para fiscais
                        if (mt.fiscal && mt.fiscal.closest('.col-md-3')) {
                            mt.fiscal.closest('.col-md-3').style.display = 'none';
                        }
                    } else {
                        // Garantir que reapareça se trocar de papel (raro mas bom pra debug)
                        if (mt.fiscal && mt.fiscal.closest('.col-md-3')) {
                            mt.fiscal.closest('.col-md-3').style.display = '';
                        }
                    }

                    const f = getSelectedValues(mt.fiscal).filter(v => v !== "");
                    const s = getSelectedValues(mt.status).filter(v => v !== "");
                    const m = getSelectedValues(mt.meta).filter(v => v !== "");
                    const priorFilt = getSelectedValues(mt.prioritario).filter(v => v !== "");
                    const q = mt.search.value.toLowerCase();

                    if (uRole !== 'fiscal' && f.length > 0) rows = rows.filter(d => f.includes(d.fiscal));
                    if (s.length > 0) rows = rows.filter(d => s.includes(d.status));
                    if (m.length > 0) rows = rows.filter(d => m.includes(getMetaSt(d)));
                    if (priorFilt.length > 0) rows = rows.filter(d => priorFilt.includes(isPrioritario(d) ? "Sim" : "Não"));
                    if (q) {
                        rows = rows.filter(d => {
                            const proc = (d.processo || "").toLowerCase(); const contrat = (d.contratante || "").toLowerCase(); const desc = (d.descricao || "").toLowerCase(); const analistaNome = (d.nomeAnalista || "").toLowerCase();
                            return proc.includes(q) || contrat.includes(q) || (d.contratada || "").toLowerCase().includes(q) || desc.includes(q) || analistaNome.includes(q);
                        });
                    }
                    document.getElementById("meetingFooterNote").textContent = `Exibindo ${rows.length} processos`;
                    document.getElementById("card_proc_total").textContent = rows.length;
                    const aprovadosCount = rows.filter(d => (d.status || "").toUpperCase().includes("APROVADO")).length;
                    document.getElementById("card_proc_aprovados").textContent = aprovadosCount;
                    document.getElementById("card_proc_andamento").textContent = rows.length - aprovadosCount;
                    const maxDias = rows.length > 0 ? Math.max(...rows.map(d => { if (d.dataAbertura instanceof Date) return Math.floor((new Date() - d.dataAbertura) / (1000 * 60 * 60 * 24)); return 0; })) : 0;
                    document.getElementById("card_proc_dias").textContent = maxDias;

                    const columns = [
                        { title: "Ações", width: "50px", key: null, align: "center" }, { title: "Prioritário", width: "80px", key: null, align: "center" }, { title: "Processo", width: "200px", key: "processo", align: "start" }, { title: "Meta", width: "100px", key: "meta", align: "start" },
                        { title: "Status", width: "146px", key: "status", align: "start" }, { title: "Analista", width: "100px", key: "analista", align: "center" }, { title: "Abertura", width: "100px", key: "abertura", align: "center" },
                        { title: "Dias", width: "100px", key: "dias", align: "center" }, { title: "Contratante", width: "100px", key: "contratante", align: "start" }, { title: "Contratada", width: "100px", key: "contratada", align: "start" }, { title: "Descrição", width: "auto", key: "descricao", align: "start" }
                    ];
                    const thead = document.querySelector("#pane-reuniao table thead");
                    let headerHTML = "<tr>";
                    columns.forEach(col => {
                        if (col.key) { headerHTML += `<th style="width: ${col.width}; cursor: pointer; user-select: none;" onclick="changeSort('${col.key}')" class="text-${col.align}"><div class="d-flex align-items-center justify-content-${col.align === 'center' ? 'center' : 'start'}">${col.title} ${getSortIcon(col.key)}</div></th>`; }
                        else { headerHTML += `<th class="text-${col.align}" style="width: ${col.width};">${col.title}</th>`; }
                    });
                    headerHTML += "</tr>";
                    thead.innerHTML = headerHTML;

                    rows.sort((a, b) => {
                        if (!currentSort.col) {
                            const pA = statusPriority(a.status), pB = statusPriority(b.status);
                            if (pA !== pB) return pA - pB;
                            const dA = a.dataAbertura instanceof Date ? a.dataAbertura.getTime() : 8640000000000000;
                            const dB = b.dataAbertura instanceof Date ? b.dataAbertura.getTime() : 8640000000000000;
                            return dA - dB;
                        }
                        let valA, valB;
                        switch (currentSort.col) {
                            case 'processo': valA = a.processo || ""; valB = b.processo || ""; break;
                            case 'meta': const mA = getMetaDate(a); const mB = getMetaDate(b); valA = mA ? mA.getTime() : 0; valB = mB ? mB.getTime() : 0; break;
                            case 'status': valA = (a.status || "").toLowerCase(); valB = (b.status || "").toLowerCase(); break;
                            case 'analista': valA = (a.analista || "").toString(); valB = (b.analista || "").toString(); break;
                            case 'abertura': valA = a.dataAbertura instanceof Date ? a.dataAbertura.getTime() : 0; valB = b.dataAbertura instanceof Date ? b.dataAbertura.getTime() : 0; break;
                            case 'dias': valA = a.dataAbertura instanceof Date ? (new Date() - a.dataAbertura) : -1; valB = b.dataAbertura instanceof Date ? (new Date() - b.dataAbertura) : -1; break;
                            case 'contratante': valA = (a.contratante || "").toLowerCase(); valB = (b.contratante || "").toLowerCase(); break;
                            case 'contratada': valA = (a.contratada || "").toLowerCase(); valB = (b.contratada || "").toLowerCase(); break;
                            case 'descricao': valA = (a.descricao || "").toLowerCase(); valB = (b.descricao || "").toLowerCase(); break;
                            default: return 0;
                        }
                        if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1; if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1; return 0;
                    });

                    mt.body.innerHTML = rows.map(d => {
                        const mIso = getMetaDate(d)?.toISOString().substring(0, 10) || ""; const mSt = getMetaSt(d);
                        let mCls = "badge-meta-sem";
                        if (mSt === "Cumprido") mCls = "badge-meta-cumprido"; else if (mSt === "No prazo") mCls = "badge-meta-prazo"; else if (mSt === "Atrasado") mCls = "badge-meta-atrasado";
                        const stTxt = (d.status || "").toString().toUpperCase().trim();
                        let stCls = "text-bg-light";
                        if (stTxt.includes("DEVOLVIDO")) { stCls = "badge-status-devolvido"; }
                        else if (stTxt.includes("CONTRATANTE")) { stCls = "badge-status-contratante"; }
                        else if (stTxt.includes("APROVAÇÃO")) { stCls = "badge-status-dark-blue"; }
                        else if (stTxt.includes("FISCAL") && (stTxt.includes("ANÁLISE") || stTxt.includes("ANALISE"))) { stCls = "badge-status-fiscal"; }
                        else if (stTxt.includes("AGUAR")) { if (stTxt.includes("REAN")) { stCls = "badge-status-aguar-reanalise"; } else { stCls = "badge-status-light-blue"; } }
                        else if (stTxt.startsWith("EM") && stTxt.includes("REANÁLISE")) { stCls = "badge-status-em-reanalise"; }
                        else if (stTxt.startsWith("EM") && (stTxt.includes("ANÁLISE") || stTxt.includes("ANALISE"))) { stCls = "badge-status-em-analise"; }
                        else if (stTxt.includes("APROVADO") || stTxt === "SEDUC") { stCls = "badge-status-aprovado"; }

                        const abert = dateParaInput(d.dataAbertura);
                        const dias = (d.dataAbertura instanceof Date) ? Math.floor((new Date() - d.dataAbertura) / (1000 * 60 * 60 * 24)) : "";
                        const fiscalNome = (d.fiscal || "").toUpperCase();
                        return `
        <tr style="vertical-align: middle;">
            <td class="text-center">${uRole !== 'fiscal' ? `<button class="btn btn-sm btn-light border" onclick="abrirDetalhes('${escapeHTML(d.processo)}')" title="Ver detalhes"><i class="bi bi-eye-fill" style="color: var(--sop-blue);"></i></button>` : ''}</td>
            <td class="text-center"><input type="checkbox" class="checkbox-prioritario" data-proc="${escapeHTML(d.processo)}" ${isPrioritario(d) ? 'checked' : ''} title="Marcar como prioritário" ${uRole !== 'admin' ? 'disabled' : ''} /></td>
            <td><div style="font-weight: 700; font-size: 0.95rem; color: #000; white-space: nowrap;">${escapeHTML(d.processo)}</div><div class="mt-1 text-muted" style="font-size: 0.75rem; font-weight: 500;"><i class="bi bi-person-fill me-1"></i>${escapeHTML(fiscalNome)}</div></td>
            <td><div class="mb-1"><span class="badge rounded-pill ${mCls}" style="font-size: 0.75rem;">${mSt}</span></div><input type="date" class="form-control form-control-sm" style="font-size: 0.75rem; padding: 2px 4px; height: auto;" data-proc="${escapeHTML(d.processo)}" value="${mIso}" title="Alterar Meta" ${uRole !== 'admin' ? 'disabled' : ''} /></td>
            <td><span class="badge rounded-pill ${stCls} badge-custom-size">${d.status}</span></td>
            <td class="text-center fw-bold text-secondary" style="font-size: 0.8rem;">${d.analista || "-"}</td>
            <td class="text-center" style="font-size: 0.8rem; color: #555;">${abert}</td>
            <td class="text-center fw-bold" style="font-size: 0.8rem;">${dias}</td>
            <td style="font-size: 0.80rem; font-weight: 300;">${escapeHTML(d.contratante)}</td>
            <td style="font-size: 0.80rem; font-weight: 300;">${escapeHTML(d.contratada)}</td>
            <td style="font-size: 0.80rem; color: #333; line-height: 1.3; text-align: justify;">${escapeHTML(d.descricao)}</td>
        </tr>`;
                    }).join("");

                    mt.body.querySelectorAll('input[type="date"]').forEach(i => i.addEventListener('change', (e) => {
                        const novoDate = isoParaDate(e.target.value);
                        const linha = allData.find(d => d.processo === e.target.dataset.proc);
                        if (linha) {
                            getMetaDate(linha, novoDate);
                            updateReuniao();
                        }
                    }));

                    // Event listener para checkboxes de prioritário
                    mt.body.querySelectorAll('.checkbox-prioritario').forEach(checkbox => checkbox.addEventListener('change', (e) => {
                        const processo = e.target.dataset.proc;
                        setPrioritario(processo, e.target.checked);
                        updateReuniao();
                    }));
                }
                function populateAllTabFilters() {
                    populateFinanceiroFilters();
                    fillSelect(ger.status, allData.map(d => d.status)); fillSelect(pr.status, allData.map(d => d.status)); fillSelect(mt.status, allData.map(d => d.status));
                    renderMultiSelectUI(mt.meta);
                    updateGerencialFilters(allData); updatePrazosFilters(allData); updateReuniaoFilters(allData);
                }
                function wireEvents() {
                    fin.status.addEventListener("change", updateFinanceiro); fin.tipo.addEventListener("change", updateFinanceiro); fin.fiscal.addEventListener("change", updateFinanceiro);
                    fin.contratada.addEventListener("change", updateFinanceiro); fin.contratante.addEventListener("change", updateFinanceiro); fin.ano.addEventListener("change", updateFinanceiro);
                    fin.clear.addEventListener("click", (e) => { e.preventDefault(); clearFinanceiro(); });
                    fin.totAno.addEventListener("change", updateFinanceiro); fin.totMes.addEventListener("change", updateFinanceiro); fin.diffMetric.addEventListener("change", updateFinanceiro);
                    ger.fiscal.addEventListener("change", updateGerencial); ger.status.addEventListener("change", updateGerencial);
                    ger.clear.addEventListener("click", (e) => { e.preventDefault(); clearGerencial(); });
                    pr.fiscal.addEventListener("change", updatePrazos); pr.status.addEventListener("change", updatePrazos);
                    pr.clear.addEventListener("click", (e) => { e.preventDefault(); clearPrazos(); });
                    mt.meta.addEventListener("change", updateReuniao); mt.prioritario.addEventListener("change", updateReuniao); mt.fiscal.addEventListener("change", updateReuniao); mt.status.addEventListener("change", updateReuniao);
                    // Debounce no search de reunião
                    mt.search.addEventListener("input", debounce(updateReuniao, 300));

                    document.getElementById("btn-reuniao-clear").addEventListener("click", (e) => {
                        e.preventDefault(); mt.search.value = "";
                        [mt.meta, mt.prioritario, mt.fiscal, mt.status].forEach(el => { Array.from(el.options).forEach(o => o.selected = false); renderMultiSelectUI(el); });
                        currentSort = { col: null, dir: 'asc' }; updateReuniao();
                    });

                    // Listeners de Orçamentos com Debounce
                    const orcSearch = document.getElementById('orcamento-search');
                    if (orcSearch) orcSearch.addEventListener('input', debounce(carregarOrcamentos, 400));

                    // Listeners de Tabelas (BDI/Desconto/Busca) com Debounce
                    document.getElementById('busca-bdi')?.addEventListener('input', debounce(recalcTabela, 300));
                    document.getElementById('busca-desc')?.addEventListener('input', debounce(recalcTabela, 300));

                    document.querySelectorAll('.nav-link').forEach(t => t.addEventListener('shown.bs.tab', (e) => { const p = document.querySelector(e.target.getAttribute('data-bs-target')); if (p) p.querySelectorAll('.chart-placeholder').forEach(c => Plotly.Plots.resize(c)); }));
                }

                /* --------------------------------------------------------------
                   LÓGICA DE ADMINISTRADOR (MANTIDA)
                -------------------------------------------------------------- */
                const SENHA_MESTRA = "sop2026";

                // Usuários simples (para exemplo). Substitua por verificação via Supabase Auth para produção.
                const USERS = [
                    { username: 'admin', password: SENHA_MESTRA, isAdmin: true }
                ];

                function atualizarIconesCadeado(isLocked) {
                    // Atualiza todos os ícones de cadeado da página
                    const icones = document.querySelectorAll('.btn-admin-login i');
                    icones.forEach(icon => {
                        if (isLocked) {
                            icon.className = 'bi bi-lock-fill';
                            icon.style.color = '#ccc';
                        } else {
                            icon.className = 'bi bi-unlock-fill';
                            icon.style.color = 'var(--sop-green)';
                        }
                    });

                    // Lógica de forçar aba removida a pedido do usuário para iniciar sem abas selecionadas
                    /*
                    if (isLocked) {
                        const tabOrcamentos = document.querySelector('[data-bs-target="#pane-orcamentos"]');
                        if (tabOrcamentos) {
                            const tabTrigger = new bootstrap.Tab(tabOrcamentos);
                            tabTrigger.show();
                        }
                    }
                    */
                }

                function verificarAdminSalvo() {
                    const isAdm = localStorage.getItem('is_admin_gecope');
                    if (isAdm === 'true') {
                        document.body.classList.add('is-admin');
                        atualizarIconesCadeado(false);
                    } else {
                        document.body.classList.remove('is-admin');
                        atualizarIconesCadeado(true);
                    }
                }
                function alternarModoAdmin() {
                    if (document.body.classList.contains('is-admin')) {
                        if (confirm("Deseja sair do modo Administrador?")) {
                            document.body.classList.remove('is-admin');
                            localStorage.removeItem('is_admin_gecope');
                            localStorage.removeItem('sop_user');
                            atualizarIconesCadeado(true);
                            alert("Modo de visualização ativado.");
                            if (document.querySelector('.modal.show')) location.reload();
                        }
                        return;
                    }
                    // Abre o modal de login em vez do prompt
                    const modalEl = document.getElementById('modalLogin');
                    if (modalEl) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    } else {
                        // Fallback: prompt com senha mestre
                        const tentativa = prompt("🔒 Digite a senha de administrador:");
                        if (tentativa === SENHA_MESTRA) {
                            document.body.classList.add('is-admin');
                            localStorage.setItem('is_admin_gecope', 'true');
                            atualizarIconesCadeado(false);
                            alert("🔓 Modo Administrador Ativado!");
                        } else if (tentativa !== null) { alert("❌ Senha incorreta."); }
                    }
                }

                function handleLoginSubmit(e) {
                    e.preventDefault();
                    const user = document.getElementById('login-username').value.trim();
                    const pass = document.getElementById('login-password').value;
                    const feedback = document.getElementById('login-feedback');
                    feedback.style.display = 'none';
                    const found = USERS.find(u => u.username === user && u.password === pass);
                    if (found) {
                        document.body.classList.add('is-admin');
                        localStorage.setItem('is_admin_gecope', 'true');
                        localStorage.setItem('sop_user', user);
                        atualizarIconesCadeado(false);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalLogin'));
                        if (modal) modal.hide();
                        alert("🔓 Modo Administrador Ativado!");
                    } else {
                        feedback.style.display = 'block';
                    }
                }

                // Registra o listener do formulário de login (elemento já existe porque o modal foi inserido antes do script)
                document.getElementById('formLogin')?.addEventListener('submit', handleLoginSubmit);

                /* --------------------------------------------------------------
                   FUNÇÕES DE AUTENTICAÇÃO (SUPABASE)
                -------------------------------------------------------------- */

                // Cadastro reformulado: NOME, SOBRENOME, MATRICULA, SENHA
                async function signUpRequest(nome, sobrenome, matricula, senha) {
                    try {
                        const email = `${matricula}@gecope.app`;

                        // 1. Criar usuário no Auth
                        const options = {
                            email: email,
                            password: senha,
                            options: { data: { full_name: `${nome} ${sobrenome}` } }
                        };

                        const { data, error } = await sbClient.auth.signUp(options);

                        if (error) {
                            alert('Erro ao realizar cadastro: ' + error.message);
                            return;
                        }

                        // 2. Criar registro na tabela app_users (com novas colunas)
                        // Obs: Assume-se que a tabela foi ajustada para ter matricula/nome/sobrenome
                        await sbClient.from('app_users').insert([{
                            email: email, // Mantém email para vínculo
                            matricula: matricula,
                            nome: nome,
                            sobrenome: sobrenome,
                            role: 'pending',
                            created_at: new Date().toISOString()
                        }]);

                        await sbClient.from('app_notifications').insert([{ type: 'new_user_request', payload: JSON.stringify({ matricula, nome: `${nome} ${sobrenome}` }), created_at: new Date().toISOString(), read: false }]);

                        alert(`Solicitação enviada para a matrícula ${matricula}.\nAguarde aprovação do Admin!`);
                    } catch (err) { console.error(err); alert('Erro inesperado ao solicitar acesso.'); }
                }

                async function signInWithEmail(email, password) {
                    try {
                        console.log('[DEBUG] signInWithEmail iniciado para:', email);

                        // REMOVIDA VALIDAÇÃO SOP
                        // if (!email.endsWith('@sop.ce.gov.br')) { ... }

                        console.log('[DEBUG] Autenticando com Supabase Auth...');
                        const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

                        if (error) {
                            console.error('[ERRO] Falha Auth:', error.message);
                            document.getElementById('landing-feedback').style.display = 'block';
                            document.getElementById('landing-feedback').textContent = error.message;
                            return;
                        }

                        console.log('[DEBUG] Autenticação bem-sucedida. Buscando perfil no app_users...');
                        // Busca perfil e roles na tabela app_users
                        const profile = await sbClient.from('app_users').select('*').eq('email', email).single();
                        const role = profile.data?.role || 'pending';

                        console.log('[DEBUG] Perfil encontrado:', { email, role });

                        // Salva no localStorage
                        localStorage.setItem('sop_user', email);
                        localStorage.setItem('sop_role', role);

                        // Busca nome completo de forma robusta
                        let finalName = '';
                        if (profile.data) {
                            if (profile.data.full_name && !/^\d+$/.test(profile.data.full_name)) {
                                finalName = profile.data.full_name;
                            } else if (profile.data.nome) {
                                finalName = (profile.data.nome + (profile.data.sobrenome ? ' ' + profile.data.sobrenome : '')).toUpperCase();
                            }
                        }

                        if (finalName) {
                            localStorage.setItem('sop_user_name', finalName);
                        } else {
                            localStorage.removeItem('sop_user_name');
                        }
                        console.log('[DEBUG] Dados salvos em localStorage. Nome:', finalName);

                        applyRoleToUI(role);

                        // Esconde landing
                        const landing = document.getElementById('landingOverlay');
                        if (landing) {
                            landing.style.display = 'none';
                            console.log('[DEBUG] Landing overlay ocultado');
                        }

                        // notifica
                        alert('Bem-vindo: ' + email + '\nPermissão: ' + role);

                        console.log('[DEBUG] Carregando dados após login...');
                        setTimeout(() => carregarDadosSupabase(), 500);
                    } catch (err) {
                        console.error('[ERRO] Exceção em signInWithEmail:', err);
                        document.getElementById('landing-feedback').style.display = 'block';
                        document.getElementById('landing-feedback').textContent = 'Erro ao autenticar: ' + (err.message || err);
                    }
                }

                async function signOutUser() {
                    await sbClient.auth.signOut();
                    localStorage.removeItem('sop_user');
                    localStorage.removeItem('sop_role');
                    localStorage.removeItem('sop_user_name');
                    // Exibe landing novamente
                    const landing = document.getElementById('landingOverlay'); if (landing) landing.style.display = 'flex';
                    // Atualiza UI
                    applyRoleToUI('guest');
                }

                function applyRoleToUI(rawRole) {
                    const role = (rawRole || 'guest').toLowerCase();

                    // Remove role classes
                    document.body.classList.remove('role-admin', 'role-gerente', 'role-fiscal', 'role-externo', 'role-pending', 'is-admin');
                    document.body.classList.add(`role-${role}`);
                    if (role === 'admin') document.body.classList.add('is-admin');

                    // Desativar todas as abas ao entrar/aplicar role (conforme solicitado pelo usuário)
                    document.querySelectorAll('#dashboardTabs .nav-link').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

                    // 1. Visibilidade de Abas por Atributo data-roles
                    document.querySelectorAll('[data-roles]').forEach(el => {
                        const allowed = el.getAttribute('data-roles').split(',');
                        if (allowed.includes(role)) {
                            el.style.setProperty('display', 'block', 'important');
                        } else {
                            el.style.setProperty('display', 'none', 'important');
                        }
                    });

                    // Caso especial: Selecionar a primeira aba visível se a atual sumir
                    const activeTab = document.querySelector('.nav-link.active');
                    if (activeTab && activeTab.closest('li').style.display === 'none') {
                        const firstVisible = document.querySelector('#dashboardTabs li[style*="display: block"] .nav-link');
                        if (firstVisible) firstVisible.click();
                    }

                    // Se for Pending, bloqueia acesso e volta para landing
                    if (role === 'pending') {
                        alert("Sua solicitação de acesso ainda está pendente de aprovação.");
                        signOutUser();
                        return;
                    }

                    // 2. Elementos .admin-only
                    document.querySelectorAll('.admin-only').forEach(el => {
                        if (el.id !== 'btn-nova-comp-analitica') {
                            el.style.display = (role === 'admin' || role === 'gerente') ? '' : 'none';
                        }
                    });

                    // 3. Botões Específicos
                    const btnNovaComp = document.getElementById('btn-nova-comp-analitica');
                    if (btnNovaComp) {
                        btnNovaComp.style.display = (role === 'admin' || role === 'fiscal') ? 'inline-block' : 'none';
                    }

                    // 4. Elementos Hide Fiscal
                    if (role === 'fiscal') {
                        document.querySelectorAll('.hide-fiscal').forEach(el => el.style.display = 'none');
                    }

                    // 5. Atualiza contadores e Admin Dashboard
                    if (role === 'admin') {
                        fetchPendingCount();
                        startNotificationsPoll();
                    } else {
                        const badgeEl = document.getElementById('pending-badge'); if (badgeEl) badgeEl.textContent = '';
                        stopNotificationsPoll();
                    }

                    // 6. Atualiza Header (Sair / Nome Usuário)
                    const userInfoHeader = document.getElementById('user-info-header');
                    if (userInfoHeader) {
                        if (role === 'guest') {
                            userInfoHeader.style.setProperty('display', 'none', 'important');
                        } else {
                            userInfoHeader.style.setProperty('display', 'flex', 'important');
                            const nameEl = document.getElementById('header-user-name');
                            const roleEl = document.getElementById('header-user-role');
                            if (nameEl) nameEl.textContent = localStorage.getItem('sop_user_name') || 'Usuário';
                            if (roleEl) roleEl.textContent = role;
                        }
                    }
                }

                // --- ADMIN DASHBOARD LOGIC ---
                // --- ADMIN DASHBOARD LOGIC (REVISADO) ---
                // --- LÓGICA DO PAINEL ADMINISTRATIVO (USUÁRIOS) ---
                async function loadAllUsers() {
                    const tbodyActive = document.getElementById('admin-users-table-body');
                    const tbodyPending = document.getElementById('admin-pending-table-body');
                    const sectionPending = document.getElementById('admin-pending-section');

                    // Elementos de Estatística
                    const statTotal = document.getElementById('admin-stat-total');
                    const statPending = document.getElementById('admin-stat-pending');
                    const statAdmins = document.getElementById('admin-stat-admins');
                    const statOthers = document.getElementById('admin-stat-others');
                    const pendingTabBadge = document.getElementById('admin-pending-badge-tab');

                    if (!tbodyActive || !tbodyPending) return;

                    tbodyActive.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-2"></div>Carregando usuários...</td></tr>';

                    try {
                        const { data, error } = await sbClient.from('app_users').select('*').order('created_at', { ascending: false });
                        if (error) throw error;

                        const pendings = data.filter(u => u.role === 'pending');
                        const actives = data.filter(u => u.role !== 'pending');

                        // Atualiza Indicadores
                        if (statTotal) statTotal.textContent = data.length;
                        if (statPending) statPending.textContent = pendings.length;
                        if (statAdmins) statAdmins.textContent = data.filter(u => u.role === 'admin').length;
                        if (statOthers) statOthers.textContent = data.filter(u => u.role !== 'admin' && u.role !== 'pending').length;
                        if (pendingTabBadge) pendingTabBadge.textContent = pendings.length;

                        // Exibe seção de pendentes se houver solicitações
                        if (sectionPending) sectionPending.style.display = pendings.length > 0 ? 'block' : 'none';

                        // Renderizar Pendentes
                        tbodyPending.innerHTML = '';
                        pendings.forEach(u => {
                            const dataSolic = u.created_at ? new Date(u.created_at).toLocaleDateString('pt-BR') : 'N/A';
                            const nomeComp = `${(u.nome || '')} ${(u.sobrenome || '')}`.trim() || u.full_name || 'N/A';

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">${nomeComp}</div>
                                    <div class="small text-muted">${u.email}</div>
                                </td>
                                <td><span class="badge bg-light text-dark border fw-normal">${u.matricula || '-'}</span></td>
                                <td><span class="text-muted small">${dataSolic}</span></td>
                                <td class="text-end pe-4">
                                    <div class="d-flex justify-content-end gap-2">
                                        <select class="form-select form-select-sm" style="width: 120px;" id="role-pending-${u.id}">
                                            <option value="externo">EXTERNO</option>
                                            <option value="fiscal">FISCAL</option>
                                            <option value="gerente">GERENTE</option>
                                            <option value="admin">ADMIN</option>
                                        </select>
                                        <button class="btn btn-sm btn-success" onclick="aprovarUsuario('${u.email}', document.getElementById('role-pending-${u.id}').value)">
                                            <i class="bi bi-check-lg me-1"></i> Aprovar
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="excluirUsuario('${u.email}')" title="Recusar">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            tbodyPending.appendChild(tr);
                        });

                        // Renderizar Ativos
                        tbodyActive.innerHTML = '';
                        if (actives.length === 0) {
                            tbodyActive.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Nenhum usuário ativo.</td></tr>';
                        }

                        actives.forEach(u => {
                            const fullNome = `${(u.nome || '')} ${(u.sobrenome || '')}`.trim() || u.full_name || 'Não informado';
                            let roleColor = 'bg-secondary';
                            if (u.role === 'admin') roleColor = 'bg-danger';
                            else if (u.role === 'gerente') roleColor = 'bg-primary';
                            else if (u.role === 'fiscal') roleColor = 'bg-success';
                            else if (u.role === 'externo') roleColor = 'bg-dark';

                            const roles = ['admin', 'gerente', 'fiscal', 'externo'];
                            const optionsHtml = roles.map(r => `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r.toUpperCase()}</option>`).join('');

                            // Se for fiscal, valida se o nome está na FISCAIS_LIST
                            let fiscalInfo = '';
                            if (u.role === 'fiscal' && u.nome) {
                                const nomeCompleto = (u.nome + (u.sobrenome ? ' ' + u.sobrenome : '')).trim();
                                const encontradoNaLista = findFiscalNameInList(nomeCompleto);
                                if (encontradoNaLista) {
                                    fiscalInfo = `<span class="badge bg-info text-dark ms-2" title="Fiscal encontrado na lista">${encontradoNaLista}</span>`;
                                } else {
                                    fiscalInfo = `<span class="badge bg-warning text-dark ms-2" title="Não encontrado na lista">⚠️</span>`;
                                }
                            }

                            const tr = document.createElement('tr');
                            tr.setAttribute('data-search', `${fullNome.toLowerCase()} ${u.matricula} ${u.email.toLowerCase()}`);
                            tr.innerHTML = `
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">${fullNome}</div>
                                </td>
                                <td><div class="small text-muted">${u.email}</div></td>
                                <td><span class="badge bg-light text-dark border fw-normal">${u.matricula || '-'}</span></td>
                                <td>
                                    <span class="badge ${roleColor} rounded-pill px-3" style="font-size: 0.72rem; min-width: 80px;">${u.role.toUpperCase()}</span>
                                    ${fiscalInfo}
                                </td>
                                <td class="text-end pe-4">
                                    <div class="d-flex justify-content-end gap-2">
                                        <select class="form-select form-select-sm border-0 bg-light" style="width:130px;" onchange="updateUserRole('${u.email}', this.value)">
                                            ${optionsHtml}
                                        </select>
                                        <button class="btn btn-sm btn-outline-danger border-0" onclick="excluirUsuario('${u.email}')" title="Excluir Usuário">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            tbodyActive.appendChild(tr);
                        });

                    } catch (e) {
                        console.error('Erro ao listar usuários:', e);
                        tbodyActive.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Erro ao carregar banco de usuários: ${e.message}</td></tr>`;
                    }
                }

                // --- VARIÁVEIS DE CONTROLE PARA VÍNCULO DE FISCAL ---
                let _vincularContext = null;

                document.addEventListener('DOMContentLoaded', () => {
                    const btnConfirmar = document.getElementById('btn-confirmar-vinculo');
                    if (btnConfirmar) {
                        btnConfirmar.addEventListener('click', async () => {
                            if (!_vincularContext) return;

                            const select = document.getElementById('vincular-fiscal-select');
                            const novoNome = select.value;

                            if (!novoNome) {
                                alert("Por favor, selecione um nome da lista.");
                                return;
                            }

                            try {
                                btnConfirmar.disabled = true;
                                btnConfirmar.innerHTML = "Salvando...";

                                // Atualiza nome no banco
                                const partes = novoNome.split(' ');
                                const nome = partes[0];
                                const sobrenome = partes.slice(1).join(' ');

                                const { error } = await sbClient.from('app_users').update({
                                    full_name: novoNome,
                                    nome: nome,
                                    sobrenome: sobrenome
                                }).eq('email', _vincularContext.email);

                                if (error) throw error;

                                // Sucesso na atualização do nome
                                alert(`✅ Usuário vinculado a "${novoNome}" com sucesso!`);

                                // Fecha modal
                                const modalEL = document.getElementById('modalVincularFiscal');
                                const modal = bootstrap.Modal.getInstance(modalEL);
                                modal.hide();

                                // Retoma a ação original (sem confirmação extra)
                                if (_vincularContext.action === 'aprovar') {
                                    aprovarUsuario(_vincularContext.email, _vincularContext.role, true); // true = skipConfirm
                                } else if (_vincularContext.action === 'update') {
                                    updateUserRole(_vincularContext.email, _vincularContext.role, true); // true = skipConfirm
                                }

                            } catch (e) {
                                alert("Erro ao vincular: " + e.message);
                            } finally {
                                btnConfirmar.disabled = false;
                                btnConfirmar.innerHTML = "Confirmar Vínculo";
                            }
                        });
                    }
                });

                function abrirModalVinculo(nomeAtual, email, role, action) {
                    _vincularContext = { email, role, action };
                    document.getElementById('vincular-usuario-nome').textContent = nomeAtual || email;

                    const sel = document.getElementById('vincular-fiscal-select');
                    sel.innerHTML = '<option value="">Selecione...</option>';
                    FISCAIS_LIST.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f;
                        opt.textContent = f;
                        sel.appendChild(opt);
                    });

                    new bootstrap.Modal(document.getElementById('modalVincularFiscal')).show();
                }

                async function aprovarUsuario(email, role = 'externo', skipConfirm = false) {
                    if (!skipConfirm && !confirm(`Confirmar aprovação de ${email} como ${role.toUpperCase()}?`)) return;
                    try {
                        // Se for fiscal, encontra e valida o nome correspondente na FISCAIS_LIST
                        if (role === 'fiscal') {
                            const { data: userData, error: userError } = await sbClient
                                .from('app_users')
                                .select('nome, sobrenome, full_name')
                                .eq('email', email)
                                .single();

                            if (!userError && userData) {
                                let nomeCompleto = '';
                                if (userData.full_name && !/^\d+$/.test(userData.full_name)) {
                                    nomeCompleto = userData.full_name;
                                } else if (userData.nome) {
                                    nomeCompleto = (userData.nome + (userData.sobrenome ? ' ' + userData.sobrenome : '')).trim();
                                }

                                if (nomeCompleto) {
                                    // Match na FISCAIS_LIST
                                    const fiscalFromList = findFiscalNameInList(nomeCompleto);
                                    console.log('[ADMIN] Usuário:', nomeCompleto, '-> Match na lista:', fiscalFromList);

                                    if (!fiscalFromList) {
                                        // AQUI ENTRA O MODAL DE VÍNCULO EM VEZ DO ALERT
                                        abrirModalVinculo(nomeCompleto, email, role, 'aprovar');
                                        return; // Interrompe para aguardar o modal
                                    }
                                }
                            }
                        }

                        const { error } = await sbClient.from('app_users').update({ role: role }).eq('email', email);
                        if (error) throw error;

                        if (!skipConfirm) alert('Usuário aprovado com sucesso!'); // Só alerta se for fluxo manual

                        loadAllUsers();
                        if (typeof fetchPendingCount === 'function') fetchPendingCount();
                    } catch (e) { alert('Erro ao aprovar: ' + e.message); }
                }

                async function excluirUsuario(email) {
                    if (!confirm(`Remover definitivamente o usuário ${email}?`)) return;
                    try {
                        const { error } = await sbClient.from('app_users').delete().eq('email', email);
                        if (error) throw error;
                        alert('Usuário removido.');
                        loadAllUsers();
                        if (typeof fetchPendingCount === 'function') fetchPendingCount();
                    } catch (e) { alert('Erro ao excluir: ' + e.message); }
                }

                function filterAdminUsers() {
                    const term = document.getElementById('admin-user-search').value.toLowerCase();
                    const rows = document.querySelectorAll('#admin-users-table-body tr[data-search]');
                    rows.forEach(row => {
                        row.style.display = row.getAttribute('data-search').includes(term) ? '' : 'none';
                    });
                }

                async function updateUserRole(email, newRole, skipConfirm = false) {
                    if (!skipConfirm && !confirm(`Alterar perfil de ${email} para ${newRole.toUpperCase()}?`)) {
                        loadAllUsers();
                        return;
                    }
                    try {
                        if (newRole === 'fiscal') {
                            const { data: userData, error: userError } = await sbClient
                                .from('app_users')
                                .select('nome, sobrenome, full_name')
                                .eq('email', email)
                                .single();

                            if (!userError && userData) {
                                let nomeCompleto = '';
                                if (userData.full_name && !/^\d+$/.test(userData.full_name)) {
                                    nomeCompleto = userData.full_name;
                                } else if (userData.nome) {
                                    nomeCompleto = (userData.nome + (userData.sobrenome ? ' ' + userData.sobrenome : '')).trim();
                                }

                                if (nomeCompleto) {
                                    const fiscalFromList = findFiscalNameInList(nomeCompleto);
                                    console.log('[ADMIN] Usuário:', nomeCompleto, '-> Match na lista:', fiscalFromList);

                                    if (!fiscalFromList) {
                                        // MODAL DE VÍNCULO
                                        abrirModalVinculo(nomeCompleto, email, newRole, 'update');
                                        return;
                                    }
                                }
                            }
                        }

                        const { error } = await sbClient.from('app_users').update({ role: newRole }).eq('email', email);
                        if (error) throw error;

                        if (!skipConfirm) alert('Perfil atualizado!');
                        loadAllUsers();
                    } catch (e) { alert('Erro ao atualizar cargo: ' + e.message); }
                }

                // Polling de notificações (admin)
                let _notifIntervalId = null;
                function startNotificationsPoll() {
                    if (_notifIntervalId) return;
                    fetchNotifications();
                    _notifIntervalId = setInterval(fetchNotifications, 30000);
                }
                function stopNotificationsPoll() {
                    if (_notifIntervalId) { clearInterval(_notifIntervalId); _notifIntervalId = null; }
                }

                async function fetchPendingCount() {
                    try {
                        const { data, error } = await sbClient.from('app_users').select('id').eq('role', 'pending');
                        if (error) throw error;
                        const count = Array.isArray(data) ? data.length : 0;
                        const badgeEl = document.getElementById('pending-badge');
                        if (badgeEl) badgeEl.textContent = count > 0 ? String(count) : '';
                    } catch (err) { console.error('Erro ao buscar pendentes', err); }
                }

                async function fetchNotifications() {
                    try {
                        const { data, error } = await sbClient.from('app_notifications').select('*').eq('read', false).order('created_at', { ascending: true });
                        if (error) throw error;
                        if (data && data.length) {
                            // Notifica admin (silencioso - apenas log, badge ou toast futuro)
                            data.forEach(async n => {
                                try {
                                    console.log('Nova Notificação:', n.type, n.payload);
                                    // Marca como lida
                                    await sbClient.from('app_notifications').update({ read: true }).eq('id', n.id);
                                } catch (e) { console.error(e); }
                            });
                        }
                    } catch (err) { console.error('Erro ao buscar notificações', err); }
                }
                // Ao carregar, aplica role salvo (se houver)
                (function () {
                    const savedRole = localStorage.getItem('sop_role') || 'guest';
                    console.log('[DEBUG] IIFE: Role salvo ao iniciar:', savedRole);

                    const savedEmail = localStorage.getItem('sop_user');
                    const savedUserName = localStorage.getItem('sop_user_name');

                    // Se não tem nome ou se o nome salvo é apenas números (matrícula), tenta buscar o nome real
                    if (savedEmail && (!savedUserName || /^\d+$/.test(savedUserName))) {
                        sbClient.from('app_users').select('full_name, nome, sobrenome').eq('email', savedEmail).single().then(res => {
                            if (res.data) {
                                let realName = '';
                                if (res.data.full_name && !/^\d+$/.test(res.data.full_name)) {
                                    realName = res.data.full_name;
                                } else if (res.data.nome) {
                                    realName = (res.data.nome + (res.data.sobrenome ? ' ' + res.data.sobrenome : '')).toUpperCase();
                                }

                                if (realName) {
                                    localStorage.setItem('sop_user_name', realName);
                                    console.log('[DEBUG] Nome do usuário corrigido/carregado:', realName);
                                }
                            }
                        });
                    }

                    if (savedRole !== 'guest') {
                        const landing = document.getElementById('landingOverlay');
                        if (landing) {
                            landing.style.display = 'none';
                            console.log('[DEBUG] IIFE: Landing ocultado (usuário já autenticado)');
                        }
                    } else {
                        console.log('[DEBUG] IIFE: Nenhum usuário autenticado. Landing será exibida.');
                    }
                    applyRoleToUI(savedRole);
                })();

                /* ----------------------------------------------------------------
                   Função: criar administrador inicial (nildeno e 99030487)
                   Observação: agora suporta múltiplos admins iniciais.
                ---------------------------------------------------------------- */
                /* ----------------------------------------------------------------
                   Função: criar administrador inicial
                ---------------------------------------------------------------- */
                /* ----------------------------------------------------------------
                   Função: DIAGNÓSTICO E CORREÇÃO DE USUÁRIOS
                ---------------------------------------------------------------- */
                /* ----------------------------------------------------------------
                /* ----------------------------------------------------------------
                   PROMOÇÃO AUTOMÁTICA DE ADMIN (99030487)
                ---------------------------------------------------------------- */
                async function promoteAdmin99030487() {
                    const targetEmail = '99030487@gecope.app';
                    try {
                        // Check user
                        const { data, error } = await sbClient.from('app_users').select('role').eq('email', targetEmail).maybeSingle();

                        if (data && data.role !== 'admin') {
                            console.log('[AUTO-ADMIN] Promovendo 99030487 para ADMIN...');
                            const { error: upErr } = await sbClient.from('app_users').update({ role: 'admin' }).eq('email', targetEmail);

                            if (!upErr) {
                                console.log('[AUTO-ADMIN] Sucesso!');
                                // Update session if logged in
                                const current = localStorage.getItem('sop_user');
                                if (current === targetEmail) {
                                    localStorage.setItem('sop_role', 'admin');
                                    applyRoleToUI('admin');
                                    alert('Sua conta foi promovida para Administrador com sucesso.');
                                }
                            } else {
                                console.error('[AUTO-ADMIN] Falha ao atualizar:', upErr);
                            }
                        }
                    } catch (e) {
                        console.error('[AUTO-ADMIN] Erro:', e);
                    }
                }

                // Executa verificação ao carregar
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(promoteAdmin99030487, 2000);
                });

                /* --------------------------------------------------------------
                   MODAL: SELEÇÃO DE MÓDULOS (PÓS LOGIN)
                ---------------------------------------------------------------- */

                const modules = [
                    { id: '#pane-financeiro', name: 'Painel Financeiro' },
                    { id: '#pane-gerencial', name: 'Painel Gerencial' },
                    { id: '#pane-prazos', name: 'Prazos e Produtividade' },
                    { id: '#pane-reuniao', name: 'Processos' },
                    { id: '#pane-orcamentos', name: 'Orçamentos' },
                    { id: '#pane-composicoes', name: 'Composições' },
                    { id: '#pane-tabelas', name: 'Tabelas' }
                ];

                function buildModuleSelector() {
                    let html = `
                    < div class= "modal fade" id = "modalModuleSelector" tabindex = "-1" >
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Escolha os módulos</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    `;
                    modules.forEach(m => {
                        const key = `mod${m.id.replace('#', '')}`;
                        const checked = (localStorage.getItem(key) === 'true') ? 'checked' : '';
                        html += `<label class="list-group-item d-flex justify-content-between align-items-center"><span>${m.name}</span><input type="checkbox" data-target="${m.id}" class="module-checkbox" ${checked}></label>`;
                    });
                    html += `</div></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button><button class="btn btn-primary" id="btn-apply-modules">Aplicar</button></div></div></div></div > `;
                    document.body.insertAdjacentHTML('beforeend', html);
                    document.getElementById('btn-apply-modules').addEventListener('click', () => {
                        document.querySelectorAll('.module-checkbox').forEach(cb => {
                            const target = cb.dataset.target; const key = `mod${target.replace('#', '')}`;
                            localStorage.setItem(key, cb.checked ? 'true' : 'false');
                            const tabBtn = document.querySelector(`[data - bs - target= "${target}"]`);
                            if (tabBtn) tabBtn.parentElement.style.display = cb.checked ? '' : 'none';
                        });
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalModuleSelector'));
                        if (modal) modal.hide();
                    });
                }

                function openModuleSelector() {
                    // Se ainda não existe, cria
                    if (!document.getElementById('modalModuleSelector')) buildModuleSelector();
                    const modal = new bootstrap.Modal(document.getElementById('modalModuleSelector'));
                    modal.show();
                }

                // Botão do cabeçalho agora abre seleção se estiver logado, ou landing se não
                document.getElementById('btn-admin-login')?.addEventListener('click', () => {
                    const user = localStorage.getItem('sop_user');
                    if (!user) {
                        const landing = document.getElementById('landingOverlay'); if (landing) landing.style.display = 'flex';
                        return;
                    }
                    openModuleSelector();
                });

                // --- FIM DA LÓGICA ADMINISTRATIVA ---

                /* --- LÓGICA DE ORÇAMENTOS (SUPABASE STORAGE + DB) --- */

                // 1. SALVAR NOVO ORÇAMENTO (V1) - CORRIGIDO
                // Função auxiliar para remover acentos e caracteres especiais (Coloque isso fora ou antes da função salvar)
                function limparStringParaPath(str) {
                    if (!str) return "";
                    return str
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos (É -> E)
                        .replace(/\s+/g, "_") // Troca espaços por underline
                        .replace(/[^a-zA-Z0-9._-]/g, "") // Remove qualquer outro caractere especial
                        .toUpperCase();
                }

                // 1. SALVAR NOVO ORÇAMENTO (V1) - VERSÃO FINAL COM CORREÇÃO DE PATH
                async function salvarNovoOrcamento() {
                    const form = document.getElementById('formNovoOrcamento');

                    // Validação básica do HTML
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const formData = new FormData(form);
                    const arquivo = document.getElementById('inputArquivoUpload').files[0];

                    // Busca botão globalmente
                    const btn = document.querySelector('button[onclick="salvarNovoOrcamento()"]');

                    // UI Loading
                    let textoOriginal = "Salvar";
                    if (btn) {
                        textoOriginal = btn.innerText;
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ENVIANDO...';
                    }

                    try {
                        if (!arquivo) {
                            alert("Por favor, selecione um arquivo.");
                            if (btn) { btn.disabled = false; btn.innerText = textoOriginal; }
                            return;
                        }

                        // 1. Captura os valores originais (com acento) para o Banco de Dados
                        const categoria = formData.get('CATEGORIA').trim();
                        const subcategoria = formData.get('SUBCATEGORIA').trim();
                        const obra = formData.get('OBRA').trim();

                        // 2. Gera versões "limpas" para o caminho do Storage (sem acentos/espaços)
                        const catPath = limparStringParaPath(categoria);
                        const subPath = limparStringParaPath(subcategoria);
                        const obraPath = limparStringParaPath(obra);
                        const arquivoNomePath = limparStringParaPath(arquivo.name);

                        // Caminho seguro: ESCOLAS/ENSINO_MEDIO/EEM_10_SALAS/V1_ARQUIVO.PDF
                        const storagePath = `${catPath} /${subPath}/${obraPath}/V1_${arquivoNomePath}`;

                        // 3. Upload para o Supabase Storage
                        const { data: uploadData, error: uploadError } = await sbClient
                            .storage
                            .from('orcamentos')
                            .upload(storagePath, arquivo, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (uploadError) throw uploadError;

                        // 4. Obter URL Pública
                        const { data: publicUrlData } = sbClient
                            .storage
                            .from('orcamentos')
                            .getPublicUrl(storagePath);

                        const publicUrl = publicUrlData.publicUrl;

                        // 5. Salvar Metadados no Banco de Dados (Usando os nomes Originais com acento)
                        const payload = {
                            categoria: categoria.toUpperCase(),       // Salva "ESCOLAS"
                            subcategoria: subcategoria.toUpperCase(), // Salva "ESCOLAS DE ENSINO MÉDIO"
                            nome_obra: obra.toUpperCase(),            // Salva "EEM - 10 SALAS"
                            status: formData.get('STATUS'),
                            versao_atual: 'V1',
                            arquivo_url: publicUrl,
                            arquivo_path: storagePath, // Salva o caminho técnico
                            historico_versoes: [{
                                versao: 'V1',
                                data: new Date().toISOString(),
                                descricao: 'Upload Inicial',
                                url: publicUrl,
                                autor: 'Sistema'
                            }]
                        };

                        const { error: dbError } = await sbClient
                            .from('orcamentos_biblioteca')
                            .insert([payload]);

                        if (dbError) throw dbError;

                        alert("✅ Orçamento cadastrado com sucesso!");

                        // Limpar e Fechar
                        form.reset();
                        const modalEl = document.getElementById('modalNovoOrcamento');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();

                        carregarOrcamentos();

                    } catch (error) {
                        console.error(error);
                        alert("Erro ao salvar: " + error.message);
                    } finally {
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = textoOriginal;
                        }
                    }
                }

                /* --- 2. CARREGAR ORÇAMENTOS (CORRIGIDO VFINAL) --- */
                // 2. CARREGAR ORÇAMENTOS (VERSÃO FINAL CORRIGIDA)
                /* --- 2. CARREGAR ORÇAMENTOS (COM ORDENAÇÃO NUMÉRICA CORRIGIDA) --- */

                async function deletarItemHistoricoOrcamento(id, index) {
                    if (!confirm("⚠️ Tem certeza que deseja excluir este registro do histórico?")) return;

                    const btn = document.activeElement;
                    if (btn) btn.disabled = true;

                    try {
                        const { data, error } = await sbClient.from('orcamentos_biblioteca').select('comentarios_revisao, versao_atual').eq('id', id).single();
                        if (error) throw error;

                        let historico = data.comentarios_revisao || [];

                        // Remove o item pelo índice (como a lista é renderizada na ordem do array, o índice bate)
                        // IMPORTANTE: splice altera o array original in-place
                        if (index >= 0 && index < historico.length) {
                            historico.splice(index, 1);
                        } else {
                            throw new Error("Item não encontrado.");
                        }


                        let payloadUpdate = { comentarios_revisao: historico };

                        // --- LÓGICA DE STATUS DINÂMICO ---
                        const temPendentes = historico.some(c => c.decisao === 'pendente');

                        if (temPendentes) {
                            payloadUpdate.status = 'Em Revisão';
                        } else {
                            // Se não há pendentes, checa se há versões além da V1 para manter "Atualizado" ou voltar para "Disponível"
                            const currentV = parseInt(data.versao_atual?.replace(/[^0-9]/g, '')) || 1;
                            payloadUpdate.status = (currentV > 1) ? 'Atualizado' : 'Disponível';
                        }

                        if (historico.length === 0) {
                            const currentV = parseInt(data.versao_atual?.replace(/[^0-9]/g, '')) || 1;
                            payloadUpdate.status = (currentV > 1) ? 'Atualizado' : 'Disponível';
                        }

                        const { error: updateError } = await sbClient.from('orcamentos_biblioteca').update(payloadUpdate).eq('id', id);
                        if (updateError) throw updateError;

                        alert("Registro excluído!");
                        carregarOrcamentos();

                    } catch (err) {
                        alert("Erro ao excluir: " + err.message);
                        if (btn) btn.disabled = false;
                    }
                }

                async function carregarOrcamentos() {
                    const container = document.getElementById('accordionOrcamentos');
                    const termoBusca = document.getElementById('orcamento-search').value.toLowerCase();
                    const role = (localStorage.getItem('sop_role') || 'guest').toLowerCase();
                    const isAdmin = (document.body.classList.contains('is-admin') || role === 'admin' || role === 'gerente') && role !== 'fiscal';

                    const { data, error } = await sbClient
                        .from('orcamentos_biblioteca')
                        .select('*')
                        .order('categoria', { ascending: true })
                        .order('subcategoria', { ascending: true })
                        // O banco ordena alfabeticamente (10 antes de 6), corrigiremos no JS abaixo
                        .order('nome_obra', { ascending: true });

                    if (error) { container.innerHTML = `Erro: ${error.message}`; return; }
                    if (data.length === 0) { container.innerHTML = `<div class="text-center mt-5 text-muted">Nenhum orçamento encontrado.</div>`; return; }

                    const arvore = {};
                    data.forEach(item => {
                        if (termoBusca && !item.nome_obra.toLowerCase().includes(termoBusca) && !item.categoria.toLowerCase().includes(termoBusca)) return;
                        if (!arvore[item.categoria]) arvore[item.categoria] = {};
                        if (!arvore[item.categoria][item.subcategoria]) arvore[item.categoria][item.subcategoria] = [];
                        arvore[item.categoria][item.subcategoria].push(item);
                    });

                    let html = '';
                    let catIndex = 0;

                    for (const [cat, subcats] of Object.entries(arvore)) {
                        catIndex++;
                        const collapseId = `collapseCat${catIndex}`;

                        html += `
        <div class="accordion-custom-item">
            <h2 class="accordion-header">
                <button class="accordion-button accordion-custom-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                    <i class="bi bi-folder2-open me-2 text-warning"></i> ${cat}
                </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse">
                <div class="accordion-body bg-white pt-2">`;

                        for (const [sub, itens] of Object.entries(subcats)) {
                            html += `<div class="subcategoria-header" style="margin-left: 10px;">${sub}</div>`;

                            // --- CORREÇÃO AQUI: ORDENAÇÃO NATURAL (6 antes de 10) ---
                            itens.sort((a, b) => {
                                return a.nome_obra.localeCompare(b.nome_obra, 'pt-BR', { numeric: true });
                            });
                            // -------------------------------------------------------

                            itens.forEach(obra => {
                                const iconClass = obra.arquivo_url && obra.arquivo_url.endsWith('.pdf') ? 'icon-pdf' : 'icon-xls';
                                const iconSymbol = obra.arquivo_url && obra.arquivo_url.endsWith('.pdf') ? '<i class="bi bi-file-earmark-pdf"></i>' : '<i class="bi bi-file-earmark-spreadsheet"></i>';
                                const dataFormatada = new Date(obra.created_at).toLocaleDateString('pt-BR');

                                // --- 1. BADGES DE STATUS (DINÂMICO) ---
                                let badgeStatus = '';
                                const historicoParaStatus = obra.comentarios_revisao || [];
                                const temPendenteReal = historicoParaStatus.some(c => c.decisao === 'pendente');

                                if (temPendenteReal) {
                                    badgeStatus = `<span class="badge bg-warning text-dark ms-2" style="font-size:0.65rem">Em Revisão</span>`;
                                } else if (obra.status === 'Atualizado' || parseInt(obra.versao_atual?.replace(/[^0-9]/g, '')) > 1) {
                                    // Badge Azul solicitado
                                    badgeStatus = `<span class="badge badge-status-atualizado">Atualizado</span>`;
                                }

                                // --- 2. HISTÓRICO ---
                                const historico = obra.comentarios_revisao || [];
                                const qtdComentarios = historico.length;
                                const histId = `hist_${obra.id}`;

                                let botaoHistorico = '';
                                let containerHistorico = '';

                                if (qtdComentarios > 0) {
                                    botaoHistorico = `
                        <button class="btn-toggle-history" type="button" data-bs-toggle="collapse" data-bs-target="#${histId}">
                            <i class="bi bi-clock-history"></i> Histórico (${qtdComentarios}) <i class="bi bi-chevron-down ms-1"></i>
                        </button>`;

                                    const listaComentarios = historico.map((c, index) => {
                                        const dataComent = c.data ? new Date(c.data).toLocaleDateString('pt-BR') : '-';
                                        let classeStatus = '';
                                        let badgeDecisao = '';
                                        let respostaAdminHTML = '';
                                        let botoesAcaoAdmin = '';

                                        const isSystemLog = (c.autor && c.autor.toLowerCase().includes('sistema')) || (c.mensagem && c.mensagem.toLowerCase().includes('gerada versão'));

                                        if (isSystemLog) {
                                            classeStatus = 'system-log-entry';
                                        }

                                        if (c.decisao === 'atendido') {
                                            classeStatus = 'status-atendido';
                                            badgeDecisao = `<span class="badge-decision badge-atendido"><i class="bi bi-check-lg"></i> ATENDIDO</span>`;
                                            if (c.resp_admin) respostaAdminHTML = `<div class="mt-2 pt-2 border-top small text-success"><strong>Resposta:</strong> ${c.resp_admin}</div>`;
                                        } else {
                                            if (c.decisao === 'recusado') {
                                                classeStatus = 'status-recusado';
                                                badgeDecisao = `<span class="badge-decision badge-recusado"><i class="bi bi-x-lg"></i> NÃO ACATADO</span>`;
                                                if (c.resp_admin) respostaAdminHTML = `<div class="mt-2 pt-2 border-top small text-danger"><strong>Motivo:</strong> ${c.resp_admin}</div>`;
                                            } else {
                                                if (isAdmin && !isSystemLog) {
                                                    botoesAcaoAdmin = `
                                <div class="admin-decision-actions">
                                    <button class="btn btn-sm btn-outline-success" onclick="abrirModalAtender(${obra.id}, ${index})">
                                        <i class="bi bi-check-lg"></i> Atender
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="abrirModalRecusar(${obra.id}, ${index})">
                                        <i class="bi bi-x-lg"></i> Não Acatar
                                    </button>
                                </div>`;
                                                }
                                            }
                                        }


                                        let btnAnexo = '';
                                        if (c.arquivo) {
                                            btnAnexo = `<a href="${c.arquivo}" target="_blank" class="btn-history-anexo mt-2"><i class="bi bi-paperclip"></i> Ver Memória/Anexo</a>`;
                                        }

                                        let btnExcluirHist = '';
                                        if (isAdmin) {
                                            btnExcluirHist = `<button class="btn btn-sm text-danger border-0 p-0 ms-2 admin-only" title="Excluir Registro" onclick="deletarItemHistoricoOrcamento(${obra.id}, ${index})"><i class="bi bi-x-lg"></i></button>`;
                                        }

                                        return `
                        <div class="history-card-item ${classeStatus}">
                            <div class="history-card-header">
                                <div><strong>${c.autor}</strong> <span class="fw-normal ms-1">- ${dataComent}</span></div>
                                <div class="d-flex align-items-center">
                                    ${badgeDecisao}
                                    ${btnExcluirHist}
                                </div>
                            </div>
                            <div class="history-card-body">
                                <div>${c.mensagem}</div>
                                ${btnAnexo}
                                ${respostaAdminHTML}
                                ${botoesAcaoAdmin}
                            </div>
                        </div>`;
                                    }).join('');

                                    containerHistorico = `
                    <div class="collapse" id="${histId}">
                        <div class="history-collapse-box">
                            ${listaComentarios}
                        </div>
                    </div>`;
                                }

                                html += `
                <div class="mb-2">
                    <div class="orcamento-item-row" style="margin-bottom:0; border-radius: 8px 8px ${qtdComentarios > 0 ? '0 0' : '8px 8px'};">
                        <div class="d-flex align-items-center">
                            <div class="file-icon-box ${iconClass}">${iconSymbol}</div>
                            <div>
                                <div class="d-flex align-items-center flex-wrap">
                                    <span class="fw-bold text-dark" style="font-size:0.95rem;">${obra.nome_obra}</span>
                                    <span class="badge bg-secondary ms-2" style="font-size:0.7rem;">${obra.versao_atual}</span>
                                    ${badgeStatus}
                                </div>
                                <div class="text-muted mt-1" style="font-size:0.75rem;">Criado em: ${dataFormatada}</div>
                                ${botaoHistorico}
                            </div>
                        </div>
                        <div class="orcamento-actions">
                            <a href="${obra.arquivo_url}" target="_blank" class="btn-action-baixar" title="Baixar Arquivo"><i class="bi bi-download"></i> Baixar</a>
                            <!-- Nova Versão: APENAS ADMIN -->
                            <button class="btn btn-action-icon admin-only" onclick="prepararNovaVersao(${obra.id})" title="Nova Versão"><i class="bi bi-cloud-arrow-up-fill icon-cloud"></i></button>
                            <!-- Comentário: VISÍVEL PARA TODOS -->
                            <button class="btn btn-action-icon" onclick="prepararComentario(${obra.id})" title="Adicionar Comentário"><i class="bi bi-chat-left-text-fill text-warning"></i></button>
                            <!-- Excluir: APENAS ADMIN E NÃO FISCAL -->
                            <button class="btn btn-action-icon admin-only" onclick="deletarOrcamento(${obra.id}, '${obra.arquivo_path}')"><i class="bi bi-trash-fill icon-trash"></i></button>
                        </div>
                    </div>
                    ${containerHistorico}
                </div>`;
                            });
                        }
                        html += `   </div></div></div>`;
                    }
                    container.innerHTML = html;
                }

                /* --- FUNÇÕES DE DECISÃO (ATUALIZADAS E SIMPLIFICADAS) --- */


                // Hook para buscar ao digitar (debounce simples)
                document.getElementById('orcamento-search').addEventListener('input', () => {
                    carregarOrcamentos();
                });

                // Clear Listener Orçamentos
                document.getElementById('btn-orc-clear')?.addEventListener('click', () => {
                    const input = document.getElementById('orcamento-search');
                    if (input) {
                        input.value = '';
                        carregarOrcamentos();
                    }
                });

                // 3. ENVIAR NOVA VERSÃO (V2, V3...)
                function prepararNovaVersao(id) {
                    document.getElementById('update-id-orcamento').value = id;
                    document.getElementById('formNovaVersao').reset();
                    new bootstrap.Modal(document.getElementById('modalNovaVersao')).show();
                }

                /* --- ENVIO DE NOVA VERSÃO (MUDA STATUS PARA ATUALIZADO) --- */
                async function enviarNovaVersao() {
                    const id = document.getElementById('update-id-orcamento').value;
                    const arquivo = document.getElementById('inputArquivoUpdate').files[0];
                    const descricao = document.getElementById('inputDescricaoUpdate').value;

                    if (!arquivo) { alert("Selecione um arquivo."); return; }

                    const btn = document.querySelector('#modalNovaVersao button[onclick="enviarNovaVersao()"]');
                    const txtOrig = btn.innerText;
                    btn.disabled = true; btn.innerText = "Processando...";

                    try {
                        // 1. Pegar dados atuais
                        const { data: currentData } = await sbClient.from('orcamentos_biblioteca').select('*').eq('id', id).single();

                        // 2. Calcular nova versão
                        const currentV = parseInt(currentData.versao_atual.replace(/[^0-9]/g, '')) || 1;
                        const newVersionLabel = `V${currentV + 1}`;

                        // 3. Upload Novo Arquivo
                        const nomeLimpo = arquivo.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9.-]/g, "_");
                        const pathParts = currentData.arquivo_path.split('/');
                        if (pathParts.length > 1) pathParts.pop();
                        const folderPath = pathParts.join('/');
                        const newStoragePath = `${folderPath}/${newVersionLabel}_${nomeLimpo}`;

                        const { error: uploadError } = await sbClient.storage.from('orcamentos').upload(newStoragePath, arquivo);
                        if (uploadError) throw uploadError;

                        const { data: publicUrlData } = sbClient.storage.from('orcamentos').getPublicUrl(newStoragePath);

                        // 4. Atualizar Histórico de Versões
                        const oldHistory = currentData.historico_versoes || [];
                        oldHistory.push({
                            versao: currentData.versao_atual,
                            url: currentData.arquivo_url,
                            data: new Date().toISOString(),
                            motivo: 'Versão arquivada'
                        });

                        // 5. Update na Tabela -> AQUI MUDA O STATUS PARA "ATUALIZADO"
                        const { error: updateError } = await sbClient
                            .from('orcamentos_biblioteca')
                            .update({
                                versao_atual: newVersionLabel,
                                arquivo_url: publicUrlData.publicUrl,
                                arquivo_path: newStoragePath,
                                historico_versoes: oldHistory,
                                status: 'Atualizado', // <--- MUDANÇA AUTOMÁTICA DE STATUS
                                created_at: new Date().toISOString()
                            })
                            .eq('id', id);

                        if (updateError) throw updateError;

                        // Se houver descrição, salva como comentário de sistema
                        if (descricao) {
                            await salvarComentarioNoBanco(id, 'Sistema (Versão)', `Gerada versão ${newVersionLabel}: ${descricao}`);
                        }

                        alert(`Versão ${newVersionLabel} enviada! Status alterado para ATUALIZADO.`);
                        bootstrap.Modal.getInstance(document.getElementById('modalNovaVersao')).hide();
                        carregarOrcamentos();

                    } catch (err) {
                        alert("Erro: " + err.message);
                    } finally {
                        btn.disabled = false; btn.innerText = txtOrig;
                    }
                }

                // 4. REVISÕES E COMENTÁRIOS
                async function prepararComentario(id) {
                    try {
                        const modalEl = document.getElementById('modalComentarioOrcamento');
                        if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

                        document.getElementById('coment-id-orcamento').value = id;
                        const { data, error } = await sbClient.from('orcamentos_biblioteca').select('*').eq('id', id).single();
                        if (error) throw error;

                        document.getElementById('coment-nome-obra').value = data.nome_obra || '';
                        document.querySelector('#formComentarioOrcamento textarea[name="MENSAGEM"]').value = '';

                        const sel = document.getElementById('coment-fiscal');
                        // Preenche automaticamente com o usuário logado
                        const currentUserName = localStorage.getItem('sop_user_name') || localStorage.getItem('sop_user') || 'Usuário';
                        sel.innerHTML = `<option value="${currentUserName}" selected>${currentUserName}</option>`;
                        // Visualmente "readonly"
                        sel.style.backgroundColor = '#e9ecef';
                        sel.style.pointerEvents = 'none';

                        const chatContainer = document.getElementById('historico-comentarios');
                        const comentarios = data.comentarios_revisao || [];
                        chatContainer.innerHTML = comentarios.length ? comentarios.map(c => `
                            <div class="mb-2 border-bottom pb-1">
                                <div class="d-flex justify-content-between"><strong class="text-primary" style="font-size:0.75rem">${c.autor}</strong><span class="text-muted" style="font-size:0.7rem">${c.data ? new Date(c.data).toLocaleDateString() : '-'}</span></div>
                                <div style="font-size:0.8rem">${c.mensagem}</div>
                                ${c.arquivo ? `<a href="${c.arquivo}" target="_blank" class="badge bg-light text-dark border mt-1"><i class="bi bi-paperclip"></i> Anexo</a>` : ''}
                            </div>`).join('') : '<em class="text-muted">Sem mensagens.</em>';

                        bootstrap.Modal.getOrCreateInstance(modalEl).show();
                    } catch (err) { alert("Erro: " + err.message); }
                }

                /* --- ENVIO DE COMENTÁRIO (MUDA STATUS PARA EM REVISÃO) --- */
                async function enviarComentarioOrcamento() {
                    const id = document.getElementById('coment-id-orcamento').value;
                    const autor = document.getElementById('coment-fiscal').value;
                    const msg = document.querySelector('textarea[name="MENSAGEM"]').value;
                    const arquivoAnexo = document.getElementById('inputArquivoComentario').files[0];

                    if (!autor || !msg) { alert("Preencha autor e mensagem."); return; }

                    let anexoUrl = null;
                    if (arquivoAnexo) {
                        const path = `anexos_comentarios/${id}_${Date.now()}_${arquivoAnexo.name}`;
                        await sbClient.storage.from('orcamentos').upload(path, arquivoAnexo);
                        const { data } = sbClient.storage.from('orcamentos').getPublicUrl(path);
                        anexoUrl = data.publicUrl;
                    }

                    // Buscar histórico atual
                    const { data: curr } = await sbClient.from('orcamentos_biblioteca').select('comentarios_revisao').eq('id', id).single();
                    const novoArr = curr.comentarios_revisao || [];

                    novoArr.unshift({
                        autor: autor,
                        mensagem: msg,
                        data: new Date().toISOString(),
                        arquivo: anexoUrl,
                        decisao: 'pendente' // Novo comentário nasce pendente
                    });

                    // Atualiza status para "Em Revisão"
                    const { error: updateError } = await sbClient.from('orcamentos_biblioteca').update({
                        comentarios_revisao: novoArr,
                        status: 'Em Revisão'  // <--- FORÇA O STATUS DE REVISÃO
                    }).eq('id', id);

                    if (updateError) throw updateError;

                    alert("Solicitação enviada!");
                    bootstrap.Modal.getInstance(document.getElementById('modalComentarioOrcamento')).hide();
                    carregarOrcamentos();
                }

                // Função auxiliar usada internamente
                async function salvarComentarioNoBanco(id, autor, mensagem) {
                    const { data: curr } = await sbClient.from('orcamentos_biblioteca').select('comentarios_revisao').eq('id', id).single();
                    const novoArr = curr.comentarios_revisao || [];
                    novoArr.unshift({ autor, mensagem, data: new Date().toISOString() });
                    await sbClient.from('orcamentos_biblioteca').update({ comentarios_revisao: novoArr }).eq('id', id);
                }

                /* --- MOTORES GENÉRICOS (OTIMIZAÇÃO) --- */

                async function processarDecisaoGenerica(config) {
                    const { table, id, index, decision, respText, modalId, callback } = config;
                    const btn = document.querySelector(`#${modalId} .btn-success, #${modalId} .btn-danger`);
                    const txtOrig = btn?.innerHTML || "Confirmar";

                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';
                    }

                    try {
                        const { data } = await sbClient.from(table).select('comentarios_revisao, status, versao_atual').eq('id', id).single();
                        const hist = data.comentarios_revisao || [];
                        if (hist[index]) {
                            hist[index].decisao = decision;
                            hist[index].resp_admin = respText || (decision === 'atendido' ? "Solicitação atendida." : "Solicitação não acatada.");
                            hist[index].data_resp = new Date().toISOString();
                        }

                        // --- RECÁLCULO DE STATUS ---
                        const temPendentes = hist.some(c => c.decisao === 'pendente');
                        let novoStatus = data.status || 'Disponível';

                        if (temPendentes) {
                            novoStatus = 'Em Revisão';
                        } else {
                            // Se resolveu todos os pendentes, volta para "Atualizado" (se for V2+) ou "Disponível"
                            const vStr = data.versao_atual || 'V1';
                            const vNum = parseInt(vStr.replace(/[^0-9]/g, '')) || 1;
                            novoStatus = (vNum > 1) ? 'Atualizado' : 'Disponível';
                        }

                        const { error } = await sbClient.from(table).update({
                            comentarios_revisao: hist,
                            status: novoStatus
                        }).eq('id', id);
                        if (error) throw error;

                        alert("Ação realizada com sucesso!");
                        bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
                        if (callback) callback();
                    } catch (err) {
                        alert("Erro: " + err.message);
                    } finally {
                        if (btn) { btn.disabled = false; btn.innerHTML = txtOrig; }
                    }
                }

                function abrirModalDecisao(modalId, id, idx, idInput, idxInput, formId) {
                    const modalEl = document.getElementById(modalId);
                    if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);
                    document.getElementById(idInput).value = id;
                    document.getElementById(idxInput).value = idx;
                    document.getElementById(formId)?.reset();
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                }

                async function processarAtendimento() {
                    const id = document.getElementById('atender-id-orcamento').value;
                    const index = document.getElementById('atender-index-comentario').value;
                    const resp = document.getElementById('textoAtender').value;
                    await processarDecisaoGenerica({
                        table: 'orcamentos_biblioteca', id, index, decision: 'atendido',
                        respText: resp, modalId: 'modalAtenderRevisao', callback: carregarOrcamentos
                    });
                }

                async function processarRecusa() {
                    const id = document.getElementById('recusar-id-orcamento').value;
                    const index = document.getElementById('recusar-index-comentario').value;
                    const resp = document.getElementById('textoRecusar').value;
                    await processarDecisaoGenerica({
                        table: 'orcamentos_biblioteca', id, index, decision: 'recusado',
                        respText: resp, modalId: 'modalRecusarRevisao', callback: carregarOrcamentos
                    });
                }

                async function processarAtendimentoComposicao() {
                    const id = document.getElementById('atender-id-composicao').value;
                    const index = document.getElementById('atender-index-comentario-comp').value;
                    const resp = document.getElementById('textoAtenderComp').value;
                    await processarDecisaoGenerica({
                        table: 'composicoes_biblioteca', id, index, decision: 'atendido',
                        respText: resp, modalId: 'modalAtenderComposicao', callback: carregarComposicoes
                    });
                }

                async function processarRecusaComposicao() {
                    const id = document.getElementById('recusar-id-composicao').value;
                    const index = document.getElementById('recusar-index-comentario-comp').value;
                    const resp = document.getElementById('textoRecusarComp').value;
                    await processarDecisaoGenerica({
                        table: 'composicoes_biblioteca', id, index, decision: 'recusado',
                        respText: resp, modalId: 'modalRecusarComposicao', callback: carregarComposicoes
                    });
                }

                async function deletarRegistroGenerico(table, bucket, id, path, callback) {
                    if (!confirm("⚠️ TEM CERTEZA?\n\nIsso apagará permanentemente o registro e o arquivo associado.")) return;
                    document.body.style.cursor = 'wait';
                    try {
                        if (path) await sbClient.storage.from(bucket).remove([path]);
                        const { error } = await sbClient.from(table).delete().eq('id', id);
                        if (error) throw error;
                        alert("✅ Excluído com sucesso!");
                        if (callback) callback();
                    } catch (err) {
                        alert("Erro ao excluir: " + err.message);
                    } finally {
                        document.body.style.cursor = 'default';
                    }
                }

                async function deletarOrcamento(id, path) {
                    await deletarRegistroGenerico('orcamentos_biblioteca', 'orcamentos', id, path, carregarOrcamentos);
                }

                async function deletarComposicao(id, path) {
                    await deletarRegistroGenerico('composicoes_biblioteca', 'composicoes_biblioteca', id, path, carregarComposicoes);
                }





                /* --- FUNÇÕES DE DECISÃO CORRIGIDAS (RESOLVE TELA ESCURA) --- */

                // 1. ABRIR MODAL ATENDER
                function abrirModalAtender(id, index) {
                    abrirModalDecisao('modalAtenderRevisao', id, index, 'atender-id-orcamento', 'atender-index-comentario', 'formAtender');
                }

                // 2. PROCESSAR ATENDIMENTO


                // 3. ABRIR MODAL RECUSAR
                function abrirModalRecusar(id, index) {
                    abrirModalDecisao('modalRecusarRevisao', id, index, 'recusar-id-orcamento', 'recusar-index-comentario', 'formRecusar');
                }

                /* ==========================================================================
                   LÓGICA DAS NOVAS ABAS: COMPOSIÇÕES E TABELAS
                   ========================================================================== */

                /* ==========================================================================
                   LÓGICA DAS NOVAS ABAS: COMPOSIÇÕES E TABELAS
                   ========================================================================== */

                /* --- 1. LÓGICA DE COMPOSIÇÕES (IDÊNTICA A ORÇAMENTOS) --- */

                // 1.1 SALVAR NOVA COMPOSIÇÃO
                async function salvarNovaComposicao() {
                    const form = document.getElementById('formNovaComposicao');
                    if (!form.checkValidity()) { form.reportValidity(); return; }

                    const formData = new FormData(form);
                    const arquivo = document.getElementById('inputArquivoUploadComp').files[0];
                    const btn = document.querySelector('button[onclick="salvarNovaComposicao()"]');

                    let textoOriginal = "Salvar";
                    if (btn) {
                        textoOriginal = btn.innerText;
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ENVIANDO...';
                    }

                    try {
                        if (!arquivo) throw new Error("Selecione um arquivo.");

                        const categoria = formData.get('CATEGORIA').trim();
                        const subcategoria = formData.get('SUBCATEGORIA').trim();
                        const obra = formData.get('OBRA').trim();

                        const catPath = limparStringParaPath(categoria);
                        const subPath = limparStringParaPath(subcategoria);
                        const obraPath = limparStringParaPath(obra);
                        const arquivoNomePath = limparStringParaPath(arquivo.name);

                        // Caminho no Bucket 'composicoes_biblioteca'
                        const storagePath = `${catPath}/${subPath}/${obraPath}/V1_${arquivoNomePath}`;

                        const { error: uploadError } = await sbClient.storage.from('composicoes_biblioteca').upload(storagePath, arquivo);
                        if (uploadError) throw uploadError;

                        const { data: publicUrlData } = sbClient.storage.from('composicoes_biblioteca').getPublicUrl(storagePath);

                        const payload = {
                            usuario: categoria.toUpperCase(),
                            subcategoria: subcategoria.toUpperCase(),
                            descricao: obra.toUpperCase(),
                            status: formData.get('STATUS'),
                            versao_atual: 'V1',
                            arquivo_url: publicUrlData.publicUrl,
                            arquivo_path: storagePath,
                            criador_email: localStorage.getItem('sop_user') || 'sistema',
                            criador_nome: localStorage.getItem('sop_user_name') || 'SISTEMA',
                            criador_role: localStorage.getItem('sop_role') || 'fiscal',
                            historico_versoes: [{
                                versao: 'V1',
                                data: new Date().toISOString(),
                                descricao: 'Upload Inicial',
                                url: publicUrlData.publicUrl,
                                autor: localStorage.getItem('sop_user_name') || localStorage.getItem('sop_user') || 'Sistema'
                            }]
                        };

                        const { error: dbError } = await sbClient.from('composicoes_biblioteca').insert([payload]);
                        if (dbError) throw dbError;

                        alert("✅ Composição cadastrada com sucesso!");
                        form.reset();
                        bootstrap.Modal.getInstance(document.getElementById('modalCadastrarComposicao')).hide();
                        carregarComposicoes();

                    } catch (error) {
                        console.error(error);
                        alert("Erro ao salvar: " + error.message);
                    } finally {
                        if (btn) { btn.disabled = false; btn.innerHTML = textoOriginal; }
                    }
                }

                // 1.2 CARREGAR COMPOSIÇÕES
                function prepararNovaVersaoComposicao(id) {
                    document.getElementById('update-id-composicao').value = id;
                    document.getElementById('formNovaVersaoComposicao').reset();
                    new bootstrap.Modal(document.getElementById('modalNovaVersaoComposicao')).show();
                }

                async function enviarNovaVersaoComposicao() {
                    const id = document.getElementById('update-id-composicao').value;
                    const arquivo = document.getElementById('inputArquivoUpdateComp').files[0];
                    const descricao = document.getElementById('inputDescricaoUpdateComp').value;

                    if (!arquivo) return alert("Selecione um arquivo.");

                    const btn = document.querySelector('#modalNovaVersaoComposicao button[onclick="enviarNovaVersaoComposicao()"]');
                    const txtOrig = btn.innerText;
                    btn.disabled = true; btn.innerText = "Processando...";

                    try {
                        const { data: currentData } = await sbClient.from('composicoes_biblioteca').select('*').eq('id', id).single();
                        const currentV = parseInt(currentData.versao_atual.replace(/[^0-9]/g, '')) || 1;
                        const newVersionLabel = `V${currentV + 1}`;

                        // Upload
                        const nomeLimpo = arquivo.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9.-]/g, "_");
                        const pathParts = currentData.arquivo_path.split('/');
                        if (pathParts.length > 1) pathParts.pop();
                        const newStoragePath = `${pathParts.join('/')}/${newVersionLabel}_${nomeLimpo}`;

                        const { error: uploadError } = await sbClient.storage.from('composicoes_biblioteca').upload(newStoragePath, arquivo);
                        if (uploadError) throw uploadError;

                        const { data: pubUrl } = sbClient.storage.from('composicoes_biblioteca').getPublicUrl(newStoragePath);

                        // Histórico
                        const oldHistory = currentData.historico_versoes || [];
                        oldHistory.push({ versao: currentData.versao_atual, url: currentData.arquivo_url, data: new Date().toISOString(), motivo: 'Versão arquivada' });

                        // Update Table
                        await sbClient.from('composicoes_biblioteca').update({
                            versao_atual: newVersionLabel,
                            arquivo_url: pubUrl.publicUrl,
                            arquivo_path: newStoragePath,
                            historico_versoes: oldHistory,
                            status: 'Atualizado',
                            created_at: new Date().toISOString()
                        }).eq('id', id);

                        if (descricao) {
                            // Salvar comentário de sistema
                            const { data: curr } = await sbClient.from('composicoes_biblioteca').select('comentarios_revisao').eq('id', id).single();
                            const novoArr = curr.comentarios_revisao || [];
                            novoArr.unshift({ autor: 'Sistema (Versão)', mensagem: `Gerada versão ${newVersionLabel}: ${descricao}`, data: new Date().toISOString() });
                            await sbClient.from('composicoes_biblioteca').update({ comentarios_revisao: novoArr }).eq('id', id);
                        }

                        alert(`Versão ${newVersionLabel} de Composição enviada!`);
                        bootstrap.Modal.getInstance(document.getElementById('modalNovaVersaoComposicao')).hide();
                        carregarComposicoes();
                    } catch (err) { alert("Erro: " + err.message); } finally { btn.disabled = false; btn.innerText = txtOrig; }
                }

                // 1.4 COMENTÁRIOS COMPOSIÇÃO
                async function prepararComentarioComposicao(id) {
                    try {
                        const modalEl = document.getElementById('modalComentarioComposicao');
                        if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

                        document.getElementById('coment-id-composicao').value = id;
                        const { data, error } = await sbClient.from('composicoes_biblioteca').select('*').eq('id', id).single();
                        if (error) throw error;

                        document.getElementById('coment-nome-composicao').value = data.descricao || '';
                        document.querySelector('#formComentarioComposicao textarea[name="MENSAGEM"]').value = '';

                        const sel = document.getElementById('coment-fiscal-comp');
                        // Preenche automaticamente com o usuário logado
                        const currentUserNameComp = localStorage.getItem('sop_user_name') || localStorage.getItem('sop_user') || 'Usuário';
                        sel.innerHTML = `<option value="${currentUserNameComp}" selected>${currentUserNameComp}</option>`;
                        // Visualmente "readonly"
                        sel.style.backgroundColor = '#e9ecef';
                        sel.style.pointerEvents = 'none';

                        const chat = document.getElementById('historico-comentarios-comp');
                        const comments = data.comentarios_revisao || [];

                        chat.innerHTML = comments.length ? comments.map(c => `
                            <div class="mb-2 border-bottom pb-1">
                                <div class="d-flex justify-content-between"><strong class="text-primary" style="font-size:0.75rem">${c.autor}</strong><span class="text-muted" style="font-size:0.7rem">${new Date(c.data).toLocaleDateString()}</span></div>
                                <div style="font-size:0.8rem">${c.mensagem}</div>
                                ${c.arquivo ? `<a href="${c.arquivo}" target="_blank" class="badge bg-light text-dark border mt-1"><i class="bi bi-paperclip"></i> Anexo</a>` : ''}
                            </div>`).join('') : '<em class="text-muted">Sem mensagens.</em>';

                        bootstrap.Modal.getOrCreateInstance(modalEl).show();
                    } catch (err) {
                        alert("Erro ao carregar comentários: " + err.message);
                    }
                }

                async function enviarComentarioComposicao() {
                    const btn = document.querySelector('#modalComentarioComposicao .btn-primary');
                    const txtOrig = btn.innerText;

                    const id = document.getElementById('coment-id-composicao').value;
                    const autor = document.getElementById('coment-fiscal-comp').value;
                    const msg = document.querySelector('#formComentarioComposicao textarea[name="MENSAGEM"]').value;
                    const anexo = document.getElementById('inputArquivoComentarioComp').files[0];

                    if (!autor || !msg) return alert("Preencha autor e mensagem.");

                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

                    try {
                        let anexoUrl = null;
                        if (anexo) {
                            const path = `anexos_comentarios/${id}_${Date.now()}_${anexo.name}`;
                            const { error: uploadError } = await sbClient.storage.from('composicoes_biblioteca').upload(path, anexo);
                            if (uploadError) throw uploadError;
                            anexoUrl = sbClient.storage.from('composicoes_biblioteca').getPublicUrl(path).data.publicUrl;
                        }

                        const { data: curr, error: fetchError } = await sbClient.from('composicoes_biblioteca').select('comentarios_revisao').eq('id', id).single();
                        if (fetchError) throw fetchError;

                        const novoArr = curr.comentarios_revisao || [];
                        novoArr.unshift({ autor, mensagem: msg, data: new Date().toISOString(), arquivo: anexoUrl, decisao: 'pendente' });

                        const { error: updateError } = await sbClient.from('composicoes_biblioteca').update({ comentarios_revisao: novoArr, status: 'Em Revisão' }).eq('id', id);
                        if (updateError) throw updateError;

                        alert("Solicitação enviada!");
                        bootstrap.Modal.getInstance(document.getElementById('modalComentarioComposicao')).hide();
                        carregarComposicoes();
                    } catch (err) {
                        alert("Erro ao enviar: " + err.message);
                    } finally {
                        btn.disabled = false;
                        btn.innerText = txtOrig;
                    }
                }

                function abrirModalAtenderComposicao(id, index) {
                    abrirModalDecisao('modalAtenderComposicao', id, index, 'atender-id-composicao', 'atender-index-comentario-comp', 'formAtenderComp');
                }

                function abrirModalRecusarComposicao(id, index) {
                    abrirModalDecisao('modalRecusarComposicao', id, index, 'recusar-id-composicao', 'recusar-index-comentario-comp', 'formRecusarComp');
                }

                async function deletarComposicao(id, path) {
                    if (!confirm("⚠️ Tem certeza que deseja EXCLUIR esta composição?")) return;
                    try {
                        if (path) await sbClient.storage.from('composicoes_biblioteca').remove([path]);
                        await sbClient.from('composicoes_biblioteca').delete().eq('id', id);
                        alert("Composição excluída!");
                        carregarComposicoes();
                    } catch (e) { alert("Erro: " + e.message); }
                }

                async function deletarItemHistoricoComposicao(id, index) {
                    if (!confirm("⚠️ Tem certeza que deseja excluir este registro do histórico?")) return;

                    const btn = document.activeElement;
                    if (btn) btn.disabled = true;

                    try {
                        const { data, error } = await sbClient.from('composicoes_biblioteca').select('comentarios_revisao, versao_atual').eq('id', id).single();
                        if (error) throw error;

                        let historico = data.comentarios_revisao || [];

                        if (index >= 0 && index < historico.length) {
                            historico.splice(index, 1);
                        } else {
                            throw new Error("Item não encontrado.");
                        }

                        let payloadUpdate = { comentarios_revisao: historico };

                        // --- LÓGICA DE STATUS DINÂMICO ---
                        const temPendentes = historico.some(c => c.decisao === 'pendente');
                        if (temPendentes) {
                            payloadUpdate.status = 'Em Revisão';
                        } else {
                            const currentV = parseInt(data.versao_atual?.replace(/[^0-9]/g, '')) || 1;
                            payloadUpdate.status = (currentV > 1) ? 'Atualizado' : 'Disponível';
                        }

                        if (historico.length === 0) {
                            const currentV = parseInt(data.versao_atual?.replace(/[^0-9]/g, '')) || 1;
                            payloadUpdate.status = (currentV > 1) ? 'Atualizado' : 'Disponível';
                        }

                        const { error: updateError } = await sbClient.from('composicoes_biblioteca').update(payloadUpdate).eq('id', id);
                        if (updateError) throw updateError;

                        alert("Registro excluído!");
                        carregarComposicoes();

                    } catch (err) {
                        alert("Erro ao excluir: " + err.message);
                        if (btn) btn.disabled = false;
                    }
                }



                // 1.2 CARREGAR COMPOSIÇÕES (CORRIGIDO)
                async function carregarComposicoes() {
                    const container = document.getElementById('accordionComposicoes');
                    const termoBusca = document.getElementById('comp-search').value.toLowerCase();
                    const role = (localStorage.getItem('sop_role') || 'guest').toLowerCase();
                    const isAdmin = (document.body.classList.contains('is-admin') || role === 'admin' || role === 'gerente') && role !== 'fiscal';
                    const userEmail = localStorage.getItem('sop_user');
                    const currentUserName = (localStorage.getItem('sop_user_name') || '').toUpperCase();
                    const currentFiscalName = (localStorage.getItem('sop_fiscal_name') || '').toUpperCase();

                    if (!container) return;
                    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div><div class="mt-2 text-secondary fw-bold">Carregando composições...</div></div>';

                    try {
                        const { data, error } = await sbClient
                            .from('composicoes_biblioteca')
                            .select('*')
                            .order('usuario', { ascending: true })
                            .order('subcategoria', { ascending: true })
                            .order('descricao', { ascending: true });

                        if (error) {
                            console.error('[ERRO Composições]', error);
                            container.innerHTML = `<div class="alert alert-danger">Erro ao carregar banco: ${error.message}</div>`;
                            return;
                        }

                        console.log(`[DEBUG] Composições carregadas: ${data?.length || 0} registros.`);

                        const arvore = {};
                        data.forEach(item => {
                            try {
                                const desc = (item.descricao || "").toLowerCase();
                                const user = (item.usuario || "").toLowerCase();
                                const code = (item.codigo || "").toLowerCase();

                                if (termoBusca && !desc.includes(termoBusca) && !user.includes(termoBusca) && !code.includes(termoBusca)) return;

                                const userKey = (item.usuario || 'OUTROS').toUpperCase();
                                if (!arvore[userKey]) arvore[userKey] = [];
                                arvore[userKey].push(item);
                            } catch (e) {
                                console.error('[ERRO Item Composicao]', e, item);
                            }
                        });

                        const sortedUsers = Object.keys(arvore).sort((a, b) => {
                            if (a === 'SOP') return -1;
                            if (b === 'SOP') return 1;
                            const isMeA = (a === currentUserName || a === currentFiscalName || (userEmail && a.toUpperCase().includes(userEmail.toUpperCase())));
                            const isMeB = (b === currentUserName || b === currentFiscalName || (userEmail && b.toUpperCase().includes(userEmail.toUpperCase())));
                            if (isMeA) return -1;
                            if (isMeB) return 1;
                            return a.localeCompare(b, 'pt-BR');
                        });

                        let html = '';
                        let uIndex = 2000;

                        for (const userKey of sortedUsers) {
                            uIndex++;
                            const collapseId = `collapseCompUser${uIndex}`;
                            const itens = arvore[userKey];

                            const isMe = (userKey === currentUserName || userKey === currentFiscalName || (userEmail && userKey.toUpperCase().includes(userEmail.toUpperCase())));
                            const isSop = (userKey === 'SOP');

                            let accordionStyle = '';
                            let iconClassHeader = 'bi bi-folder2-open me-2 text-success';
                            let titleLabel = userKey;

                            if (isMe) {
                                accordionStyle = 'background-color: #dcfce7 !important; color: #166534 !important; font-weight: 700; border: 1px solid #bbf7d0;';
                                iconClassHeader = 'bi bi-person-fill-check me-2 text-success';
                                titleLabel = `MINHAS COMPOSIÇÕES (${userKey})`;
                            } else if (isSop) {
                                accordionStyle = 'background-color: #f8f9fa !important; color: #334155 !important; font-weight: 800; border: 1px solid #e2e8f0;';
                                iconClassHeader = 'bi bi-building-fill-check me-2 text-primary';
                                titleLabel = 'SOP (OFICIAL)';
                            }

                            let itensHtml = '';
                            itens.sort((a, b) => {
                                const codeA = (a.codigo || "").toUpperCase();
                                const codeB = (b.codigo || "").toUpperCase();
                                if (codeA && codeB) return codeA.localeCompare(codeB, 'pt-BR', { numeric: true });
                                return (a.descricao || "").localeCompare(b.descricao || "", 'pt-BR', { numeric: true });
                            });

                            itens.forEach(obra => {
                                const isAnalytical = !!(obra.itens && Array.isArray(obra.itens));
                                const iconClassRow = obra.arquivo_url && obra.arquivo_url.endsWith('.pdf') ? 'icon-pdf' : (isAnalytical ? 'icon-generic' : 'icon-xls');
                                const iconSymbol = obra.arquivo_url && obra.arquivo_url.endsWith('.pdf') ? '<i class="bi bi-file-earmark-pdf"></i>' : (isAnalytical ? '<i class="bi bi-calculator"></i>' : '<i class="bi bi-file-earmark-spreadsheet"></i>');
                                const dataFormatada = new Date(obra.created_at || obra.data).toLocaleDateString('pt-BR');

                                const historico = obra.comentarios_revisao || [];
                                const qtdComentarios = historico.length;
                                let badgeStatus = '';
                                const temPendenteComp = historico.some(c => c.decisao === 'pendente');
                                if (temPendenteComp) {
                                    badgeStatus = `<span class="badge bg-warning text-dark ms-2" style="font-size:0.65rem">Em Revisão</span>`;
                                } else if (obra.status === 'Atualizado' || parseInt(String(obra.versao_atual || '').replace(/[^0-9]/g, '')) > 1) {
                                    badgeStatus = `<span class="badge badge-status-atualizado">Atualizado</span>`;
                                }

                                const histId = `hist_comp_v2_${obra.id}`;
                                let botaoHistorico = qtdComentarios > 0 ? `<button class="btn-toggle-history" type="button" data-bs-toggle="collapse" data-bs-target="#${histId}"><i class="bi bi-clock-history"></i> Histórico (${qtdComentarios}) <i class="bi bi-chevron-down ms-1"></i></button>` : '';

                                let containerHistoricoHtml = '';
                                if (qtdComentarios > 0) {
                                    const listaComentarios = historico.map((c, idx) => {
                                        const dC = c.data ? new Date(c.data).toLocaleDateString('pt-BR') : '-';
                                        let clSt = '', bD = '', rA = '', bAA = '';
                                        if (c.autor && c.autor.toLowerCase().includes('sistema')) clSt = 'system-log-entry';
                                        if (c.decisao === 'atendido') {
                                            clSt = 'status-atendido'; bD = `<span class="badge-decision badge-atendido"><i class="bi bi-check-lg"></i> ATENDIDO</span>`;
                                            if (c.resp_admin) rA = `<div class="mt-2 pt-2 border-top small text-success"><strong>Resposta:</strong> ${c.resp_admin}</div>`;
                                        } else if (c.decisao === 'recusado') {
                                            clSt = 'status-recusado'; bD = `<span class="badge-decision badge-recusado"><i class="bi bi-x-lg"></i> NÃO ACATADO</span>`;
                                            if (c.resp_admin) rA = `<div class="mt-2 pt-2 border-top small text-danger"><strong>Motivo:</strong> ${c.resp_admin}</div>`;
                                        } else if (isAdmin && !clSt.includes('system')) {
                                            bAA = `<div class="admin-decision-actions"><button class="btn btn-sm btn-outline-success" onclick="abrirModalAtenderComposicao(${obra.id}, ${idx})"><i class="bi bi-check-lg"></i> Atender</button><button class="btn btn-sm btn-outline-danger" onclick="abrirModalRecusarComposicao(${obra.id}, ${idx})"><i class="bi bi-x-lg"></i> Não Acatar</button></div>`;
                                        }
                                        let bAnex = c.arquivo ? `<a href="${c.arquivo}" target="_blank" class="btn-history-anexo mt-2"><i class="bi bi-paperclip"></i> Ver Memória Anexo</a>` : '';
                                        let bExc = isAdmin ? `<button class="btn btn-sm text-danger border-0 p-0 ms-2 admin-only" title="Excluir Registro" onclick="deletarItemHistoricoComposicao(${obra.id}, ${idx})"><i class="bi bi-x-lg"></i></button>` : '';
                                        return `<div class="history-card-item ${clSt}"><div class="history-card-header"><div><strong>${c.autor}</strong> <span class="fw-normal ms-1">- ${dC}</span></div><div class="d-flex align-items-center">${bD}${bExc}</div></div><div class="history-card-body"><div>${c.mensagem}</div>${bAnex}${rA}${bAA}</div></div>`;
                                    }).join('');
                                    containerHistoricoHtml = `<div class="collapse" id="${histId}"><div class="history-collapse-box">${listaComentarios}</div></div>`;
                                }

                                const historicoObra = obra.historico_versoes || [];
                                const autorV1 = String((historicoObra[0] && historicoObra[0].autor) ? historicoObra[0].autor : (obra.criador_nome || obra.criador_email || 'Administrador/Legado'));
                                const isOwner = (userEmail && autorV1.toUpperCase().includes(userEmail.toUpperCase())) || (currentUserName && autorV1.toUpperCase().includes(currentUserName)) || (currentFiscalName && autorV1.toUpperCase().includes(currentFiscalName));

                                itensHtml += `
                                <div class="mb-2">
                                    <div class="orcamento-item-row" style="margin-bottom:0; border-radius: 8px 8px ${qtdComentarios > 0 ? '0 0' : '8px 8px'};">
                                        <div class="d-flex align-items-center">
                                            <div class="file-icon-box ${iconClassRow}">${iconSymbol}</div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div class="d-flex align-items-center mb-1">
                                                    <span class="text-secondary small me-2" style="font-family: monospace; font-weight: 700; letter-spacing: 0.5px;">#${obra.codigo || 'S/C'}</span>
                                                    <span class="badge bg-dark ms-1" style="font-size:0.65rem; font-weight: 700; border-radius: 4px; padding: 2px 6px;">${obra.versao_atual || 'V1'}</span>
                                                    ${badgeStatus}
                                                </div>
                                                <div class="fw-bold text-dark pe-3" style="font-size:0.95rem; text-align: justify; line-height: 1.4;">
                                                    ${obra.descricao || "Sem Descrição"}
                                                </div>
                                                <div class="text-muted mt-1" style="font-size:0.75rem;">
                                                    ${isSop ? ' • Criado por: Setor de Orçamento da SOP' : `Subcategoria: ${obra.subcategoria || 'GERAL'} • Criado por: ${autorV1} em ${dataFormatada}`}
                                                </div>
                                                ${botaoHistorico}
                                            </div>
                                        </div>
                                        <div class="orcamento-actions">
                                            <button class="btn btn-action-baixar" onclick="prepararExportacaoComposicao(${obra.id}, '${obra.arquivo_url || ''}')" title="Baixar Composição"><i class="bi bi-download"></i> Baixar</button>
                                            <button class="btn btn-action-icon ms-1" onclick="visualizarComposicao(${obra.id}, '${obra.arquivo_url || ''}')" title="Visualizar Documento"><i class="bi bi-eye-fill text-primary"></i></button>
                                            ${(isOwner || isAdmin) ? `
                                                ${isAnalytical ?
                                            `<button class="btn btn-action-icon" onclick="editarComposicaoAnalitica(${obra.id})" title="Alterar Composição"><i class="bi bi-pencil-square text-primary"></i></button>` :
                                            `<button class="btn btn-action-icon" onclick="prepararNovaVersaoComposicao(${obra.id})" title="Alterar Versão"><i class="bi bi-cloud-arrow-up-fill icon-cloud"></i></button>`
                                        }
                                            ` : ''}
                                            <button class="btn btn-action-icon" onclick="prepararComentarioComposicao(${obra.id})" title="Adicionar Comentário"><i class="bi bi-chat-left-text-fill text-warning"></i></button>
                                            ${(isOwner || isAdmin) ? `
                                                <button class="btn btn-action-icon" onclick="deletarComposicao(${obra.id}, '${obra.arquivo_path}')" title="Excluir Composição"><i class="bi bi-trash-fill icon-trash"></i></button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${containerHistoricoHtml}
                                </div>`;
                            });

                            html += `
                            <div class="accordion-custom-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button accordion-custom-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" style="${accordionStyle}">
                                        <i class="${iconClassHeader}"></i> ${titleLabel} <span class="badge bg-white text-dark ms-2 opacity-75" style="font-size: 0.65rem;">${itens.length}</span>
                                    </button>
                                </h2>
                                <div id="${collapseId}" class="accordion-collapse collapse">
                                    <div class="accordion-body bg-white pt-2">
                                        ${itensHtml}
                                    </div>
                                </div>
                            </div>`;
                        }
                        container.innerHTML = html || '<div class="text-center py-5 text-muted">Nenhuma composição disponível.</div>';
                    } catch (err) {
                        console.error('[ERRO carregarComposicoes]', err);
                        container.innerHTML = `<div class="alert alert-danger">Erro crítico ao carregar composições: ${err.message}</div>`;
                    }
                }

                // --- GLOBAL INIT LISTENERS (Moved out to fix loop) ---
                document.addEventListener('DOMContentLoaded', () => {
                    // Initial Load
                    carregarComposicoes();

                    // Search Listener
                    document.getElementById('comp-search')?.addEventListener('input', debounce(() => {
                        carregarComposicoes();
                    }, 500));

                    // Clear Listener
                    document.getElementById('btn-comp-clear')?.addEventListener('click', () => {
                        const input = document.getElementById('comp-search');
                        if (input) {
                            input.value = '';
                            carregarComposicoes();
                        }
                    });

                    // Fix Modals Position
                    const modaisParaMover = [
                        'modalCadastrarComposicao', 'modalNovaVersaoComposicao', 'modalAtenderComposicao',
                        'modalRecusarComposicao', 'modalCriarComposicaoAnalitica', 'modalBuscarItemComposicao',
                        'modalComentarioOrcamento', 'modalComentarioComposicao', 'modalExportarComposicao'
                    ];
                    modaisParaMover.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && el.parentElement !== document.body) document.body.appendChild(el);
                    });
                });

                // --- LÓGICA ABA COMPOSIÇÕES ---

                // --- STATE MANAGEMENT ---
                let currentCompositionItems = [];

                // 2.1 ABRIR CRIADOR (Ensure Global Scope)
                window.abrirCriadorComposicao = async function () {
                    try {
                        const modalEl = document.getElementById('modalCriarComposicaoAnalitica');
                        if (!modalEl) {
                            alert('Erro: Modal de criação não encontrado.');
                            return;
                        }

                        // Reset State
                        currentCompositionItems = [];
                        const editIdEl = document.getElementById('edit-id-composicao');
                        if (editIdEl) editIdEl.value = ''; // Limpa ID de edição

                        const form = document.getElementById('formComposicaoAnalitica');
                        if (form) form.reset();

                        const tbody = document.getElementById('tbody-itens-composicao');
                        if (tbody) tbody.innerHTML = '<tr class="text-center text-muted" id="placeholder-itens-vazio"><td colspan="8" class="py-4">Nenhum item adicionado. Clique em "Adicionar Item".</td></tr>';

                        if (document.getElementById('total-material')) document.getElementById('total-material').textContent = 'R$ 0,00';
                        if (document.getElementById('total-mao-de-obra')) document.getElementById('total-mao-de-obra').textContent = 'R$ 0,00';
                        if (document.getElementById('total-equipamentos')) document.getElementById('total-equipamentos').textContent = 'R$ 0,00';
                        if (document.getElementById('total-servico')) document.getElementById('total-servico').textContent = 'R$ 0,00';
                        if (document.getElementById('total-geral')) document.getElementById('total-geral').textContent = 'R$ 0,00';

                        bootstrap.Modal.getOrCreateInstance(modalEl).show();
                    } catch (err) {
                        console.error('Erro ao abrir criador:', err);
                        alert('Erro ao abrir o criador de composição: ' + err.message);
                    }
                }

                window.editarComposicaoAnalitica = async function (id) {
                    try {
                        const { data, error } = await sbClient
                            .from('composicoes_biblioteca')
                            .select('*')
                            .eq('id', id)
                            .single();

                        if (error) throw error;

                        const modalEl = document.getElementById('modalCriarComposicaoAnalitica');
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

                        // Preencher campos básicos
                        document.getElementById('edit-id-composicao').value = data.id;
                        document.getElementById('comp-codigo').value = data.codigo || '';
                        document.getElementById('comp-descricao').value = data.descricao || '';
                        document.getElementById('comp-unidade').value = data.unidade || '';
                        document.getElementById('comp-data').value = data.data_base || '';
                        document.getElementById('comp-bdi').value = data.bdi || '0,00';
                        document.getElementById('comp-desconto').value = data.desconto || '0,00';

                        // Carregar Itens
                        currentCompositionItems = data.itens || [];
                        renderizarItensComposicao();
                        atualizarCalculosComposicao();

                        modal.show();
                    } catch (err) {
                        console.error('Erro ao carregar para edição:', err);
                        alert("Erro ao carregar composição: " + err.message);
                    }
                }

                // (Função atualizarVersoesComposicao removida - Lógica movida para Modal de Busca abaixo)

                // 2.2 MODAL BUSCAR ITEM
                async function abrirModalBuscarItem() {
                    document.getElementById('busca-item-termo').value = '';
                    document.getElementById('lista-resultados-itens').innerHTML = '<div class="text-center py-3 text-muted small">Digite algo para buscar...</div>';

                    // Reset Filters to Default
                    document.getElementById('busca-item-fonte').value = 'SEINFRA';

                    // Reset UI Mode
                    toggleBuscaItemMode();

                    await atualizarVersoesBusca(); // Load initial versions

                    new bootstrap.Modal(document.getElementById('modalBuscarItemComposicao')).show();
                }

                window.toggleBuscaItemMode = function () {
                    const fonte = document.getElementById('busca-item-fonte').value;
                    const containerBusca = document.getElementById('container-busca-item');
                    const listaResultados = document.getElementById('lista-resultados-itens');
                    const formMercado = document.getElementById('form-cadastro-mercado');
                    const versao = document.getElementById('busca-item-versao');
                    const ref = document.getElementById('busca-item-referencia');

                    if (fonte === 'MERCADO') {
                        containerBusca.classList.add('d-none');
                        listaResultados.classList.add('d-none');
                        formMercado.classList.remove('d-none');
                        versao.disabled = true;
                        ref.disabled = true;
                    } else {
                        containerBusca.classList.remove('d-none');
                        listaResultados.classList.remove('d-none');
                        formMercado.classList.add('d-none');
                        versao.disabled = false;
                        ref.disabled = false;
                        atualizarVersoesBusca();
                    }
                }

                // Currency Input Mask
                window.formatMoneyInput = function (input) {
                    let value = input.value.replace(/\D/g, '');
                    if (value === '') return;

                    const numberValue = parseFloat(value) / 100;
                    input.value = numberValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    calcularPrecoRetroativo(); // Trigger recalc
                }

                window.calcularPrecoRetroativo = function () {
                    const rawPreco = document.getElementById('mercado-preco').value.replace(/\./g, '').replace(',', '.');
                    const preco = parseFloat(rawPreco) || 0;

                    const parseIndex = (val) => {
                        if (!val) return 0;
                        return parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0;
                    };

                    const indIni = parseIndex(document.getElementById('mercado-ind-ini').value);
                    const indFin = parseIndex(document.getElementById('mercado-ind-fin').value);
                    const elResult = document.getElementById('mercado-preco-calc');

                    if (preco > 0 && indIni > 0 && indFin > 0) {
                        const novoPreco = preco * (indFin / indIni);
                        elResult.textContent = novoPreco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        elResult.dataset.value = novoPreco; // Store raw value
                    } else {
                        elResult.textContent = 'R$ 0,00';
                        delete elResult.dataset.value;
                    }
                }

                // Index Input Mask (3 decimals)
                window.formatIndexInput = function (input) {
                    let value = input.value.replace(/\D/g, '');
                    if (value === '') return;

                    const numberValue = parseFloat(value) / 1000;
                    // Force 3 decimal places
                    input.value = numberValue.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
                    calcularPrecoRetroativo();
                }

                // Listeners removed (handled by oninput)

                window.adicionarItemMercadoManual = function () {
                    const desc = document.getElementById('mercado-desc').value.trim();
                    const unid = document.getElementById('mercado-unid').value.trim().toUpperCase();
                    // Check if calculated price exists
                    const calcPrice = document.getElementById('mercado-preco-calc').dataset.value;

                    const rawPreco = document.getElementById('mercado-preco').value.replace(/\./g, '').replace(',', '.');
                    let preco = parseFloat(rawPreco);

                    if (calcPrice) {
                        // FIX: Ensure 2-decimal precision to match Memory Calculation
                        preco = parseFloat(parseFloat(calcPrice).toFixed(2));
                    }

                    const coef = parseFloat(document.getElementById('mercado-coef').value);

                    // Retro Fields
                    const dataIni = document.getElementById('mercado-data-ini').value;
                    const indIni = document.getElementById('mercado-ind-ini').value;
                    const dataFin = document.getElementById('mercado-data-fin').value;
                    const indFin = document.getElementById('mercado-ind-fin').value;

                    if (!desc) { alert("Informe a descrição."); return; }
                    if (!unid) { alert("Informe a unidade."); return; }
                    if (isNaN(preco) || preco <= 0) { alert("Preço inválido."); return; }
                    if (isNaN(coef) || coef <= 0) { alert("Coeficiente inválido."); return; }

                    // Construct detailed description if retro
                    let finalDesc = desc;
                    /* // Optional: Append retro info to description? User didn't ask, but it's good practice. 
                       // I will stick to metadata storage for now as user just asked to fill blanks. 
                    */

                    adicionarItemComposicao({
                        fonte: 'MERCADO',
                        versao: new Date().toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).toUpperCase(),
                        referencia: 'COTAÇÃO',
                        codigo: 'COTAÇÃO',
                        descricao: finalDesc,
                        unidade: unid,
                        preco: preco,
                        tipo: 'INSUMO',
                        grupo: 'MATERIAL',
                        coeficiente: coef,
                        anexos: [],
                        retroativo: calcPrice ? { dataIni, indIni, dataFin, indFin, base: rawPreco } : null
                    });

                    // Reset Form
                    document.getElementById('mercado-desc').value = '';
                    document.getElementById('mercado-unid').value = '';
                    document.getElementById('mercado-preco').value = '';
                    document.getElementById('mercado-coef').value = '1.00'; // Reset validation default

                    document.getElementById('mercado-data-ini').value = '';
                    document.getElementById('mercado-ind-ini').value = '';
                    document.getElementById('mercado-data-fin').value = '';
                    document.getElementById('mercado-ind-fin').value = '';
                    document.getElementById('mercado-preco-calc').textContent = 'R$ 0,00';
                    delete document.getElementById('mercado-preco-calc').dataset.value;

                    bootstrap.Modal.getInstance(document.getElementById('modalBuscarItemComposicao')).hide();
                }

                async function atualizarVersoesBusca() {
                    const fonte = document.getElementById('busca-item-fonte').value;
                    const elVersao = document.getElementById('busca-item-versao');
                    const elRef = document.getElementById('busca-item-referencia');

                    // 1. Lock/Unlock Reference
                    if (fonte === 'ORSE') {
                        elRef.value = 'Onerada';
                        elRef.disabled = true;
                    } else {
                        elRef.disabled = false;
                    }

                    // 2. Populate Versions
                    elVersao.innerHTML = '<option value="">Carregando...</option>';
                    elVersao.disabled = true;

                    let tabela = '';
                    if (fonte === 'SEINFRA') tabela = 'seinfra_itens';
                    else if (fonte === 'SINAPI') tabela = 'sinapi_itens';
                    else if (fonte === 'ORSE') tabela = 'orse_itens';

                    try {
                        let options = [];
                        elVersao.innerHTML = '<option value="">Verificando...</option>';

                        // Define candidates to check against DB (Dynamic 12 months)
                        const mapMes = { 'JAN': '01', 'FEV': '02', 'MAR': '03', 'ABR': '04', 'MAI': '05', 'JUN': '06', 'JUL': '07', 'AGO': '08', 'SET': '09', 'OUT': '10', 'NOV': '11', 'DEZ': '12' };
                        const mapMesLabels = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];

                        let candidates = [];
                        if (fonte === 'SEINFRA') {
                            candidates = ["30", "29", "28", "27", "26"];
                        } else {
                            const now = new Date();
                            for (let i = 0; i < 12; i++) {
                                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                                candidates.push(`${mapMesLabels[d.getMonth()]}/${d.getFullYear()}`);
                            }
                        }

                        if (fonte === 'SEINFRA') {
                            const results = await Promise.all(candidates.map(async v => {
                                const { count } = await sbClient.from('seinfra_itens').select('*', { count: 'exact', head: true }).eq('referencia', v);
                                return { v, count: count || 0 };
                            }));
                            options = results.filter(r => r.count > 0).map(r => r.v);
                            if (options.length === 0) options = ['28', '27'];
                        }
                        else if (fonte === 'SINAPI' || fonte === 'ORSE') {
                            options = [];
                            // Parallel checks for speed
                            const checks = candidates.map(async (label) => {
                                const parts = label.split('/');
                                const mes = mapMes[parts[0].toUpperCase()];
                                const dbDate = `${parts[1]}-${mes}-01`;

                                const { count } = await sbClient
                                    .from(tabela)
                                    .select('*', { count: 'exact', head: true })
                                    .eq('referencia', dbDate); // Check if THIS version exists

                                return { label, count: count || 0 };
                            });

                            const results = await Promise.all(checks);
                            options = results.filter(r => r.count > 0).map(r => r.label);

                            // Fallback if DB empty or query fails (prevents empty dropdown)
                            if (options.length === 0) options = ['DEZ/2025'];
                        }

                        // Render
                        if (options.length === 0) {
                            elVersao.innerHTML = '<option value="">Sem versões</option>';
                        } else {
                            elVersao.innerHTML = options.map(v => `<option value="${v}">${fonte === 'SEINFRA' ? '0' + v : v}</option>`).join('');
                        }

                        elVersao.disabled = false;

                    } catch (e) {
                        console.error(e);
                        elVersao.innerHTML = '<option value="Padrao">Padrão</option>';
                    }
                }

                async function executarBuscaItemComposicao() {
                    const fonte = document.getElementById('busca-item-fonte').value;
                    const termo = document.getElementById('busca-item-termo').value.trim();
                    const lista = document.getElementById('lista-resultados-itens');

                    // Filters from Search Modal
                    const versaoSelecionada = document.getElementById('busca-item-versao').value;
                    const refSelecionada = document.getElementById('busca-item-referencia').value;

                    if (termo.length < 2) { alert("Digite pelo menos 2 letras."); return; }

                    lista.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Buscando...</div>';

                    let tabela = '';
                    if (fonte === 'SEINFRA') tabela = 'seinfra_itens';
                    else if (fonte === 'SINAPI') tabela = 'sinapi_itens';
                    else if (fonte === 'ORSE') tabela = 'orse_itens';

                    let query = sbClient
                        .from(tabela)
                        .select('*')
                        .or(`codigo.ilike.%${termo}%,descricao.ilike.%${termo}%`);

                    // Helper: Convert "DEZ/2025" -> "2025-12-01"
                    function converterVersaoParaData(str) {
                        if (!str) return null;
                        const map = { 'JAN': '01', 'FEV': '02', 'MAR': '03', 'ABR': '04', 'MAI': '05', 'JUN': '06', 'JUL': '07', 'AGO': '08', 'SET': '09', 'OUT': '10', 'NOV': '11', 'DEZ': '12' };
                        const parts = str.split('/');
                        if (parts.length !== 2) return str; // Return as is if not matching format
                        const mes = map[parts[0].toUpperCase()];
                        const ano = parts[1];
                        if (mes && ano) return `${ano}-${mes}-01`;
                        return str;
                    }

                    // Apply Filters
                    // 1. Reference (Onerada/Desonerada) -> Mapped to DB column 'tipo_encargo'
                    if (fonte !== 'ORSE' && refSelecionada) {
                        // Use ilike to handle Case Sensitivity (Onerada vs ONERADA)
                        query = query.ilike('tipo_encargo', refSelecionada);
                    }

                    // 2. Version selection -> Mapped to DB column 'referencia'
                    if (versaoSelecionada) {
                        let val = versaoSelecionada;
                        if (fonte === 'SINAPI' || fonte === 'ORSE') {
                            val = converterVersaoParaData(versaoSelecionada);
                        }
                        query = query.eq('referencia', val);
                    }

                    let { data, error } = await query.limit(1000);

                    // --- DIAGNOSTIC FALLBACK ---
                    // If no results or error, try fetching by Term ONLY to inspect DB values
                    if ((!data || data.length === 0) || error) {
                        const previousError = error;
                        console.warn("Search failed or empty, trying diagnostic...", error);

                        // Try simple search without filters
                        const { data: diagData, error: diagError } = await sbClient
                            .from(tabela)
                            .select('*')
                            .or(`codigo.ilike.%${termo}%,descricao.ilike.%${termo}%`)
                            .limit(10); // Show more results to increase chance of finding the right one

                        if (diagData && diagData.length > 0) {
                            // Show items with warning
                            lista.innerHTML = `
                                <div class="alert alert-warning small mb-2">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>Aviso:</strong> Nenhum item exato encontrado com os filtros. Mostrando resultados similares.<br>
                                    Verifique se a Versão/Ref existem no Banco.
                                </div>
                             `;
                            data = diagData;
                            error = null;
                        } else {
                            // Really nothing found
                            if (previousError) {
                                lista.innerHTML = `<div class="text-danger p-2">Erro BD: ${previousError.message}</div>`;
                                return;
                            }
                        }
                    }

                    if (!data || data.length === 0) {
                        lista.innerHTML = '<div class="text-center py-3 text-muted">Nenhum item encontrado com estes filtros.</div>';
                        return;
                    }

                    lista.innerHTML = '';
                    data.forEach(item => {
                        // Padroniza campos
                        const codigo = item.codigo;
                        const desc = item.descricao;
                        const unidade = item.unidade;
                        const preco = item.preco_unitario || item.preco || 0;
                        const tipo = item.tipo_item || (fonte === 'SEINFRA' ? 'INSUMO' : 'ITEM');

                        // Debug visuals
                        const dbRef = item.tipo_encargo || '?';
                        const dbVer = item.referencia || '?';

                        const el = document.createElement('button');
                        el.className = 'list-group-item list-group-item-action p-2';
                        el.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold small">${codigo} - ${desc}</div>
                                    <div class="text-muted" style="font-size:0.7rem">
                                        ${fonte} | ${unidade} | ${tipo} <br>
                                        <span class="text-primary">Ref: ${dbRef} | Ver: ${dbVer}</span>
                                    </div>
                                </div>
                                <div class="fw-bold text-success small">R$ ${parseFloat(preco).toFixed(2)}</div>
                            </div>
                        `;

                        // Use explicit selection to ensure what we add matches strictly what we searched
                        const versao = versaoSelecionada || item.versao || item.data_referencia;
                        const referencia = refSelecionada || item.referencia;

                        el.onclick = () => {
                            adicionarItemComposicao({
                                fonte,
                                versao,
                                referencia,
                                codigo,
                                descricao: desc,
                                unidade,
                                preco: parseFloat(preco),
                                tipo,
                                coeficiente: 1.00
                            });
                            bootstrap.Modal.getInstance(document.getElementById('modalBuscarItemComposicao')).hide();
                        };
                        lista.appendChild(el);
                    });
                }

                // 2.3 ADICIONAR E GERENCIAR ITENS
                function adicionarItemComposicao(item) {
                    // Verifica duplicação
                    const existe = currentCompositionItems.find(i => i.codigo === item.codigo && i.fonte === item.fonte);
                    if (existe) {
                        alert("Este item já está na lista.");
                        return;
                    }

                    // Auto-Detect Group based on Type or Source
                    let grupo = 'MATERIAL'; // Default
                    const tipoUpper = (item.tipo || '').toUpperCase();

                    if (tipoUpper.includes('MÃO') || tipoUpper.includes('MAO') || tipoUpper.includes('SERVENTE') || tipoUpper.includes('PEDREIRO')) {
                        grupo = 'MAO_DE_OBRA';
                    } else if (tipoUpper.includes('EQUIP') || tipoUpper.includes('CAMINHAO') || tipoUpper.includes('BETONEIRA')) {
                        grupo = 'EQUIPAMENTOS';
                    } else if (tipoUpper.includes('SERV')) {
                        grupo = 'SERVICO';
                    } else if (item.fonte === 'SINAPI' && item.tipo_item === 'COMPOSICAO') {
                        grupo = 'MATERIAL';
                    }

                    item.grupo = grupo;

                    currentCompositionItems.push(item);
                    renderizarItensComposicao();
                    atualizarCalculosComposicao();
                }

                function removerItemComposicao(index) {
                    currentCompositionItems.splice(index, 1);
                    renderizarItensComposicao();
                    atualizarCalculosComposicao();
                }

                function atualizarGrupo(index, novoGrupo) {
                    currentCompositionItems[index].grupo = novoGrupo;
                    atualizarCalculosComposicao();
                }

                function toggleGrupo(index) {
                    const item = currentCompositionItems[index];
                    const grupos = ['MATERIAL', 'MAO_DE_OBRA', 'EQUIPAMENTOS', 'SERVICO'];
                    const currentIndex = grupos.indexOf(item.grupo);
                    const nextIndex = (currentIndex + 1) % grupos.length;
                    item.grupo = grupos[nextIndex];
                    renderizarItensComposicao();
                    atualizarCalculosComposicao();
                }

                function renderizarItensComposicao() {
                    const tbody = document.getElementById('tbody-itens-composicao');
                    if (currentCompositionItems.length === 0) {
                        tbody.innerHTML = '<tr class="text-center text-muted" id="placeholder-itens-vazio"><td colspan="8" class="py-4">Nenhum item adicionado. Clique em "Adicionar Item".</td></tr>';
                        return;
                    }

                    // 1. Group Data
                    const groups = {
                        'MAO_DE_OBRA': [],
                        'MATERIAL': [],
                        'EQUIPAMENTOS': [],
                        'SERVICO': []
                    };

                    currentCompositionItems.forEach((item, index) => {
                        const g = item.grupo || 'MATERIAL';
                        if (groups[g]) groups[g].push({ item, index });
                        else groups['MATERIAL'].push({ item, index });
                    });

                    // 2. Render Helper
                    let html = '';

                    const renderSection = (key, title, bgClass) => {
                        const list = groups[key];
                        if (list.length === 0) return '';

                        let sectionHtml = `
                            <tr class="${bgClass} text-center fw-bold text-secondary" style="font-size: 0.75rem; background-color: #e9ecef;">
                                <td colspan="8" class="py-1 border-top">${title}</td>
                            </tr>
                        `;

                        let subTotal = 0;

                        const elBdi = document.getElementById('comp-bdi');
                        const elDesc = document.getElementById('comp-desconto');

                        const parseBrl = (val) => {
                            if (!val) return 0;
                            return parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0;
                        };

                        const bdi = parseBrl(elBdi.value);
                        const desc = parseBrl(elDesc.value);
                        const bdiVal = bdi / 100;
                        const descVal = desc / 100;

                        list.forEach(({ item, index }) => {
                            const precoEfetivo = item.preco;
                            const totalRow = precoEfetivo * item.coeficiente;
                            subTotal += totalRow;

                            const refShort = (item.referencia || '').toLowerCase().includes('desonerada') ? 'Desonerada' : (item.referencia === 'COTAÇÃO' ? 'COTAÇÃO' : 'Onerada');
                            const verShort = (item.versao || '').replace('Tabela ', '');

                            let sourceDisplay = '';
                            if (item.fonte === 'MERCADO') {
                                sourceDisplay = `<span class="badge bg-light text-secondary border me-1" style="font-size:0.65rem">MERCADO</span>`;
                            } else {
                                sourceDisplay = `
                                    <div class="d-flex flex-column align-items-center" style="line-height:1.1;">
                                        <div>
                                            <span class="badge bg-light text-secondary border me-1" style="font-size:0.65rem">${item.fonte}</span>
                                            <span class="fw-bold small">${verShort}</span>
                                        </div>
                                        <small class="text-muted" style="font-size:0.7rem;">${refShort}</small>
                                    </div>
                                `;
                            }

                            sectionHtml += `
                            <tr>
                                <td class="small text-muted text-center" style="font-size: 0.75rem;">${sourceDisplay}</td>
                                <td class="small fw-bold text-center">${item.codigo}</td>
                                <td class="small text-truncate" style="max-width: 550px;" title="${item.descricao}">${item.descricao}</td>
                                <td class="small text-center">${item.unidade}</td>
                                <td class="text-center">
                                    <input type="number" class="form-control form-control-sm text-center p-0 border-0 bg-transparent mx-auto" 
                                        style="max-width: 60px;" 
                                        value="${item.coeficiente}" step="0.0001" min="0"
                                        onchange="atualizarCoeficiente(${index}, this.value)">
                                </td>
                                <td class="text-center small" title="Base: ${item.preco.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}">${precoEfetivo.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td class="text-center fw-bold small text-dark" id="total-linha-${index}">${(totalRow).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn btn-sm btn-link text-secondary p-0" title="Alterar Grupo" onclick="toggleGrupo(${index})"><i class="bi bi-arrow-repeat" style="font-size: 0.9rem;"></i></button>
                                        <button class="btn btn-sm btn-link text-danger p-0" onclick="removerItemComposicao(${index})"><i class="bi bi-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            `;
                        });

                        sectionHtml += `
                            <tr class="bg-light fw-bold" style="font-size: 0.75rem;">
                                <td colspan="6" class="text-end text-muted pe-3">TOTAL ${title}</td>
                                <td class="text-center text-dark">${subTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td></td>
                            </tr>
                        `;
                        return sectionHtml;
                    };

                    html += renderSection('MAO_DE_OBRA', 'MÃO DE OBRA', 'bg-body-secondary');
                    html += renderSection('MATERIAL', 'MATERIAIS', 'bg-body-secondary');
                    html += renderSection('EQUIPAMENTOS', 'EQUIPAMENTOS', 'bg-body-secondary');
                    html += renderSection('SERVICO', 'SERVIÇOS', 'bg-body-secondary');

                    tbody.innerHTML = html;
                }

                function atualizarCoeficiente(index, valor) {
                    const val = parseFloat(valor);
                    if (isNaN(val) || val < 0) return;
                    currentCompositionItems[index].coeficiente = val;
                    const elBdi = document.getElementById('comp-bdi');
                    const elDesc = document.getElementById('comp-desconto');
                    const parseBrl = (val) => val ? parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0 : 0;
                    const bdiVal = parseBrl(elBdi ? elBdi.value : 0) / 100;
                    const descVal = parseBrl(elDesc ? elDesc.value : 0) / 100;
                    const item = currentCompositionItems[index];
                    const precoEfetivo = item.preco;
                    document.getElementById(`total-linha-${index}`).textContent = `${(precoEfetivo * item.coeficiente).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                    atualizarCalculosComposicao();
                }

                function atualizarCalculosComposicao() {
                    let totalMat = 0, totalMao = 0, totalEquip = 0, totalServ = 0;
                    currentCompositionItems.forEach(item => {
                        const totalItem = Math.round((item.preco * item.coeficiente) * 100) / 100;
                        const grupo = item.grupo || 'MATERIAL';
                        if (grupo === 'MAO_DE_OBRA') totalMao = Math.round((totalMao + totalItem) * 100) / 100;
                        else if (grupo === 'EQUIPAMENTOS') totalEquip = Math.round((totalEquip + totalItem) * 100) / 100;
                        else if (grupo === 'SERVICO') totalServ = Math.round((totalServ + totalItem) * 100) / 100;
                        else totalMat = Math.round((totalMat + totalItem) * 100) / 100;
                    });
                    const totalSemBDI = totalMat + totalMao + totalEquip + totalServ;
                    const bdiInput = document.getElementById('comp-bdi');
                    const descInput = document.getElementById('comp-desconto');
                    const parseBrl = (val) => val ? parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0 : 0;
                    const bdiPercent = bdiInput ? parseBrl(bdiInput.value) : 0;
                    const descPercent = descInput ? parseBrl(descInput.value) : 0;

                    const totalComBDI = Math.round((totalSemBDI * (1 + (bdiPercent / 100))) * 100) / 100;
                    const valorBDI = Math.round((totalComBDI - totalSemBDI) * 100) / 100;
                    const valorDesconto = Math.round((totalComBDI * (descPercent / 100)) * 100) / 100;
                    const totalFinal = Math.round((totalComBDI - valorDesconto) * 100) / 100;

                    if (document.getElementById('total-material')) document.getElementById('total-material').textContent = `R$ ${totalMat.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (document.getElementById('total-mao-de-obra')) document.getElementById('total-mao-de-obra').textContent = `R$ ${totalMao.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (document.getElementById('total-equipamentos')) document.getElementById('total-equipamentos').textContent = `R$ ${totalEquip.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (document.getElementById('total-servico')) document.getElementById('total-servico').textContent = `R$ ${totalServ.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (document.getElementById('total-bdi')) document.getElementById('total-bdi').textContent = `R$ ${valorBDI.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (document.getElementById('total-desconto')) document.getElementById('total-desconto').textContent = `R$ ${valorDesconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (document.getElementById('total-geral')) document.getElementById('total-geral').textContent = `R$ ${totalFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

                // 3.4 SALVAR COMPOSIÇÃO ANALÍTICA (CREATE)
                async function salvarComposicaoAnalitica() {
                    if (currentCompositionItems.length === 0) { alert("Adicione pelo menos um item à composição."); return; }

                    const form = document.getElementById('formComposicaoAnalitica');
                    if (!form.checkValidity()) { form.reportValidity(); return; }

                    const btn = document.getElementById('btn-salvar-comp-analitica');
                    const textoOriginal = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> SALVANDO...';

                    try {
                        const formData = new FormData(form);
                        const nomeObra = (formData.get('descricao') || 'SEM DESCRIÇÃO').toUpperCase();

                        // --- LÓGICA DE AUTO-CATEGORIZAÇÃO PARA USUÁRIO ---
                        let userEmail = localStorage.getItem('sop_user') || 'SISTEMA';
                        let userName = localStorage.getItem('sop_user_name');

                        // Ajuste se o email for apenas a matricula (sem @)
                        if (userEmail !== 'SISTEMA' && !userEmail.includes('@')) {
                            // Remove espaços da matrícula para gerar um email válido (evita erro de formato no DB)
                            const matriculaLimpa = userEmail.replace(/\s+/g, '');
                            userEmail = `${matriculaLimpa}@gecope.app`;
                        }

                        // Se o nome no storage for nulo ou parece uma matrícula (só números), tenta buscar no banco AGORA e AGUARDA
                        if (!userName || /^\d+$/.test(userName)) {
                            console.log('[DEBUG] Nome ausente ou matricula detectada. Buscando dados completos...');
                            // Tenta buscar pelo email exato ou pela matrícula (se o email foi construído)
                            const { data: userData } = await sbClient.from('app_users')
                                .select('full_name, nome, sobrenome')
                                .eq('email', userEmail)
                                .maybeSingle(); // Usa maybeSingle para não lançar erro se não achar

                            if (userData) {
                                if (userData.full_name && !/^\d+$/.test(userData.full_name)) {
                                    userName = userData.full_name;
                                } else if (userData.nome) {
                                    userName = (userData.nome + (userData.sobrenome ? ' ' + userData.sobrenome : '')).toUpperCase();
                                }

                                if (userName) localStorage.setItem('sop_user_name', userName);
                            }
                        }

                        // Fallback final: Deriva do email ou do login original
                        if ((!userName || /^\d+$/.test(userName)) && userEmail !== 'SISTEMA') {
                            // Tenta usar o login original (que pode ser o nome "GECOPE DIFOR") ou parte do email
                            const loginOriginal = localStorage.getItem('sop_user');
                            if (loginOriginal && !loginOriginal.includes('@') && !/^\d+$/.test(loginOriginal)) {
                                userName = loginOriginal.toUpperCase();
                            } else {
                                const namePart = userEmail.split('@')[0];
                                userName = namePart.replace(/\./g, ' ').toUpperCase();
                            }
                        }

                        // Se chegar aqui e ainda for só número, tenta prefixar algo para não ficar estranho
                        if (/^\d+$/.test(userName)) {
                            userName = "USUÁRIO " + userName;
                        }

                        const categoriaFinal = (userName || 'OUTROS').toUpperCase();
                        const subcategoriaFinal = 'COMPOSIÇÕES PRÓPRIAS';

                        // Salva no Banco - payload completo para suporte analítico
                        const payload = {
                            descricao: nomeObra,
                            usuario: categoriaFinal,
                            subcategoria: subcategoriaFinal,
                            codigo: formData.get('codigo') || 'S/C',
                            unidade: formData.get('unidade') || '-',
                            fonte: 'PRÓPRIA',
                            data_base: formData.get('data_base') || '',
                            bdi: formData.get('bdi') || '0,00',
                            desconto: formData.get('desconto') || '0,00',
                            itens: currentCompositionItems, // JSONB com os itens
                            status: 'Em Revisão'
                        };

                        const idEdicao = document.getElementById('edit-id-composicao').value;
                        let res;

                        if (idEdicao) {
                            // MODO EDIÇÃO: Busca histórico atual para anexar nova alteração
                            const { data: current } = await sbClient.from('composicoes_biblioteca').select('historico_versoes').eq('id', idEdicao).single();
                            const hist = current ? (current.historico_versoes || []) : [];
                            hist.push({
                                versao: 'Edit',
                                data: new Date().toISOString(),
                                descricao: 'Alteração via Editor Analítico',
                                autor: userName || userEmail
                            });
                            payload.historico_versoes = hist;

                            res = await sbClient.from('composicoes_biblioteca').update(payload).eq('id', idEdicao);
                        } else {
                            // MODO CRIAÇÃO
                            payload.versao_atual = 'V1';
                            payload.historico_versoes = [{
                                versao: 'V1',
                                data: new Date().toISOString(),
                                descricao: 'Criação via Criador Analítico',
                                autor: userName || userEmail
                            }];
                            res = await sbClient.from('composicoes_biblioteca').insert([payload]);
                        }

                        if (res.error) throw new Error(res.error.message);

                        alert("Composição salva com sucesso!");
                        bootstrap.Modal.getInstance(document.getElementById('modalCriarComposicaoAnalitica')).hide();

                        // Atualiza a lista
                        carregarComposicoes();

                    } catch (error) {
                        console.error(error);
                        alert("Erro ao salvar: " + error.message);
                    } finally {
                        if (btn) { btn.disabled = false; btn.innerHTML = textoOriginal; }
                    }
                }


                // --- LÓGICA EXPORTAÇÃO E TABELAS ---
                // currentTabelaData já declarado globalmente
                let compositionDataToExport = null;
                window.exportarComposicao = exportarComposicao;

                async function executarBuscaTabela() {
                    const fonte = document.getElementById('busca-fonte').value;
                    const versaoBase = document.getElementById('busca-versao').value;
                    const tipoRef = document.getElementById('busca-ref').value;
                    const termo = document.getElementById('busca-input-termo').value.trim();
                    const areaResultados = document.getElementById('area-resultados-tabela');
                    const tbody = document.getElementById('tabela-precos-body');
                    const contador = document.getElementById('contador-resultados');

                    if (!termo || termo.length < 2) { alert("Digite ao menos dois caracteres para pesquisar."); return; }

                    let nomeTabela = '', dataFormatada = '';
                    if (fonte === 'SEINFRA') nomeTabela = 'seinfra_itens';
                    else if (fonte === 'SINAPI') {
                        nomeTabela = 'sinapi_itens';
                        if (versaoBase.length === 6) dataFormatada = `${versaoBase.substring(2)}-${versaoBase.substring(0, 2)}-01`;
                    } else if (fonte === 'ORSE') {
                        nomeTabela = 'orse_itens';
                        if (versaoBase.includes('/')) { const p = versaoBase.split('/'); dataFormatada = `${p[1]}-${p[0]}-01`; }
                    }

                    areaResultados.style.display = 'block';
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-success"></div><div class="mt-2 text-muted small">Buscando na base de dados...</div></td></tr>';

                    try {
                        let query = sbClient.from(nomeTabela).select('*');
                        if (fonte === 'SEINFRA') query = query.eq('referencia', versaoBase);
                        else query = query.eq('referencia', dataFormatada);

                        // Busca por Código OU Descrição e limite estendido conforme solicitado (1000 itens)
                        query = query.eq('tipo_encargo', tipoRef)
                            .or(`codigo.ilike.%${termo}%,descricao.ilike.%${termo}%`)
                            .limit(1000);

                        const { data, error } = await query;
                        if (error) throw error;

                        if (!data || data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum item encontrado com os critérios informados.</td></tr>';
                            contador.textContent = '0 itens';
                            return;
                        }

                        currentTabelaData = data;
                        renderTabelaResults(data);
                    } catch (err) {
                        console.error(err);
                        tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Erro ao buscar: ${err.message}</td></tr>`;
                    }
                }

                function limparBuscaTabela() {
                    document.getElementById('busca-input-termo').value = '';
                    document.getElementById('busca-desc').value = '';
                    document.getElementById('busca-bdi').value = '';
                    document.getElementById('area-resultados-tabela').style.display = 'none';
                    document.getElementById('tabela-precos-body').innerHTML = '';
                    document.getElementById('contador-resultados').textContent = '0 itens';
                    currentTabelaData = [];
                }

                function recalcTabela() {
                    if (currentTabelaData && currentTabelaData.length > 0) renderTabelaResults(currentTabelaData);
                }

                function gerarLinkOrse(codigo, referencia) {
                    if (!referencia || referencia.length < 10) return "#";
                    try {
                        const dateObj = new Date(referencia);
                        const ano = dateObj.getUTCFullYear();
                        const mes = dateObj.getUTCMonth() + 1;
                        const codigoLimpo = codigo.replace(/^[Ss]/, '');
                        return `https://orse.cehop.se.gov.br/composicao.asp?font_sg_fonte=ORSE&serv_nr_codigo=${codigoLimpo}&peri_nr_ano=${ano}&peri_nr_mes=${mes}&peri_nr_ordem=1`;
                    } catch (e) { console.error("Erro gerarLinkOrse", e); return "#"; }
                }

                function gerarLinkSeinfra(codigo, tipoRef) {
                    const timestamp = Date.now();
                    return `https://sin.seinfra.ce.gov.br/site-seinfra/siproce/${tipoRef.toLowerCase()}/html/${codigo}.html?a=${timestamp}`;
                }

                function renderTabelaResults(lista) {
                    const tbody = document.getElementById('tabela-precos-body');
                    const contador = document.getElementById('contador-resultados');
                    const bdiVal = parseFloat(document.getElementById('busca-bdi').value) || 0;
                    const descVal = parseFloat(document.getElementById('busca-desc').value) || 0;
                    const fonte = document.getElementById('busca-fonte').value;
                    const tipoRef = document.getElementById('busca-ref').value;
                    const versaoBase = document.getElementById('busca-versao').value;
                    contador.textContent = `${lista.length} itens`;

                    tbody.innerHTML = lista.map(item => {
                        let valorBase = parseFloat(item.valor_unitario || item.preco_unitario || item.valor || item.preco || 0);
                        const valorFinal = valorBase * (1 + bdiVal / 100) * (1 - descVal / 100);
                        const stylePreco = (bdiVal > 0 || descVal > 0) ? 'color: #d63384 !important;' : 'color: var(--sop-gray-dark);';

                        let btnAction = '';
                        if (fonte === 'ORSE') {
                            const link = gerarLinkOrse(item.codigo, item.referencia);
                            btnAction = `<a href="${link}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver Composição no ORSE"><i class="bi bi-box-arrow-up-right"></i></a>`;
                        } else if (fonte === 'SEINFRA') {
                            const link = gerarLinkSeinfra(item.codigo, tipoRef);
                            btnAction = `<a href="${link}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver Composição no SEINFRA"><i class="bi bi-box-arrow-up-right"></i></a>`;
                        } else {
                            btnAction = `<button class="btn btn-sm btn-light border" onclick="abrirDetalheTabela('${item.codigo}', '${fonte}', '${versaoBase}', '${tipoRef}')"><i class="bi bi-chevron-right"></i></button>`;
                        }

                        return `<tr>
                            <td class="text-center small fw-bold text-secondary ps-3">${item.identificacao || '-'}</td>
                            <td class="fw-bold text-primary text-center">${item.codigo}</td>
                            <td class="text-uppercase small">${item.descricao}</td>
                            <td class="text-center small fw-bold">${item.unidade}</td>
                            <td class="text-end pe-3 fw-bold" style="${stylePreco}">${valorFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                            <td class="text-end pe-3">${btnAction}</td>
                        </tr>`;
                    }).join('');
                }

                function renderizarComposicaoSINAPI(dadosPai, modalBody) {
                    if (!dadosPai || !dadosPai.composicao || !Array.isArray(dadosPai.composicao)) return;

                    const formatCurrency = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const formatDecimal = (v, d = 3) => Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: d, maximumFractionDigits: d });

                    const codigo = dadosPai.codigo || 'N/A';
                    const descricao = (dadosPai.descricao || 'SEM DESCRIÇÃO').toUpperCase();
                    const unidade = dadosPai.unidade || 'N/A';
                    const versaoRef = formatarVersao(dadosPai.referencia || '');

                    // Agrupamento por tipo (Insumo/Composição)
                    const grupos = {};
                    let totalGeral = 0;

                    dadosPai.composicao.forEach(item => {
                        const tipo = (item.tipo_item || 'INSUMO').toUpperCase().replace('COMPOSICAO', 'COMPOSIÇÃO');
                        if (!grupos[tipo]) grupos[tipo] = [];
                        const subtotal = (parseFloat(item.coeficiente) || 0) * (parseFloat(item.preco_unitario) || 0);
                        totalGeral += subtotal;
                        grupos[tipo].push({ ...item, total: subtotal });
                    });

                    let tableRows = '';
                    Object.keys(grupos).sort().forEach(tipo => {
                        tableRows += `
                            <tr style="background-color: #e8e8e8; font-size: 0.8rem; font-weight: bold;">
                                <td colspan="8" style="padding: 0.6rem 0.5rem; color: #333; text-align: center; text-uppercase;">${tipo}</td>
                            </tr>
                        `;

                        let subtotalGrupo = 0;
                        grupos[tipo].forEach(item => {
                            subtotalGrupo += item.total;
                            tableRows += `
                                <tr style="font-size: 0.8rem; border-bottom: 1px solid #eee;">
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">SINAPI</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${versaoRef}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center; font-weight: bold;">${item.codigo_item || item.codigo}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: justify;">${(item.descricao_item || item.descricao || '').toUpperCase()}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${item.unidade || '-'}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${formatDecimal(item.coeficiente)}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: right;">${formatDecimal(item.preco_unitario, 2)}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: right; font-weight: bold;">${formatDecimal(item.total, 2)}</td>
                                </tr>
                            `;
                        });

                        tableRows += `
                            <tr style="font-size: 0.8rem; background-color: #f5f5f5; font-weight: bold; border-top: 1px solid #ddd;">
                                <td colspan="7" style="padding: 0.6rem 0.5rem; text-align: right; color: #666;">TOTAL ${tipo}</td>
                                <td style="padding: 0.6rem 0.5rem; text-align: right; color: #333;">${formatDecimal(subtotalGrupo, 2)}</td>
                            </tr>
                        `;
                    });

                    modalBody.innerHTML = `
                        <div class="p-4 report-print-area" style="font-family: 'Montserrat', sans-serif;">
                            <!-- Cabeçalho Institucional SOP-CE -->
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="d-flex align-items-center">
                                    <div class="text-white p-2 rounded me-3 fw-bold fs-5" style="background-color: #008F3D !important; min-width: 80px; text-align: center;">SINAPI</div>
                                    <div>
                                        <div class="fw-bold fs-6" style="color: #008F3D; line-height: 1.2;">GOVERNO FEDERAL</div>
                                        <div class="text-dark fw-bold" style="font-size: 0.75rem;">SISTEMA NACIONAL DE PESQUISA DE CUSTOS E ÍNDICES DA CONSTRUÇÃO CIVIL</div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <h5 class="fw-bold mb-0 text-dark">COMPOSIÇÃO ANALÍTICA</h5>
                                    <div class="text-muted fw-bold" style="font-size: 0.7rem;">GECOPE - GERÊNCIA DE CONTROLE DE ADITIVOS</div>
                                </div>
                            </div>

                            <!-- Metadados (Estilo SINAPI adaptado) -->
                            <div style="background: white; border: 1px solid #eee; border-left: 6px solid #008F3D; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); padding: 1.5rem 0rem; display: flex; align-items: center; min-height: 100px; margin-bottom: 2rem;">
                                <div style="flex: 0 0 15%; padding: 0 1.5rem; border-right: 1px solid #eee; text-align: center;">
                                    <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.6rem; text-transform: uppercase;">CÓDIGO</small>
                                    <div style="font-size: 1.35rem; font-weight: 800; color: #1a1a1a;">${codigo}</div>
                                </div>
                                <div style="flex: 1; padding: 0 2rem;">
                                    <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.6rem; text-transform: uppercase;">DESCRIÇÃO DA COMPOSIÇÃO</small>
                                    <div style="font-size: 1.05rem; font-weight: 800; color: #1a1a1a; text-transform: uppercase; text-align: justify;">${descricao}</div>
                                </div>
                                <div style="flex: 0 0 12%; padding: 0 1.5rem; border-left: 1px solid #eee; text-align: center;">
                                    <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.6rem; text-transform: uppercase;">UNIDADE</small>
                                    <div style="font-size: 1.35rem; font-weight: 800; color: #1a1a1a;">${unidade}</div>
                                </div>
                            </div>

                            <!-- Tabela de Itens SINAPI -->
                            <div class="table-responsive">
                                <table class="table table-sm align-middle" style="border-collapse: collapse; width: 100%;">
                                    <thead>
                                        <tr style="font-size: 0.75rem; background-color: #f5f5f5; border-top: 2px solid #ddd; border-bottom: 2px solid #ddd;">
                                            <th style="width: 8%;" class="fw-bold text-uppercase p-2">FONTE</th>
                                            <th style="width: 7%;" class="fw-bold text-uppercase p-2">VERSÃO</th>
                                            <th style="width: 8%;" class="fw-bold text-uppercase text-center p-2">CÓDIGO</th>
                                            <th style="width: 48%;" class="fw-bold text-uppercase p-2">DESCRIÇÃO DO INSUMO</th>
                                            <th style="width: 5%;" class="fw-bold text-uppercase text-center p-2">UNID.</th>
                                            <th style="width: 7%;" class="fw-bold text-uppercase text-center p-2">COEF.</th>
                                            <th style="width: 9%;" class="fw-bold text-uppercase text-end p-2">P. UNIT.</th>
                                            <th style="width: 8%;" class="fw-bold text-uppercase text-end p-2">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Preço Total Unitário (Barra Verde SOP) -->
                            <div class="mt-4" style="padding: 1.8rem 2rem; background: linear-gradient(135deg, #008F3D 0%, #007233 100%); color: white; border-radius: 12px;">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <small class="text-white-50 fw-bold d-block mb-1" style="font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase;">Preço Total Unitário (SINAPI)</small>
                                        <div style="font-size: 0.95rem; opacity: 0.9;">Referência: ${versaoRef}</div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div style="font-size: 2.4rem; font-weight: 800;">
                                            <span style="font-size: 1.2rem; vertical-align: middle;">R$</span> ${formatDecimal(totalGeral, 2)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                async function abrirDetalheTabela(codigo, fonte, versao, tipoRef) {
                    const modalEl = document.getElementById('modalDetalheComposicao');
                    if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
                    const modalBody = modalEl.querySelector('.modal-body');
                    modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div><div class="mt-2 small text-muted">Carregando detalhes...</div></div>';
                    modalInstance.show();

                    try {
                        let nomeTabela = 'seinfra_itens';
                        let dataFormatada = versao;
                        if (fonte === 'SINAPI') {
                            nomeTabela = 'sinapi_itens';
                            if (versao.length === 6) dataFormatada = `${versao.substring(2)}-${versao.substring(0, 2)}-01`;
                        }

                        const { data: dadosPai, error } = await sbClient
                            .from(nomeTabela)
                            .select('*')
                            .eq('codigo', codigo)
                            .eq('referencia', dataFormatada)
                            .eq('tipo_encargo', tipoRef)
                            .single();

                        if (error || !dadosPai) {
                            modalBody.innerHTML = '<div class="alert alert-warning m-4 fw-bold text-center">Composição não encontrada no banco de dados.</div>';
                            return;
                        }

                        // ===== DESVIO PARA RENDERIZADOR SINAPI =====
                        if (fonte === 'SINAPI' && dadosPai.composicao && Array.isArray(dadosPai.composicao) && dadosPai.composicao.length > 0) {
                            renderizarComposicaoSINAPI(dadosPai, modalBody);
                            return;
                        }

                        // ===== LÓGICA ANTERIOR (FALLBACK PARA OUTRAS FONTES) =====
                        let itens = (dadosPai && dadosPai.composicao) ? dadosPai.composicao : [];

                        if (itens.length === 0) {
                            const { data: itensDB } = await sbClient
                                .from('tabelas_itens')
                                .select('*')
                                .eq('fonte', fonte)
                                .eq('versao', versao)
                                .eq('referencia_pai_cod', codigo);
                            itens = itensDB || [];
                        }

                        const totalSOPResult = itens.reduce((acc, i) => acc + (parseFloat(i.valor_total || (i.coeficiente * i.preco_unitario)) || 0), 0);
                        const versaoSOP = formatarVersao(versao || dadosPai.referencia || '');

                        modalBody.innerHTML = `
                            <div class="p-4 report-print-area" style="font-family: 'Montserrat', sans-serif;">
                                <!-- Cabeçalho Padronizado -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="text-white p-2 rounded me-3 fw-bold fs-5" style="background-color: #008F3D !important; min-width: 80px; text-align: center;">SOP-CE</div>
                                        <div>
                                            <div class="fw-bold fs-6" style="color: #008F3D;">ESTADO DO CEARÁ</div>
                                            <div class="text-dark fw-bold" style="font-size: 0.75rem;">SUPERINTENDÊNCIA DE OBRAS PÚBLICAS</div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <h5 class="fw-bold mb-0 text-dark">DETALHE DA COMPOSIÇÃO</h5>
                                        <div class="text-muted fw-bold" style="font-size: 0.7rem;">FONTE: ${fonte} / ${versaoSOP}</div>
                                    </div>
                                </div>

                                <!-- Metadados -->
                                <div class="mb-4" style="background: white; border: 1px solid #eee; border-left: 6px solid #F28C00; border-radius: 12px; padding: 1.2rem; display: flex; align-items: center;">
                                    <div class="me-4 border-end pe-4">
                                        <small class="text-muted fw-bold d-block mb-1">CÓDIGO</small>
                                        <div class="fw-bold fs-5">${dadosPai.codigo}</div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <small class="text-muted fw-bold d-block mb-1">DESCRIÇÃO</small>
                                        <div class="fw-bold text-uppercase" style="font-size: 0.95rem;">${dadosPai.descricao}</div>
                                    </div>
                                    <div class="ms-4 border-start ps-4 text-center">
                                        <small class="text-muted fw-bold d-block mb-1">UNID</small>
                                        <div class="fw-bold fs-5">${dadosPai.unidade}</div>
                                    </div>
                                </div>

                                <!-- Tabela -->
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead style="background-color: #f8f9fa;">
                                            <tr class="small fw-bold">
                                                <th class="text-center">ITEM</th>
                                                <th>DESCRIÇÃO DO INSUMO</th>
                                                <th class="text-center">UNID</th>
                                                <th class="text-center">COEF.</th>
                                                <th class="text-end">P. UNIT.</th>
                                                <th class="text-end">TOTAL</th>
                                            </tr>
                                        </thead>
                                        <tbody class="small">
                                            ${itens.map(i => `
                                                <tr>
                                                    <td class="text-center">${i.codigo_item || '-'}</td>
                                                    <td class="text-uppercase">${i.descricao_item || i.descricao}</td>
                                                    <td class="text-center">${i.unidade || '-'}</td>
                                                    <td class="text-center">${parseFloat(i.coeficiente).toLocaleString('pt-BR', { minimumFractionDigits: 4 })}</td>
                                                    <td class="text-end">${parseFloat(i.preco_unitario).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                                    <td class="text-end fw-bold">${parseFloat(i.valor_total || (i.coeficiente * i.preco_unitario)).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Rodapé Total Verde -->
                                <div class="mt-3 p-3 text-white d-flex justify-content-between align-items-center" style="background: #008F3D; border-radius: 8px;">
                                    <div class="fw-bold">PREÇO TOTAL DA COMPOSIÇÃO</div>
                                    <div class="fs-4 fw-bold">R$ ${totalSOPResult.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${e.message}</div>`;
                    }
                }

                async function atualizarSelectVersao() {
                    const fonte = document.getElementById('busca-fonte').value;
                    const selectVersao = document.getElementById('busca-versao');
                    const selectRef = document.getElementById('busca-ref');

                    if (!selectVersao) return;

                    // Mostra estado de carregamento
                    selectVersao.innerHTML = '<option value="">Buscando...</option>';
                    selectVersao.disabled = true;

                    try {
                        if (fonte === 'SEINFRA') {
                            // Verifica versões recentes da SEINFRA (Tabelas de referência do Ceará)
                            const candidates = ["30", "29", "28", "27", "26"];
                            const checks = await Promise.all(candidates.map(async v => {
                                // Verifica se existe dados para esta referência
                                const { count } = await sbClient.from('seinfra_itens').select('*', { count: 'exact', head: true }).eq('referencia', v);
                                return { v, count: count || 0 };
                            }));

                            selectVersao.innerHTML = '';
                            const valids = checks.filter(r => r.count > 0);
                            if (valids.length > 0) {
                                valids.forEach(r => selectVersao.add(new Option(`Tabela 0${r.v}`, r.v)));
                            } else {
                                // Fallback estático
                                ["28", "27"].forEach(t => selectVersao.add(new Option(`Tabela 0${t}`, t)));
                            }
                            selectRef.disabled = false;
                        }
                        else if (fonte === 'SINAPI' || fonte === 'ORSE') {
                            const tabela = (fonte === 'SINAPI') ? 'sinapi_itens' : 'orse_itens';
                            const mapMesLabels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

                            const now = new Date();
                            const candidates = [];

                            // Verifica os últimos 12 meses para encontrar versões disponíveis no banco
                            // Isso garante que se o administrador carregar nov/2025, o sistema detecta sozinho
                            for (let i = 0; i < 12; i++) {
                                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                                const mesIdx = d.getMonth();
                                const ano = d.getFullYear();
                                const mesStr = String(mesIdx + 1).padStart(2, '0');

                                candidates.push({
                                    label: `${mapMesLabels[mesIdx]}/${ano}`,
                                    dbDate: `${ano}-${mesStr}-01`,
                                    sinapiVal: `${mesStr}${ano}`, // Formato MMYYYY esperado pela busca
                                    orseVal: `${mesStr}/${ano}`   // Formato MM/YYYY esperado pela busca
                                });
                            }

                            const checks = await Promise.all(candidates.map(async c => {
                                const { count } = await sbClient.from(tabela).select('*', { count: 'exact', head: true }).eq('referencia', c.dbDate);
                                return { ...c, count: count || 0 };
                            }));

                            selectVersao.innerHTML = '';
                            const valids = checks.filter(r => r.count > 0);
                            if (valids.length > 0) {
                                valids.forEach(r => {
                                    const val = (fonte === 'SINAPI') ? r.sinapiVal : r.orseVal;
                                    selectVersao.add(new Option(r.label, val));
                                });
                            } else {
                                // Fallback se a internet/banco falhar
                                if (fonte === 'SINAPI') selectVersao.add(new Option("Dez/2025", "122025"));
                                else selectVersao.add(new Option("Dez/2025", "12/2025"));
                            }

                            if (fonte === 'ORSE') {
                                selectRef.value = 'onerada';
                                selectRef.disabled = true;
                            } else {
                                selectRef.disabled = false;
                            }
                        }
                    } catch (err) {
                        console.error("Erro ao atualizar versões:", err);
                        // Fallback genérico
                        if (fonte === 'SEINFRA') {
                            selectVersao.innerHTML = '';
                            ["28", "27"].forEach(t => selectVersao.add(new Option(`Tabela 0${t}`, t)));
                        } else {
                            selectVersao.innerHTML = `<option value="${fonte === 'SINAPI' ? '122025' : '12/2025'}">Dez/2025</option>`;
                        }
                    } finally {
                        selectVersao.disabled = false;
                    }
                }
                document.addEventListener('DOMContentLoaded', atualizarSelectVersao);

                // Removida baixarComposicaoPDF pois agora usamos a impressão HTML unificada



                async function prepararExportacaoComposicao(id, urlArquivo) {
                    try {
                        let docData = null;

                        // 1. Se não temos URL ou ela é nula (Composição Analítica Direta no Banco)
                        if (!urlArquivo || urlArquivo === 'undefined' || urlArquivo === 'null' || urlArquivo === '') {
                            const { data, error } = await sbClient.from('composicoes_biblioteca').select('*').eq('id', id).single();
                            if (error || !data) throw new Error("Documento não encontrado no banco.");

                            if (data.itens) {
                                docData = {
                                    meta: {
                                        codigo: data.codigo || 'S/C',
                                        descricao: data.descricao,
                                        unidade: data.unidade || '-',
                                        data_base: data.data_base,
                                        bdi: data.bdi,
                                        desconto: data.desconto,
                                        totais: null
                                    },
                                    itens: data.itens || []
                                };
                            } else {
                                urlArquivo = data.arquivo_url;
                            }
                        }

                        // 2. Se temos URL e NÃO termina em .json, é um arquivo direto (PDF/XLS) -> BAIXAR DIRETO
                        if (urlArquivo && !urlArquivo.toLowerCase().includes('.json')) {
                            const link = document.createElement('a');
                            link.href = urlArquivo;
                            link.download = ''; // Sugere o nome original do arquivo
                            link.target = '_blank';
                            link.click();
                            return;
                        }

                        // 3. Se temos URL e É um .json, buscamos o conteúdo
                        if (urlArquivo && urlArquivo.toLowerCase().includes('.json')) {
                            const finalUrl = `${urlArquivo}?t=${new Date().getTime()}`;
                            const response = await fetch(finalUrl);
                            if (!response.ok) throw new Error("Erro ao baixar dados da composição.");
                            docData = await response.json();
                        }

                        if (docData) {
                            const meta = docData.meta || {};
                            const dados = {
                                codigo: meta.codigo || 'S/C',
                                descricao: meta.descricao,
                                unidade: meta.unidade || '-',
                                data_base: meta.data_base,
                                bdi: meta.bdi,
                                desconto: meta.desconto,
                                itens: docData.itens || [],
                                totais: meta.totais,
                                versao_atual: meta.versao || ''
                            };
                            gerarPDF_Profissional(dados);
                        } else {
                            alert("Esta composição não possui arquivo nem dados analíticos.");
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Erro ao carregar: " + e.message);
                    }
                }

                function exportarComposicao(formato) {
                    if (!compositionDataToExport) return;
                    const meta = compositionDataToExport.meta || {};
                    const dados = {
                        codigo: meta.codigo || 'S/C', descricao: meta.descricao, unidade: meta.unidade, data_base: meta.data_base,
                        bdi: meta.bdi, desconto: meta.desconto, itens: compositionDataToExport.itens || [], totais: meta.totais
                    };
                    if (formato === 'PDF') gerarPDF_Profissional(dados);
                    else if (formato === 'DOCX') gerarDOCX_Profissional(dados);
                    bootstrap.Modal.getInstance(document.getElementById('modalExportarComposicao')).hide();
                }

                const formatarVersao = (texto) => {
                    if (!texto || texto === '-') return '-';
                    const txt = texto.toString().toUpperCase().trim();

                    // Lista de abreviações dos meses
                    const mesesAbrev = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

                    // Mapa de nomes completos para abreviações
                    const mesesMap = {
                        'JANEIRO': 'Jan', 'FEVEREIRO': 'Fev', 'MARÇO': 'Mar', 'ABRIL': 'Abr',
                        'MAIO': 'Mai', 'JUNHO': 'Jun', 'JULHO': 'Jul', 'AGOSTO': 'Ago',
                        'SETEMBRO': 'Set', 'OUTUBRO': 'Out', 'NOVEMBRO': 'Nov', 'DEZEMBRO': 'Dez'
                    };

                    // Caso 1: Detecção de números de versão (Ex: "28.1", "30") -> Manter inalterado
                    if (/^\d+(\.\d+)?$/.test(txt)) return txt;

                    // Caso 2: Tenta encontrar nome do mês por extenso ou abreviado (Ex: "SETEMBRO DE 2024" ou "FEV. DE 2026")
                    const mesesAbrevMap = {
                        'JAN': 'Jan', 'FEV': 'Fev', 'MAR': 'Mar', 'ABR': 'Abr',
                        'MAI': 'Mai', 'JUN': 'Jun', 'JUL': 'Jul', 'AGO': 'Ago',
                        'SET': 'Set', 'OUT': 'Out', 'NOV': 'Nov', 'DEZ': 'Dez'
                    };

                    // Primeiro tenta meses completos (para não casar "MAR" em "MARÇO")
                    for (let mes in mesesMap) {
                        if (txt.includes(mes)) {
                            const anoMatch = txt.match(/\d{4}/);
                            if (anoMatch) return `${mesesMap[mes]}/${anoMatch[0].substring(2)}`;
                        }
                    }

                    // Depois tenta abreviações
                    for (let abrev in mesesAbrevMap) {
                        if (txt.includes(abrev)) {
                            const anoMatch = txt.match(/\d{4}/);
                            if (anoMatch) return `${mesesAbrevMap[abrev]}/${anoMatch[0].substring(2)}`;
                        }
                    }

                    // Caso 3: Parse de datas ISO (YYYY-MM-DD) ou BR (DD/MM/YYYY)
                    let d = null;
                    if (txt.includes('-')) {
                        const p = txt.split('-');
                        if (p.length === 3) d = new Date(p[0], p[1] - 1, p[2]);
                        else if (p.length === 2) d = new Date(p[0], p[1] - 1, 1);
                    } else if (txt.includes('/')) {
                        const p = txt.split('/');
                        if (p.length === 3) d = new Date(p[2], p[1] - 1, p[0]);
                        else if (p.length === 2) {
                            // Se for MM/YYYY (SINAPI/ORSE)
                            const mes = parseInt(p[0]);
                            const ano = p[1];
                            if (mes >= 1 && mes <= 12 && ano.length === 4) {
                                return `${mesesAbrev[mes - 1]}/${ano.substring(2)}`;
                            }
                        }
                    }

                    if (d && !isNaN(d.getTime())) {
                        return `${mesesAbrev[d.getMonth()]}/${d.getFullYear().toString().substring(2)}`;
                    }

                    return texto; // Retorno padrão
                };

                const normalizarItemParaPDF = (item) => {
                    const precoUnit = Number(item.preco_unitario || item.preco || item.p || 0);
                    const coef = Number(item.coeficiente || item.coef || item.c || 0);
                    const total = Number(item.total || item.total_item || item.t || (precoUnit * coef)) || 0;

                    // Mapeamento de nomes de grupo para padrão de exibição
                    const rawGrupo = (item.tipo_grupo || item.grupo || item.g || 'GERAL').toUpperCase();
                    let grupoDisplay = rawGrupo;
                    if (rawGrupo === 'MAO_DE_OBRA' || rawGrupo === 'MAO DE OBRA') grupoDisplay = 'MÃO DE OBRA';
                    else if (rawGrupo === 'SERVICO' || rawGrupo === 'SERVICOS') grupoDisplay = 'SERVIÇO';
                    else if (rawGrupo === 'MATERIAL' || rawGrupo === 'MATERIAIS') grupoDisplay = 'MATERIAL';
                    else if (rawGrupo === 'COMPOSICAO' || rawGrupo === 'COMPOSICOES') grupoDisplay = 'COMPOSIÇÃO';

                    // Fallbacks para Código e Descrição
                    const codigo = item.codigo_insumo || item.codigo_item || item.codigo || item.cod || '-';
                    const descricao = item.descricao_insumo || item.descricao_item || item.descricao || item.desc || '-';
                    const fonte = item.origem || item.fonte || item.fonte_insumo || item.tabela || (item.retroativo ? 'COTAÇÃO' : '-');

                    return {
                        origem: fonte,
                        versao: formatarVersao(item.versao || item.data_tabela || item.data_referencia || item.referencia_tabela || item.retroativo?.dataIni || '-'),
                        codigo: codigo,
                        descricao: descricao,
                        unidade: item.unidade || item.unid || '-',
                        coeficiente: coef,
                        preco_unitario: precoUnit,
                        total: total,
                        grupo: grupoDisplay,
                        referencia: item.referencia || item.tipo_encargo || '',
                        retroativo: item.retroativo || null
                    };
                };

                // --------------------------------------------------------------
                // FUNÇÃO GERAR PDF (Clone Visual 1:1) - Utilizando html2pdf.js
                // --------------------------------------------------------------
                async function gerarPDF_Profissional(rawInput) {
                    if (!rawInput) return;

                    // Feedback visual instantâneo
                    const btnsBaixar = document.querySelectorAll('.btn-action-baixar, .btn-outline-success');
                    const originalTexts = Array.from(btnsBaixar).map(b => b.innerHTML);
                    btnsBaixar.forEach(b => {
                        b.disabled = true;
                        b.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                    });

                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        const verdeSOP = [0, 143, 61];
                        const cinzaHeader = [242, 242, 242];
                        const cinzaTexto = [100, 100, 100];

                        const fCur = (v) => Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        const fNum4 = (v) => Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 4, maximumFractionDigits: 4 });

                        // 1. Cabeçalho Institucional SOP (Fidelidade Absoluta com a Modal)
                        doc.setFillColor(...verdeSOP); doc.roundedRect(14, 10, 20, 10, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255); doc.setFontSize(9); doc.setFont("helvetica", "bold");
                        doc.text("SOP-CE", 24, 16.5, { align: "center" });

                        doc.setTextColor(...verdeSOP); doc.setFontSize(10); doc.text("ESTADO DO CEARÁ", 38, 14);
                        doc.setTextColor(60, 60, 60); doc.setFontSize(7); doc.text("SUPERINTENDÊNCIA DE OBRAS PÚBLICAS", 38, 18);

                        doc.setTextColor(0, 0, 0); doc.setFontSize(11); doc.text("COMPOSIÇÃO ANALÍTICA", 196, 14, { align: "right" });
                        doc.setTextColor(...cinzaTexto); doc.setFontSize(6); doc.text("GEROA - GERÊNCIA DE ORÇAMENTOS E AVALIAÇÃO DE IMÓVEIS", 196, 18, { align: "right" });

                        doc.setDrawColor(200); doc.line(14, 22, 196, 22);

                        // 2. Metadados Grid - Clone idêntico da Imagem 01 (Otimização Máxima de Espaço Central)
                        doc.setDrawColor(220); doc.setFillColor(255);
                        doc.rect(14, 25, 182, 17, 'D');
                        doc.line(34, 25, 34, 42); // Barra 1 (Muito Reduzido)
                        doc.line(170, 25, 170, 42); // Barra 2 (Máximo Expandida: Descrição)
                        doc.line(182, 25, 182, 42); // Barra 3 (Mínimo Unit)

                        doc.setFontSize(5); doc.setTextColor(150); doc.setFont("helvetica", "bold");
                        doc.text("CÓDIGO / VERSÃO", 15.5, 29);
                        doc.text("DESCRIÇÃO DA COMPOSIÇÃO", 36, 29);
                        doc.text("UNID:", 171, 29);

                        doc.setFontSize(8.5); doc.setTextColor(0); doc.setFont("helvetica", "bold");
                        doc.text(rawInput.codigo || 'S/C', 15.5, 35);
                        if (rawInput.versao_atual) {
                            doc.setFontSize(5); doc.roundedRect(26.5, 33, 6, 3, 0.5, 0.5, 'D');
                            doc.text(rawInput.versao_atual, 29.5, 35.2, { align: "center" });
                        }

                        doc.setFontSize(8.5); doc.setTextColor(0);
                        const descLines = doc.splitTextToSize((rawInput.descricao || '').toUpperCase(), 130);
                        doc.text(descLines, 36, 34, { align: "justify" });

                        doc.setFontSize(10); doc.text(rawInput.unidade || '-', 176, 37.5, { align: "center" });

                        // Área BDI (182 a 196)
                        doc.setFontSize(6.5);
                        doc.setTextColor(120); doc.text("BDI:", 183.5, 33);
                        doc.setTextColor(0, 80, 200); doc.setFont("helvetica", "bold"); doc.text(`${rawInput.bdi || '0,00'}%`, 194.5, 33, { align: "right" });
                        doc.setTextColor(120); doc.setFont("helvetica", "normal"); doc.text("DESC:", 183.5, 38.5);
                        doc.setTextColor(200, 0, 0); doc.setFont("helvetica", "bold"); doc.text(`${rawInput.desconto || '0,00'}%`, 194.5, 38.5, { align: "right" });

                        // 3. Preparação dos Itens (Utilizando normalizarItemParaPDF para consistência total com a Modal)
                        const itensRaw = rawInput.itens || [];
                        const itens = itensRaw.map(normalizarItemParaPDF);
                        const retroativos = [];

                        const body = [];
                        const ordemGrupos = ['MÃO DE OBRA', 'MATERIAL', 'EQUIPAMENTOS', 'SERVIÇO', 'GERAL'];
                        const itensAgrupados = itens.reduce((acc, item) => {
                            const g = item.grupo || 'GERAL';
                            if (!acc[g]) acc[g] = [];
                            acc[g].push(item);
                            return acc;
                        }, {});

                        const gruposDisponiveis = Object.keys(itensAgrupados).sort((a, b) => {
                            const idxA = ordemGrupos.indexOf(a);
                            const idxB = ordemGrupos.indexOf(b);
                            return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
                        });

                        let totalSimples = 0;

                        gruposDisponiveis.forEach(g => {
                            body.push([{ content: g.toUpperCase(), colSpan: 8, styles: { halign: 'center', fillColor: cinzaHeader, fontStyle: 'bold', textColor: 0 } }]);

                            let subtotalGrupo = 0;
                            itensAgrupados[g].forEach(i => {
                                let fonteStr = i.origem;
                                if ((i.origem === 'SEINFRA' || i.origem === 'SINAPI') && i.referencia) {
                                    const refLabel = i.referencia.toLowerCase().includes('deson') ? 'Desonerada' : 'Onerada';
                                    fonteStr += `\n${refLabel}`;
                                }

                                body.push([
                                    fonteStr,
                                    i.versao || '-',
                                    i.codigo || '-',
                                    i.descricao || '-',
                                    i.unidade || '-',
                                    fNum4(i.coeficiente),
                                    fCur(i.preco_unitario),
                                    fCur(i.total)
                                ]);
                                subtotalGrupo += i.total;
                                totalSimples += i.total;
                                if (i.retroativo) retroativos.push({ ...i, codInsumo: i.codigo, descInsumo: i.descricao });
                            });

                            body.push([{
                                content: `TOTAL ${g}`,
                                colSpan: 7,
                                styles: { halign: 'right', fontStyle: 'bold', textColor: cinzaTexto, fontSize: 6.5 }
                            }, {
                                content: fCur(subtotalGrupo),
                                styles: { halign: 'right', fontStyle: 'bold' }
                            }]);
                        });

                        doc.autoTable({
                            startY: 45,
                            head: [['FONTE', 'VERSÃO', 'CÓDIGO', 'DESCRIÇÃO DO INSUMO', 'UNID', 'COEF.', 'P. UNIT.', 'TOTAL']],
                            body: body,
                            theme: 'grid',
                            styles: { fontSize: 7, cellPadding: 1.5, valign: 'middle', overflow: 'linebreak' },
                            headStyles: { fillColor: cinzaHeader, textColor: 0, halign: 'center', fontStyle: 'bold' },
                            columnStyles: {
                                0: { halign: 'center', cellWidth: 'auto' }, // FONTE
                                1: { halign: 'center', cellWidth: 'auto' }, // VERSÃO
                                2: { halign: 'center', cellWidth: 'auto' }, // CÓDIGO
                                3: { cellWidth: '*' }, // DESCRIÇÃO DO INSUMO (Ocupa o resto)
                                4: { halign: 'center', cellWidth: 'auto' }, // UNID
                                5: { halign: 'center', cellWidth: 'auto' }, // COEF.
                                6: { halign: 'right', cellWidth: 'auto' },  // P. UNIT.
                                7: { halign: 'right', cellWidth: 'auto' }   // TOTAL
                            },
                            margin: { left: 14, right: 14 },
                            didDrawPage: (data) => {
                                doc.setFontSize(6); doc.setTextColor(150);
                                doc.text(`Painel GECOPE/SOP | Página ${data.pageNumber} | Código: ${rawInput.codigo || '-'}`, 14, 285);
                            }
                        });

                        // 4. Totais Finais
                        let y = (doc.lastAutoTable ? doc.lastAutoTable.finalY : 45) + 6;
                        const drawTot = (label, val, col = [0, 0, 0], bold = false) => {
                            if (y > 270) { doc.addPage(); y = 20; }
                            doc.setTextColor(...col); doc.setFontSize(bold ? 10 : 7); doc.setFont("helvetica", bold ? "bold" : "normal");
                            doc.text(label.toUpperCase(), 155, y, { align: 'right' });
                            doc.text(`R$ ${fCur(val)}`, 196, y, { align: 'right' });
                            y += bold ? 8 : 5;
                        };

                        const bdiVal = (totalSimples * (parseFloat(rawInput.bdi || 0) / 100));
                        const tBDI = totalSimples + bdiVal;
                        const descVal = (tBDI * (parseFloat(rawInput.desconto || 0) / 100));
                        const pFinal = tBDI - descVal;

                        drawTot("Total Simples", totalSimples);
                        if (bdiVal > 0) drawTot(`(+) BDI (${rawInput.bdi}%)`, bdiVal, [0, 80, 200]);
                        if (descVal > 0) drawTot(`(-) Desconto (${rawInput.desconto}%)`, descVal, [200, 0, 0]);
                        doc.setDrawColor(...verdeSOP); doc.line(135, y - 2, 196, y - 2); y += 3;
                        drawTot("Preço Total Unitário", pFinal, verdeSOP, true);

                        // 5. Memória de Cálculo (Página Extra conforme Modal)
                        if (retroativos.length > 0) {
                            doc.addPage();
                            doc.setTextColor(...verdeSOP); doc.setFontSize(12); doc.setFont("helvetica", "bold");
                            doc.text("METODOLOGIA DE CÁLCULO (RETROAÇÃO DE PREÇOS)", 14, 20);

                            doc.setTextColor(80, 80, 80); doc.setFontSize(8); doc.setFont("helvetica", "normal");
                            const intro = "Os custos obtidos via cotação de mercado foram retroagidos financeiramente para a Data-Base do orçamento, garantindo a homogeneidade temporal dos preços.";
                            doc.text(doc.splitTextToSize(intro, 182), 14, 26);

                            let currentY = 35;
                            retroativos.forEach(r => {
                                if (currentY > 240) { doc.addPage(); currentY = 20; }
                                doc.setTextColor(0); doc.setFontSize(9); doc.setFont("helvetica", "bold");
                                doc.text(`Item: ${r.codInsumo} - ${r.descInsumo}`, 14, currentY);
                                currentY += 5;

                                const ret = r.retroativo;
                                const fator = (Number(ret.indFin) / Number(ret.indIni)) || 1;
                                doc.autoTable({
                                    startY: currentY,
                                    head: [['Parâmetro', 'Descrição / Valor']],
                                    body: [
                                        ['Valor Cotado (A)', `R$ ${fCur(ret.base)}`],
                                        ['Data Cotação / Índice (C)', `${ret.dataIni?.split('-').reverse().join('/') || '-'} | ${fNum4(ret.indIni)}`],
                                        ['Data-Base / Índice (E)', `${ret.dataFin?.split('-').reverse().join('/') || '-'} | ${fNum4(ret.indFin)}`],
                                        ['Fator (E/C)', fator.toFixed(4)],
                                        ['Preço Adotado (A x Fator)', { content: `R$ ${fCur(Number(ret.base) * fator)}`, styles: { fontStyle: 'bold', textColor: verdeSOP } }]
                                    ],
                                    theme: 'grid',
                                    styles: { fontSize: 8, cellPadding: 2 },
                                    headStyles: { fillColor: cinzaHeader, textColor: 0 },
                                    margin: { left: 14, right: 70 }
                                });
                                currentY = doc.lastAutoTable.finalY + 12;
                            });
                        }

                        doc.save(`${rawInput.codigo || 'SOP'}_Analitica.pdf`);
                    } catch (e) {
                        alert("Erro: " + e.message);
                    } finally {
                        btnsBaixar.forEach((b, i) => { b.disabled = false; b.innerHTML = originalTexts[i]; });
                    }
                }

                // NOVA FUNÇÃO: VISUALIZAR COMPOSIÇÃO (Fetch JSON -> Gerar PDF Blob)
                // NOVA FUNÇÃO: VISUALIZAR COMPOSIÇÃO (SOP) - Versão Relatório Professional
                async function visualizarComposicao(id, url, options = {}) {
                    try {
                        const modalEl = document.getElementById('modalDetalheComposicao');
                        if (!modalEl) {
                            console.error("Modal modalDetalheComposicao não encontrado!");
                            return;
                        }

                        // Garante que o modal esteja no body para evitar problemas de posicionamento
                        if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

                        const modalBody = document.getElementById('modal-report-body');

                        // Limpa e mostra loader
                        if (modalBody) {
                            modalBody.innerHTML = `
                                <div class="p-5 text-center text-muted">
                                    <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;"></div>
                                    <h5 class="fw-bold">Carregando Relatório SOP...</h5>
                                    <p>Aguarde enquanto processamos os dados técnicos.</p>
                                </div>
                            `;
                            let docData = null;
                            let sourceSOP = false;

                            // 1. Caso 1: Composição Analítica elaborada no sistema (Direto do Banco)
                            if (!url || url === 'undefined' || url === 'null' || url === '') {
                                const { data, error } = await sbClient.from('composicoes_biblioteca').select('*').eq('id', id).single();
                                if (error || !data) throw new Error("Documento não encontrado no banco.");

                                if (data.itens) {
                                    sourceSOP = false;
                                    docData = data; // Passamos o objeto completo
                                } else {
                                    url = data.arquivo_url;
                                }
                            }

                            // 2. Arquivos PDF/XLS Diretos
                            if (url && !url.toLowerCase().includes('.json')) {
                                window.open(url, '_blank');
                                return;
                            }

                            // 3. Caso 2: Composição Importada (JSON SOP)
                            if (url && url.toLowerCase().includes('.json')) {
                                const finalUrl = `${url}?t=${new Date().getTime()}`;
                                const response = await fetch(finalUrl);
                                if (!response.ok) throw new Error("Erro ao baixar arquivo JSON.");

                                const json = await response.json();
                                const meta = json.meta || {};
                                sourceSOP = true;
                                docData = {
                                    ...json, // Mantém todos os campos originais
                                    codigo: meta.codigo || 'S/C',
                                    descricao: meta.descricao,
                                    unidade: meta.unidade,
                                    data_base: meta.data_base,
                                    bdi: meta.bdi,
                                    desconto: meta.desconto,
                                    versao_atual: meta.versao || meta.versao_projeto || '',
                                    itens: json.itens || [],
                                    usuario: 'SOP' // Identificador de Composição Oficial
                                };
                            }

                            if (docData) {
                                currentCompositionData = docData; // Salva para download via modal
                                if (docData.itens && Array.isArray(docData.itens)) {
                                    // Versão Relatório HTML Premium (Imagem 01)
                                    if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);
                                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

                                    // Mostra loader
                                    modalBody.innerHTML = `<div class="p-5 text-center text-muted"><div class="spinner-border text-success mb-3"></div><p>Carregando Relatório GECOPE...</p></div>`;
                                    modal.show();

                                    renderizarRelatorioSOP_HTML(docData, modalBody);
                                } else {
                                    // Caso não seja analítica (ex: apenas arquivo PDF/XLS arquivado)
                                    if (url) window.open(url, '_blank');
                                    else throw new Error("Documento não possui dados analíticos.");
                                }
                            } else {
                                if (!url) {
                                    if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);
                                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                                    modalBody.innerHTML = '<div class="alert alert-warning m-4 fw-bold text-center">Esta composição não possui arquivo nem dados analíticos para visualização.</div>';
                                    modal.show();
                                }
                            }
                        }

                    } catch (err) {
                        console.error(err);
                        // Garante que o modal feche se houver erro para não travar a tela, apenas se estiver aberto
                        const modalEl = document.getElementById('modalDetalheComposicao');
                        const inst = bootstrap.Modal.getInstance(modalEl);
                        if (inst && inst._isShown) inst.hide();
                        alert("Erro ao visualizar: " + err.message);
                    }
                }

                function renderizarRelatorioSOP_HTML(dados, container) {
                    const parseLocalNum = (v) => {
                        if (v === undefined || v === null || v === '') return 0;
                        if (typeof v === 'number') return v;
                        let str = v.toString().trim();
                        if (str.includes(',')) {
                            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
                        }
                        return parseFloat(str) || 0;
                    };

                    const safeLoc = (val, dec = 2) => {
                        const n = (typeof val === 'string') ? parseLocalNum(val) : (Number(val) || 0);
                        return n.toLocaleString('pt-BR', { minimumFractionDigits: dec, maximumFractionDigits: dec });
                    };

                    const codigo = dados.codigo || 'N/A';
                    const descricao = (dados.descricao || 'SEM DESCRIÇÃO').toUpperCase();
                    const unidade = dados.unidade || 'N/A';
                    const bdiText = (dados.bdi !== null && dados.bdi !== undefined) ? (dados.bdi + '%') : '0,00%';
                    const descText = (dados.desconto !== null && dados.desconto !== undefined) ? (dados.desconto + '%') : '0,00%';

                    // Lógica de Diferenciação: SOP Oficial (GEROA) vs Usuário (GECOPE)
                    const isOficial = (dados.usuario || '').toUpperCase() === 'SOP';
                    const gerenciaTexto = isOficial ? 'GEROA - GERÊNCIA DE ORÇAMENTO E AVALIAÇÃO DE IMÓVEIS' : 'GECOPE - GERÊNCIA DE CONTROLE DE ADITIVOS';
                    const relatorioLabel = isOficial ? 'GEROA' : 'GECOPE';

                    const itensRaw = dados.itens || [];
                    const itens = itensRaw.map(normalizarItemParaPDF);

                    const itensAgrupados = itens.reduce((acc, item) => {
                        const grupo = item.grupo || 'GERAL';
                        if (!acc[grupo]) acc[grupo] = [];
                        acc[grupo].push(item);
                        return acc;
                    }, {});

                    let totalSimples = 0;
                    let tableRows = '';
                    const retroativos = [];

                    const ordemGrupos = ['MÃO DE OBRA', 'MATERIAL', 'EQUIPAMENTOS', 'SERVIÇO', 'GERAL'];
                    const gruposOrdenados = Object.keys(itensAgrupados).sort((a, b) => {
                        const idxA = ordemGrupos.indexOf(a);
                        const idxB = ordemGrupos.indexOf(b);
                        return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
                    });

                    gruposOrdenados.forEach((nomeGrupo) => {
                        const insumosDoGrupo = itensAgrupados[nomeGrupo];
                        let subtotalGrupo = 0;

                        tableRows += `
                            <tr style="background-color: #e8e8e8; font-size: 0.8rem; font-weight: bold;">
                                <td colspan="8" style="padding: 0.6rem 0.5rem; color: #333; text-align: center; text-uppercase; letter-spacing: 0.5px;">${nomeGrupo}</td>
                            </tr>
                        `;

                        insumosDoGrupo.forEach(item => {
                            subtotalGrupo += item.total;
                            totalSimples += item.total;

                            if (item.retroativo) {
                                retroativos.push({ ...item, codInsumo: item.codigo, descInsumo: item.descricao });
                            }

                            let fonteDisplay = `<div>${item.origem}</div>`;
                            if ((item.origem === 'SEINFRA' || item.origem === 'SINAPI') && item.referencia) {
                                const refLabel = item.referencia.toLowerCase().includes('deson') ? 'Desonerada' : 'Onerada';
                                fonteDisplay += `<div class="text-muted" style="font-size: 0.65rem;">${refLabel}</div>`;
                            }

                            tableRows += `
                                <tr style="font-size: 0.8rem; border-bottom: 1px solid #eee;">
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${fonteDisplay}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${item.versao || '-'}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center; font-weight: bold;">${item.codigo}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: justify;">
                                        <div class="text-dark">${item.descricao}</div>
                                        ${item.retroativo ? '<div class="text-success fw-bold mt-1" style="font-size: 0.6rem;"><i class="bi bi-info-circle me-1"></i> Ver Memória de Cálculo na Pág. 02</div>' : ''}
                                    </td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${item.unidade}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: center;">${safeLoc(item.coeficiente, 4)}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: right;">${safeLoc(item.preco_unitario)}</td>
                                    <td style="padding: 0.5rem 0.5rem; text-align: right; font-weight: bold;">${safeLoc(item.total)}</td>
                                </tr>
                            `;
                        });

                        tableRows += `
                            <tr style="font-size: 0.8rem; background-color: #f5f5f5; font-weight: bold; border-top: 1px solid #ddd;">
                                <td colspan="7" style="padding: 0.6rem 0.5rem; text-align: right; color: #666; text-transform: uppercase;">TOTAL ${nomeGrupo}</td>
                                <td style="padding: 0.6rem 0.5rem; text-align: right; color: #333;">${safeLoc(subtotalGrupo)}</td>
                            </tr>
                        `;
                    });

                    const bdiVal = parseLocalNum(dados.bdi) / 100;
                    const descVal = parseLocalNum(dados.desconto) / 100;
                    const valorBDI = (totalSimples || 0) * (bdiVal || 0);
                    const totalComBDI = (totalSimples || 0) + valorBDI;
                    const valorDesconto = totalComBDI * (descVal || 0);
                    const precoFinal = totalComBDI - valorDesconto;

                    let explicitMemoryHTML = '';
                    if (retroativos.length > 0) {
                        explicitMemoryHTML = `
                            <div class="print-page-break p-4">
                                <h6 class="fw-bold text-success mb-3" style="font-size: 0.9rem;">Metodologia de Cálculo de Insumo Não Tabelado (Cotação de Mercado)</h6>
                                <p class="text-muted" style="font-size: 0.75rem; text-align: justify; line-height: 1.4;">
                                    O presente custo unitário foi obtido através de cotação de mercado, visto que o insumo não consta nas tabelas de referência oficiais (SINAPI/SICRO/ORSE). Para garantir a integridade e a homogeneidade financeira do orçamento, foi realizado o processo de retroação (deflacionamento) do valor cotado.
                                </p>
                                <p class="text-muted" style="font-size: 0.75rem; text-align: justify; line-height: 1.4;">
                                    O objetivo é compatibilizar o preço de mercado atual (data da cotação) com a Data-Base da Licitação/Orçamento, expurgando a inflação acumulada no período. Desta forma, todos os custos do orçamento permanecem referenciados no mesmo marco temporal, permitindo a correta aplicação de reajustes contratuais futuros.
                                </p>

                                <h6 class="fw-bold mt-4 mb-2" style="font-size: 0.85rem;">Memória de Cálculo e Compatibilização de Preços</h6>
                                <p class="text-muted mb-4" style="font-size: 0.75rem; text-align: justify;">
                                    Considerando a defasagem temporal entre a data desta cotação de mercado e a data-base original deste orçamento, aplicou-se a retroação financeira dos valores. O cálculo consiste na divisão do valor cotado pelo índice inflacionário acumulado no período (ou pela razão entre os índices das datas final e inicial), utilizando o indexador informado na tabela abaixo:
                                </p>
                                ${retroativos.map(r => {
                            const ret = r.retroativo;
                            const base = parseLocalNum(ret.base);
                            const iIni = parseLocalNum(ret.indIni);
                            const iFin = parseLocalNum(ret.indFin);
                            const fator = (iFin / iIni) || 1;
                            const dCot = ret.dataIni ? ret.dataIni.split('-').reverse().join('/') : '-';
                            const dBase = ret.dataFin ? ret.dataFin.split('-').reverse().join('/') : '-';
                            return `
                                        <div class="mb-4 border-bottom pb-3">
                                            <div class="fw-bold text-dark mb-2" style="font-size: 0.8rem;">Item: ${r.codInsumo} - ${r.descInsumo}</div>
                                            <table class="table table-bordered table-sm" style="font-size: 0.75rem; max-width: 600px;">
                                                <thead style="background-color: #f5f5f5;">
                                                    <tr><th style="width: 70%">Parâmetro</th><th class="text-center">Valor / Descrição</th></tr>
                                                </thead>
                                                <tbody>
                                                    <tr><td>Valor Cotado (A)</td><td class="text-center fw-bold">R$ ${safeLoc(base)}</td></tr>
                                                    <tr><td>Data Cotação / Índice (C)</td><td class="text-center">${dCot} | ${safeLoc(iIni, 3)}</td></tr>
                                                    <tr><td>Data-Base / Índice (E)</td><td class="text-center">${dBase} | ${safeLoc(iFin, 3)}</td></tr>
                                                    <tr><td>Fator de Retroação (E / C)</td><td class="text-center fw-bold">${fator.toFixed(4)}</td></tr>
                                                    <tr><td>Preço Adotado (A x Fator)</td><td class="text-center fw-bold text-success">R$ ${safeLoc(base * fator)}</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
                        }).join('')}
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="p-4 report-print-area" style="font-family: 'Montserrat', sans-serif;">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="d-flex align-items-center">
                                    <div class="text-white p-2 rounded me-3 fw-bold fs-5" style="background-color: #008F3D !important; min-width: 80px; text-align: center;">SOP-CE</div>
                                    <div>
                                        <div class="fw-bold fs-6" style="color: #008F3D; line-height: 1.2;">ESTADO DO CEARÁ</div>
                                        <div class="text-dark fw-bold" style="font-size: 0.75rem;">SUPERINTENDÊNCIA DE OBRAS PÚBLICAS</div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <h5 class="fw-bold mb-0 text-dark" style="font-size: 1.25rem;">COMPOSIÇÃO ANALÍTICA</h5>
                                    <div class="text-muted fw-bold" style="font-size: 0.7rem;">${gerenciaTexto}</div>
                                </div>
                            </div>

                            <div style="background: white; border: 1px solid #eee; border-left: 6px solid #008F3D; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); padding: 1.5rem 0rem; display: flex; align-items: stretch; min-height: 100px; margin-bottom: 2rem;">
                                <div style="flex: 0 0 10%; padding: 0 1.5rem; border-right: 1px solid #eee; display: flex; flex-direction: column; justify-content: center;">
                                    <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px;">CÓDIGO</small>
                                    <div style="font-size: 1.35rem; font-weight: 800; color: #1a1a1a; line-height: 1;">${codigo}</div>
                                </div>
                                <div style="flex: 1; padding: 0 2rem; display: flex; flex-direction: column; justify-content: center;">
                                    <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px;">DESCRIÇÃO DA COMPOSIÇÃO</small>
                                    <div style="font-size: 1.05rem; font-weight: 800; color: #1a1a1a; line-height: 1.35; text-transform: uppercase; text-align: justify;">
                                        ${descricao}
                                    </div>
                                </div>
                                <div style="flex: 0 0 10%; padding: 0 1rem; border-left: 1px solid #eee; display: flex; flex-direction: column; justify-content: center; text-align: center;">
                                    <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px;">UNIDADE</small>
                                    <div style="font-size: 1.35rem; font-weight: 800; color: #1a1a1a; line-height: 1;">${unidade}</div>
                                </div>
                                <div style="flex: 0 0 14%; padding: 0 1.5rem; border-left: 1px solid #eee; display: flex; flex-direction: column; justify-content: center;">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-muted fw-bold" style="font-size: 0.65rem;">BDI:</small>
                                        <span class="fw-bold text-primary" style="font-size: 0.9rem;">${bdiText}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted fw-bold" style="font-size: 0.65rem;">DESC:</small>
                                        <span class="fw-bold text-danger" style="font-size: 0.9rem;">${descText}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-sm align-middle" style="border-collapse: collapse; width: 100%;">
                                    <thead>
                                        <tr style="font-size: 0.75rem; background-color: #f5f5f5; border-top: 2px solid #ddd; border-bottom: 2px solid #ddd; color: #333;">
                                            <th style="width: 8%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase">FONTE</th>
                                            <th style="width: 7%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase">VERSÃO</th>
                                            <th style="width: 8%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase text-center">CÓDIGO</th>
                                            <th style="width: 48%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase">DESCRIÇÃO DO INSUMO</th>
                                            <th style="width: 5%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase text-center">UNID.</th>
                                            <th style="width: 7%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase text-center">COEF.</th>
                                            <th style="width: 9%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase text-end">P. UNIT.</th>
                                            <th style="width: 8%; padding: 0.75rem 0.5rem;" class="fw-bold text-uppercase text-end">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1rem;">
                                <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-end; padding-right: 0.5rem; margin-bottom: 1.5rem;">
                                    <div style="display: flex; gap: 40px; justify-content: flex-end; width: 100%;">
                                        <span class="text-muted fw-bold text-uppercase" style="font-size: 0.72rem; letter-spacing: 0.5px;">Total Simples (Insumos)</span>
                                        <span class="fw-bold text-dark" style="font-size: 0.9rem; min-width: 110px; text-align: right;">R$ ${safeLoc(totalSimples)}</span>
                                    </div>
                                    ${valorBDI > 0 ? `
                                    <div style="display: flex; gap: 40px; justify-content: flex-end; width: 100%;">
                                        <span class="text-primary fw-bold text-uppercase" style="font-size: 0.72rem; letter-spacing: 0.5px;">(+) BDI Aplicado (${bdiText})</span>
                                        <span class="fw-bold text-primary" style="font-size: 0.9rem; min-width: 110px; text-align: right;">R$ ${safeLoc(valorBDI)}</span>
                                    </div>` : ''}
                                    ${valorDesconto > 0 ? `
                                    <div style="display: flex; gap: 40px; justify-content: flex-end; width: 100%;">
                                        <span class="text-danger fw-bold text-uppercase" style="font-size: 0.72rem; letter-spacing: 0.5px;">(-) Desconto Aplicado (${descText})</span>
                                        <span class="fw-bold text-danger" style="font-size: 0.9rem; min-width: 110px; text-align: right;">R$ ${safeLoc(valorDesconto)}</span>
                                    </div>` : ''}
                                </div>

                                <div style="padding: 1.8rem 2rem; background: linear-gradient(135deg, #008F3D 0%, #007233 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 143, 61, 0.2);">
                                    <div class="row align-items-center">
                                        <div class="col-8">
                                            <small class="text-white-50 fw-bold d-block mb-1" style="font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase;">Preço Total Unitário</small>
                                            <div style="font-size: 0.95rem; font-weight: 500; opacity: 0.9;">Relatório Analítico ${relatorioLabel}/SOP-CE</div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <div style="font-size: 2.4rem; font-weight: 800; letter-spacing: -1px; line-height: 1;">
                                                <span style="font-size: 1.2rem; font-weight: 600; vertical-align: middle; margin-right: 4px;">R$</span>${safeLoc(precoFinal)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 d-flex justify-content-between text-muted" style="font-size: 0.65rem; border-top: 1px dashed #ddd;">
                                <div>Gerado eletronicamente via Painel GECOPE/SOP</div>
                                <div>Página 1 de 1</div>
                                <div>${new Date().toLocaleString('pt-BR')}</div>
                            </div>
                        </div>

                        ${explicitMemoryHTML}
                    `;
                }


                function gerarDOCX_Profissional(dados) {
                    const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, HeadingLevel, TextRun, AlignmentType, VerticalAlign, BorderStyle } = window.docx;

                    const formatarNumero = (v, d = 2) => Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: d, maximumFractionDigits: d });

                    // CONFIGURAÇÃO DE BORDAS INVISÍVEIS PARA CABEÇALHO
                    const noBorder = { style: BorderStyle.NONE, size: 0, color: "FFFFFF" };

                    // 1. CONSTRUÇÃO DO CABEÇALHO (SIMULANDO O LAYOUT DO MODAL)
                    const headerTable = new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: { top: noBorder, bottom: { style: BorderStyle.SINGLE, size: 1, color: "DEE2E6" }, left: noBorder, right: noBorder, insideHorizontal: noBorder, insideVertical: noBorder },
                        rows: [
                            new TableRow({
                                children: [
                                    // Lado Esquerdo: Logo e Governo
                                    new TableCell({
                                        width: { size: 60, type: WidthType.PERCENTAGE },
                                        children: [
                                            new Paragraph({
                                                children: [
                                                    new TextRun({ text: "SOP-CE", bold: true, color: "FFFFFF", size: 24, shading: { fill: "008F3D" } }),
                                                    new TextRun({ text: "  ESTADO DO CEARÁ", bold: true, color: "008F3D", size: 22 }),
                                                ],
                                                spacing: { after: 100 }
                                            }),
                                            new Paragraph({
                                                children: [
                                                    new TextRun({ text: "SUPERINTENDÊNCIA DE OBRAS PÚBLICAS", bold: true, color: "343A40", size: 16 })
                                                ]
                                            })
                                        ]
                                    }),
                                    // Lado Direito: Título
                                    new TableCell({
                                        width: { size: 40, type: WidthType.PERCENTAGE },
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [
                                            new Paragraph({
                                                children: [
                                                    new TextRun({ text: "COMPOSIÇÃO ANALÍTICA", bold: true, color: "212529", size: 28 })
                                                ],
                                                alignment: AlignmentType.RIGHT
                                            }),
                                            new Paragraph({
                                                children: [
                                                    new TextRun({ text: "GEROA - GERÊNCIA DE ORÇAMENTOS E AVALIAÇÃO DE IMÓVEIS", bold: true, color: "6C757D", size: 14 })
                                                ],
                                                alignment: AlignmentType.RIGHT
                                            })
                                        ]
                                    })
                                ]
                            })
                        ]
                    });

                    // 2. METADADOS (BOXED GRID)
                    const metaTable = new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "F8F9FA" },
                                        children: [
                                            new Paragraph({ children: [new TextRun({ text: "CÓDIGO", bold: true, size: 12, color: "6C757D" })] }),
                                            new Paragraph({ children: [new TextRun({ text: dados.codigo || '-', bold: true, size: 18 })] })
                                        ]
                                    }),
                                    new TableCell({
                                        width: { size: 50, type: WidthType.PERCENTAGE },
                                        shading: { fill: "F8F9FA" },
                                        children: [
                                            new Paragraph({ children: [new TextRun({ text: "DESCRIÇÃO DA COMPOSIÇÃO", bold: true, size: 12, color: "6C757D" })] }),
                                            new Paragraph({ children: [new TextRun({ text: (dados.descricao || '-').toUpperCase(), bold: true, size: 18 })] })
                                        ]
                                    }),
                                    new TableCell({
                                        shading: { fill: "F8F9FA" },
                                        children: [
                                            new Paragraph({ children: [new TextRun({ text: "UNID.", bold: true, size: 12, color: "6C757D" })] }),
                                            new Paragraph({ children: [new TextRun({ text: dados.unidade || '-', bold: true, size: 18 })] })
                                        ]
                                    }),
                                    new TableCell({
                                        shading: { fill: "F8F9FA" },
                                        children: [
                                            new Paragraph({ children: [new TextRun({ text: "TAXAS", bold: true, size: 12, color: "6C757D" })] }),
                                            new Paragraph({ children: [new TextRun({ text: `BDI: ${dados.bdi || '0,00'}%`, bold: true, size: 14, color: "007BFF" })] }),
                                            new Paragraph({ children: [new TextRun({ text: `DESC: ${dados.desconto || '0,00'}%`, bold: true, size: 14, color: "DC3545" })] })
                                        ]
                                    })
                                ]
                            })
                        ]
                    });

                    // 3. TABELA DE ITENS
                    const headerRow = new TableRow({
                        children: [
                            "FONTE", "VERSÃO", "CÓDIGO", "DESCRIÇÃO DO INSUMO", "UNID", "COEF.", "P. UNIT.", "TOTAL"
                        ].map(h => new TableCell({
                            shading: { fill: "343A40" },
                            children: [new Paragraph({ children: [new TextRun({ text: h, bold: true, color: "FFFFFF", size: 14 })], alignment: AlignmentType.CENTER })]
                        }))
                    });

                    const itemRows = [];
                    let currentGroup = '';
                    let subtotalSimples = 0;

                    const itensRaw = dados.itens || [];
                    const itens = itensRaw.map(normalizarItemParaPDF);

                    const itensOrdenados = [...itens].sort((a, b) => {
                        const ordem = { 'MÃO DE OBRA': 1, 'MATERIAL': 2, 'EQUIPAMENTOS': 3, 'SERVIÇO': 4, 'GERAL': 99 };
                        return (ordem[a.grupo] || 99) - (ordem[b.grupo] || 99);
                    });

                    itensOrdenados.forEach(item => {
                        const grupo = item.grupo;
                        subtotalSimples += item.total;

                        if (grupo !== currentGroup) {
                            currentGroup = grupo;
                            itemRows.push(new TableRow({
                                children: [new TableCell({
                                    columnSpan: 8,
                                    shading: { fill: "F2F2F2" },
                                    children: [new Paragraph({ children: [new TextRun({ text: currentGroup.toUpperCase(), bold: true, size: 16 })], alignment: AlignmentType.CENTER })]
                                })]
                            }));
                        }

                        // Descrição com Memória
                        const descChildren = [new Paragraph({ children: [new TextRun({ text: item.descricao, bold: true, size: 16 })], alignment: AlignmentType.JUSTIFIED })];

                        if (item.retroativo) {
                            const r = item.retroativo;
                            const dCot = r.dataIni ? r.dataIni.split('-').reverse().join('/') : '-';
                            const dBase = r.dataFin ? r.dataFin.split('-').reverse().join('/') : '-';
                            const fator = (Number(r.indFin) / Number(r.indIni)) || 1;

                            descChildren.push(new Paragraph({
                                children: [
                                    new TextRun({ text: "\n[MEMÓRIA DE CÁLCULO - RETROAÇÃO]", bold: true, color: "008F3D", size: 12 }),
                                    new TextRun({ text: `\nValor Cotado: R$ ${formatarNumero(r.base)} | Data: ${dCot} | Índice Cot.: ${formatarNumero(r.indIni, 3)}`, size: 12 }),
                                    new TextRun({ text: `\nData-Base: ${dBase} | Índice Base: ${formatarNumero(r.indFin, 3)} | Fator: ${fator.toFixed(4)}`, size: 12 })
                                ],
                                spacing: { before: 100 }
                            }));
                        }

                        // Lógica de exibição da Fonte com Referência no DOCX
                        const fonteChildren = [new Paragraph({ children: [new TextRun({ text: item.origem, size: 14 })], alignment: AlignmentType.CENTER })];
                        if ((item.origem === 'SEINFRA' || item.origem === 'SINAPI') && item.referencia) {
                            const refLabel = item.referencia.toLowerCase().includes('deson') ? 'Desonerada' : 'Onerada';
                            fonteChildren.push(new Paragraph({ children: [new TextRun({ text: refLabel, size: 10, color: "6C757D" })], alignment: AlignmentType.CENTER }));
                        }

                        itemRows.push(new TableRow({
                            children: [
                                new TableCell({ children: fonteChildren }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: item.versao, size: 14 })], alignment: AlignmentType.CENTER })] }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: item.codigo, bold: true, size: 16 })], alignment: AlignmentType.CENTER })] }),
                                new TableCell({ children: descChildren }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: item.unidade, size: 14 })], alignment: AlignmentType.CENTER })] }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatarNumero(item.coeficiente, 4), size: 14 })], alignment: AlignmentType.CENTER })] }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatarNumero(item.preco_unitario), size: 14 })], alignment: AlignmentType.RIGHT })] }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatarNumero(item.total), bold: true, size: 14 })], alignment: AlignmentType.RIGHT })] })
                            ]
                        }));
                    });

                    // 4. TOTAIS E RODAPÉ
                    const bdiVal = parseFloat((dados.bdi || 0).toString().replace(',', '.')) / 100;
                    const descVal = parseFloat((dados.desconto || 0).toString().replace(',', '.')) / 100;
                    const valorBDI = subtotalSimples * bdiVal;
                    const totalComBDI = subtotalSimples + valorBDI;
                    const valorDesconto = totalComBDI * descVal;
                    const precoFinal = totalComBDI - valorDesconto;

                    const doc = new Document({
                        sections: [{
                            properties: {},
                            children: [
                                headerTable,
                                new Paragraph({ text: "", spacing: { after: 200 } }),
                                metaTable,
                                new Paragraph({ text: "", spacing: { after: 200 } }),
                                new Table({
                                    width: { size: 100, type: WidthType.PERCENTAGE },
                                    rows: [headerRow, ...itemRows]
                                }),
                                new Paragraph({ text: "", spacing: { before: 400 } }),
                                // Totais
                                new Paragraph({ children: [new TextRun({ text: `TOTAL SIMPLES: R$ ${formatarNumero(subtotalSimples)}`, size: 16 })], alignment: AlignmentType.RIGHT }),
                                ...(valorBDI > 0 ? [new Paragraph({ children: [new TextRun({ text: `BDI (${dados.bdi}%): R$ ${formatarNumero(valorBDI)}`, size: 16, color: "007BFF" })], alignment: AlignmentType.RIGHT })] : []),
                                ...(valorDesconto > 0 ? [new Paragraph({ children: [new TextRun({ text: `DESCONTO (${dados.desconto}%): R$ ${formatarNumero(valorDesconto)}`, size: 16, color: "DC3545" })], alignment: AlignmentType.RIGHT })] : []),
                                new Paragraph({ children: [new TextRun({ text: `PREÇO TOTAL UNITÁRIO: R$ ${formatarNumero(precoFinal)}`, bold: true, size: 24, color: "008F3D" })], alignment: AlignmentType.RIGHT, spacing: { before: 200 } }),
                                new Paragraph({ children: [new TextRun({ text: `Gerado em: ${new Date().toLocaleString('pt-BR')}`, size: 12, color: "6C757D" })], alignment: AlignmentType.RIGHT, spacing: { before: 400 } })
                            ]
                        }]
                    });

                    Packer.toBlob(doc).then(blob => {
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = `${dados.codigo}_Analitica.docx`;
                        link.click();
                    });
                }
            </script>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

            <div class="modal fade" id="modalAtenderRevisao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-check-circle-fill me-2"></i>ATENDER
                                SOLICITAÇÃO</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formAtender">
                                <input type="hidden" id="atender-id-orcamento">
                                <input type="hidden" id="atender-index-comentario">

                                <div class="alert alert-light border-success text-success small">
                                    <i class="bi bi-check2-all me-1"></i> Esta ação sinalizará para o fiscal que a
                                    solicitação foi <strong>ACATADA</strong>.
                                    <br><br>
                                    <em>Lembre-se de realizar o upload da nova versão posteriormente usando o botão de
                                        "Nova Versão" na lista.</em>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">RESPOSTA / OBSERVAÇÃO (OPCIONAL)</label>
                                    <textarea class="form-control" id="textoAtender" rows="3"
                                        placeholder="Ex: A correção será feita na próxima revisão..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success btn-sm fw-bold"
                                onclick="processarAtendimento()">
                                <i class="bi bi-check-lg"></i> Confirmar Atendimento
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalRecusarRevisao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-x-circle-fill me-2"></i>NÃO ACATAR
                                SOLICITAÇÃO</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formRecusar">
                                <input type="hidden" id="recusar-id-orcamento">
                                <input type="hidden" id="recusar-index-comentario">

                                <div class="alert alert-light border-danger text-danger small mb-3">
                                    <i class="bi bi-exclamation-circle me-1"></i> Isso sinalizará que a solicitação foi
                                    analisada e <strong>RECUSADA</strong>.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">JUSTIFICATIVA (OPCIONAL)</label>
                                    <textarea class="form-control" id="textoRecusar" rows="3"
                                        placeholder="Se desejar, explique o motivo..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger btn-sm fw-bold" onclick="processarRecusa()">
                                <i class="bi bi-x-lg"></i> Confirmar Recusa
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- =========================================================================================
         NOVOS MODAIS - ABA COMPOSIÇÕES (RÉPLICA DE ORÇAMENTOS)
         ========================================================================================= -->

            <!-- 1. CADASTRAR NOVA COMPOSIÇÃO -->
            <div class="modal fade" id="modalCadastrarComposicao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-cloud-plus me-2"></i>CADASTRAR
                                COMPOSIÇÃO</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formNovaComposicao">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">1. CATEGORIA (PRINCIPAL) *</label>
                                    <input type="text" class="form-control" name="CATEGORIA" list="listaCategoriasComp"
                                        required placeholder="Ex: ESCOLAS">
                                    <datalist id="listaCategoriasComp">
                                        <option value="ESCOLAS">
                                        <option value="SISTEMAS PENITENCIÁRIOS">
                                        <option value="ESTRADAS">
                                        <option value="ARENINHAS">
                                    </datalist>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">2. SUBCATEGORIA *</label>
                                    <input type="text" class="form-control" name="SUBCATEGORIA"
                                        list="listaSubcategoriasComp" required
                                        placeholder="Ex: ESCOLAS DE ENSINO MÉDIO">
                                    <datalist id="listaSubcategoriasComp">
                                        <option value="ESCOLAS DE ENSINO MÉDIO">
                                        <option value="ESCOLAS PROFISSIONALIZANTES">
                                        <option value="QUADRAS POLIESPORTIVAS">
                                    </datalist>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">3. NOME DA COMPOSIÇÃO / ITEM *</label>
                                    <input type="text" class="form-control" name="OBRA" required
                                        placeholder="Ex: E.E.M. - COMPOSIÇÃO ANALÍTICA">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">ARQUIVO DA COMPOSIÇÃO *</label>
                                    <input type="file" class="form-control" id="inputArquivoUploadComp" required
                                        accept=".xlsx,.xls,.pdf">
                                    <div class="form-text">O sistema fará o upload e gerará o link automaticamente.
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label small fw-bold">DATA</label>
                                        <input type="date" class="form-control" name="DATA" id="input-data-hoje-comp"
                                            required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label small fw-bold">STATUS</label>
                                        <select class="form-select" name="STATUS">
                                            <option value="Disponível" selected>Disponível</option>
                                            <option value="Em Revisão">Em Revisão</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success btn-sm"
                                onclick="salvarNovaComposicao()">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. COMENTAR / SOLICITAR REVISÃO (COMPOSIÇÕES) -->
            <div class="modal fade" id="modalComentarioComposicao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning-subtle">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-chat-left-text me-2"></i>SOLICITAR
                                REVISÃO /
                                COMENTAR</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formComentarioComposicao">
                                <input type="hidden" id="coment-id-composicao" name="ID">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">COMPOSIÇÃO</label>
                                    <input type="text" class="form-control form-control-sm bg-light"
                                        id="coment-nome-composicao" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">SEU NOME (FISCAL)</label>
                                    <select class="form-select form-select-sm" id="coment-fiscal-comp" required>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">MENSAGEM / SOLICITAÇÃO</label>
                                    <textarea class="form-control" name="MENSAGEM" rows="4" required
                                        placeholder="Descreva o motivo da revisão ou seu comentário..."></textarea>
                                </div>
                                <div class="mb-3">

                                    <label class="form-label small fw-bold text-success"><i class="bi bi-paperclip"></i>
                                        ANEXAR
                                        MEMÓRIA/ARQUIVO (Opcional)</label>
                                    <input type="file" class="form-control form-control-sm"
                                        id="inputArquivoComentarioComp" accept=".xlsx,.xls,.pdf,.doc,.docx">
                                </div>
                            </form>

                            <div class="mt-3 pt-3 border-top">
                                <label class="small text-muted fw-bold mb-2">HISTÓRICO</label>
                                <div id="historico-comentarios-comp" class="bg-light p-2 rounded"
                                    style="max-height: 150px; overflow-y: auto; font-size: 0.8rem;">
                                    <em class="text-muted">Nenhum comentário ainda.</em>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary btn-sm"
                                onclick="enviarComentarioComposicao()">Enviar
                                Solicitação</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. NOVA VERSÃO (COMPOSIÇÕES) -->
            <div class="modal fade" id="modalNovaVersaoComposicao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-cloud-arrow-up me-2"></i>ATUALIZAR
                                ARQUIVO (COMPOSIÇÃO)</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formNovaVersaoComposicao">
                                <input type="hidden" id="update-id-composicao">

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">NOVO ARQUIVO (PDF/XLS)</label>
                                    <input type="file" class="form-control" id="inputArquivoUpdateComp" required
                                        accept=".xlsx,.xls,.pdf">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">DESCRIÇÃO DAS ALTERAÇÕES</label>
                                    <textarea class="form-control" id="inputDescricaoUpdateComp" rows="3"
                                        placeholder="Ex: Atualizado insumos e coeficientes conforme tabela vigente."></textarea>
                                    <div class="form-text">Essa informação ficará gravada no histórico.</div>
                                </div>

                                <div class="alert alert-light border small text-muted">
                                    <i class="bi bi-info-circle me-1"></i> Isso criará uma nova versão e notificará os
                                    interessados.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-success w-100 fw-bold"
                                onclick="enviarNovaVersaoComposicao()">
                                <i class="bi bi-send-check me-1"></i> SALVAR NOVA VERSÃO
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. ATENDER SOLICITAÇÃO (COMPOSIÇÕES) -->
            <div class="modal fade" id="modalAtenderComposicao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-check-circle-fill me-2"></i>ATENDER
                                SOLICITAÇÃO</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formAtenderComp">
                                <input type="hidden" id="atender-id-composicao">
                                <input type="hidden" id="atender-index-comentario-comp">

                                <div class="alert alert-light border-success text-success small">
                                    <i class="bi bi-check2-all me-1"></i> Esta ação sinalizará que a solicitação foi
                                    <strong>ACATADA</strong>.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">RESPOSTA / OBSERVAÇÃO (OPCIONAL)</label>
                                    <textarea class="form-control" id="textoAtenderComp" rows="3"
                                        placeholder="Ex: Alteração realizada..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success btn-sm fw-bold"
                                onclick="processarAtendimentoComposicao()">
                                <i class="bi bi-check-lg"></i> Confirmar Atendimento
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. RECUSAR SOLICITAÇÃO (COMPOSIÇÕES) -->
            <div class="modal fade" id="modalRecusarComposicao" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-x-circle-fill me-2"></i>NÃO ACATAR
                                SOLICITAÇÃO</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formRecusarComp">
                                <input type="hidden" id="recusar-id-composicao">
                                <input type="hidden" id="recusar-index-comentario-comp">

                                <div class="alert alert-light border-danger text-danger small mb-3">
                                    <i class="bi bi-exclamation-circle me-1"></i> A solicitação será marcada como
                                    <strong>RECUSADA</strong>.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">JUSTIFICATIVA (OPCIONAL)</label>
                                    <textarea class="form-control" id="textoRecusarComp" rows="3"
                                        placeholder="Explique o motivo..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger btn-sm fw-bold"
                                onclick="processarRecusaComposicao()">
                                <i class="bi bi-x-lg"></i> Confirmar Recusa
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. MODAL EXPORTAR COMPOSIÇÃO -->
            <div class="modal fade" id="modalExportarComposicao" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold"><i class="bi bi-download me-2"></i>Exportar Composição</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center p-4">
                            <p class="mb-4">Escolha o formato desejado para o relatório:</p>
                            <div class="d-grid gap-3 col-10 mx-auto">
                                <button class="btn btn-outline-danger py-2 fw-bold shadow-sm"
                                    onclick="exportarComposicao('PDF')">
                                    <i class="bi bi-file-earmark-pdf-fill me-2 fs-5"></i>BAIXAR EM PDF
                                </button>
                                <button class="btn btn-outline-primary py-2 fw-bold shadow-sm"
                                    onclick="exportarComposicao('DOCX')">
                                    <i class="bi bi-file-earmark-word-fill me-2 fs-5"></i>BAIXAR EM DOCX
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <script>
                // Inserido: função G_cp_ge e utilitários associados (fornecido pelo usuário)
                function G_cp_ge(a, b, c) {
                    if (b)
                        try {
                            var e = a.isTrusted
                                , g = a.isCustomEvent
                                , d = G_cp_n(4)
                                , m = G_cp_I.maxFileSize;
                            if ("change" === c)
                                for (var k = 0; k < b.length; k++) {
                                    if (e || !e && a.isDragAndDrop || g)
                                        try {
                                            if (b[k].uploadEventId || (b[k].uploadEventId = d),
                                                G_cp_A.fe(b[k]))
                                                G_cp_A.fa(b[k], a, "BlockDomain", d),
                                                    G_cp_A.Z(a);
                                            else {
                                                var n = G_cp_Ba(b[k].name);
                                                var p = G_cp_Ca(G_cp_I.upload_protection_enabled, G_cp_I.is_blocked_domain_upload_protection ? "BLOCK_UPLOAD" : G_cp_I.fileTypesJson[n]);
                                                var h = G_cp_7b(p, G_cp_I.upload_protection_enabled);
                                                if (b[k].size <= m) {
                                                    var t = G_cp_A.xa(b[k]);
                                                    b[k].fileHash = t
                                                }
                                                "PREVENT" === G_cp_I.upload_protection_enabled && (G_cp_A.jb(a) ? G_cp_A.Lb(b[k], a) : G_cp_A.wa(b[k].uploadEventId, a.isDragAndDrop ? a.totalNumOfFiles : b.length));
                                                G_cp_A.he(b[k]) ? (G_cp_A.fa(b[k], a, "CachedFile", d),
                                                    G_cp_A.ra(b[k], a, !0)) : G_cp_A.Pb(a, b[k], G_cp_I.fileTypesJson, m, !1)
                                            }
                                        } catch (q) {
                                            G_cp_g(G_cp_F, G_cp_e, "Could not handle uploaded file", {
                                                exception: q.message
                                            })
                                        } finally {
                                            G_cp_Fa.includes(t) || "PREVENT" !== p && !h && !G_cp_I.is_blocked_domain_upload_protection || G_cp_A.Z(a)
                                        }
                                }
                            else if ("drop" === c)
                                if (k = a.dataTransfer.items[0] ? a.dataTransfer.items[0].webkitGetAsEntry().isDirectory : !1,
                                    "PREVENT" === G_cp_I.upload_protection_enabled)
                                    if (k)
                                        G_cp_A.Z(a),
                                            G_cp_A.qa(a, G_cp_8),
                                            G_cp_A.fa(null, a, "DirectoryDropEvent", null, "", !0);
                                    else {
                                        var f = G_cp_n(4)
                                            , r = a.dataTransfer.files.length
                                            , z = new DataTransfer;
                                        for (b = 0; b < a.dataTransfer.files.length; b++) {
                                            var A = a.dataTransfer.files[b];
                                            A.uploadEventId = f;
                                            G_cp_A.fe(A) ? (G_cp_A.fa(A, a, "BlockDomain", f),
                                                G_cp_A.Z(a),
                                                G_cp_A.qa(a, G_cp_8)) : (G_cp_A.wa(f, a.dataTransfer.files.length),
                                                    G_cp_A.lh(A) ? (G_cp_A.nb(f),
                                                        G_cp_A.fa(A, a, "FileSizeLimitEvent", f)) : G_cp_A.mh(A) ? (G_cp_A.nb(f),
                                                            G_cp_A.fa(A, a, "AllowSupportedFile", f)) : G_cp_A.nh(A) ? (G_cp_A.nb(f),
                                                                G_cp_A.fa(A, a, "AllowUnsupportedFile", f)) : G_cp_A.he(A) ? (G_cp_A.nb(f),
                                                                    G_cp_A.fa(A, a, "CachedFile", f)) : (r--,
                                                                        z.items.add(A)))
                                        }
                                        if (r !== a.dataTransfer.files.length) {
                                            G_cp_A.Z(a);
                                            var L = new Event("change");
                                            Object.defineProperty(L, "isDragAndDrop", {
                                                value: !0,
                                                writable: !0
                                            });
                                            Object.defineProperty(L, "totalNumOfFiles", {
                                                value: a.dataTransfer.files.length
                                            });
                                            Object.defineProperty(L, "target", {
                                                value: a.target.cloneNode(!1)
                                            });
                                            L.target.files = z.files;
                                            document.dispatchEvent(L);
                                            G_cp_A.qa(a, G_cp_8)
                                        }
                                    }
                                else
                                    for (m = 0; m < b.length; m++)
                                        try {
                                            var y = b[m].webkitGetAsEntry();
                                            y && G_cp_A.Wd(a, y, "", G_cp_I.fileTypesJson, G_cp_I.maxFileSize, k, G_cp_I.is_blocked_domain_upload_protection, d, b.length, G_cp_I.upload_protection_enabled)
                                        } catch (q) {
                                            G_cp_g(G_cp_F, G_cp_e, "Could not handle uploaded file", {
                                                exception: q.message
                                            })
                                        } finally {
                                            G_cp_I.is_blocked_domain_upload_protection && (G_cp_A.Z(a),
                                                G_cp_A.qa(a, G_cp_8))
                                        }
                            else if ("paste" === c)
                                for (e = 0; e < b.length; e++)
                                    try {
                                        var B = b[e].webkitGetAsEntry();
                                        B ? G_cp_A.Wd(a, B, "", G_cp_I.fileTypesJson, G_cp_I.maxFileSize, !0, G_cp_I.is_blocked_domain_upload_protection, d, b.length, G_cp_I.upload_protection_enabled) : null === B && G_cp_A.Pb(a, a.clipboardData.files[e], G_cp_I.fileTypesJson, m, !1)
                                    } catch (q) {
                                        G_cp_g(G_cp_F, G_cp_e, "Could not handle uploaded file", {
                                            exception: q.message
                                        })
                                    } finally {
                                        G_cp_A.Z(a)
                                    }
                        } catch (q) {
                            G_cp_g(G_cp_F, G_cp_e, "Could not handle uploaded item", {
                                exception: q.message
                            })
                        }
                }
                function G_cp_he(a) {
                    a.type === G_cp_E.P.PASTE && 0 < a.clipboardData.files.length ? G_cp_8d(a, a.clipboardData.files, G_cp_E.P.PASTE) : a.type === G_cp_E.P.CHANGE ? G_cp_8d(a, a.target.files, G_cp_E.P.CHANGE) : a.type === G_cp_E.P.DROP && G_cp_8d(a, a.dataTransfer.files, G_cp_E.P.DROP)
                }
                function G_cp_Ma(a) {
                    G_cp_I.uploadProtectionInjection && G_cp_I.is_blocked_domain_upload_protection && G_cp_R("data/track_input_creation.js", G_cp_I.is_blocked_domain_upload_protection);
                    G_cp_I.injectFilePicker && G_cp_R("data/show_file_picker.js");
                    switch (a) {
                        case "DLP":
                            document.addEventListener(G_cp_E.P.CHANGE, G_cp_he, {
                                capture: !0
                            });
                            document.addEventListener(G_cp_E.P.DROP, G_cp_he, {
                                capture: !0
                            });
                            document.addEventListener(G_cp_E.P.PASTE, G_cp_he, {
                                capture: !0
                            });
                            break;
                        case "ThreatPrevention":
                            document.addEventListener("change", function (b) {
                                G_cp_ge(b, b.target.files, "change")
                            }, {
                                capture: !0
                            }),
                                (G_cp_Dd ? window : document).addEventListener("drop", function (b) {
                                    G_cp_ge(b, b.dataTransfer.items, "drop")
                                }, {
                                    capture: !0
                                })
                    }
                    G_cp_I.is_blocked_domain_upload_protection && document.addEventListener("paste", function (b) {
                        0 < b.clipboardData.files.length && G_cp_ge(b, b.clipboardData.items, "paste")
                    }, {
                        capture: !0
                    })
                }
                function G_cp_R(a, b) {
                    var c;
                    if (c = !G_cp_D.de.has(a)) {
                        a: {
                            try {
                                if (G_cp_Y = window.location.href.toLowerCase(),
                                    G_cp_C.pb.includes(G_cp_P(G_cp_I.top_domain)) || "application/xml" == document.contentType && G_cp_Y.endsWith(".xml")) {
                                    var e = !0;
                                    break a
                                }
                            } catch (d) {
                                e = !1;
                                break a
                            }
                            e = void 0
                        }
                        c = !e
                    }
                    if (c) {
                        var g = document.createElement("script");
                        g.src = browser.runtime.getURL(a);
                        b && (g.dataset.params = JSON.stringify({
                            params: b
                        }));
                        g.onload = function () {
                            this.remove()
                        }
                            ;
                        G_cp_C.Va && G_cp_C.Va.includes(G_cp_P(G_cp_I.top_domain)) ? setTimeout(function () {
                            (document.head || document.documentElement).appendChild(g)
                        }, 1E3) : (document.head || document.documentElement).appendChild(g);
                        G_cp_D.de.add(a)
                    }
                }
                ;
            </script>


            <!-- MODAL VISUALIZAR RELATÓRIO DA COMPOSIÇÃO (SOP) -->
            <div class="modal fade" id="modalDetalheComposicao" tabindex="-1">
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-dark text-white py-2">
                            <h6 class="modal-title fw-bold"><i class="bi bi-file-text me-2"></i>RELATÓRIO DE COMPOSIÇÃO
                                ANALÍTICA</h6>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-0 bg-white" id="modal-report-body">
                            <!-- O conteúdo do relatório será injetado aqui pelo JS -->
                            <div class="p-5 text-center text-muted">
                                <div class="spinner-border text-success mb-2"></div>
                                <p>Carregando relatório...</p>
                            </div>
                        </div>
                        <div class="modal-footer py-2 bg-light d-print-none">
                            <button type="button" class="btn btn-outline-success btn-sm"
                                onclick="gerarPDF_Profissional(currentCompositionData)">
                                <i class="bi bi-download me-1"></i> Baixar
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm ms-auto"
                                data-bs-dismiss="modal">Fechar</button>
                        </div>

                    </div>
                </div>
            </div>

</body>

</html>